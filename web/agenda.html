<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="icon" type="image/png" href="favicon.png">
  <title>Agenda - Cold Outreach CRM</title>
  <link rel="stylesheet" href="assets/css/global.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    .agenda-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .agenda-nav {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .agenda-nav-label {
      font-size: 16px;
      font-weight: 700;
      min-width: 220px;
      text-align: center;
    }
    .agenda-views {
      display: flex;
      gap: 4px;
    }
    .agenda-views .btn { padding: 6px 14px; font-size: 12px; }
    .agenda-views .btn.active { background: var(--accent-brand-dim); color: var(--accent-brand); border-color: rgba(59,130,246,0.3); }

    /* Reminder banner */
    .reminder-banner {
      background: var(--bg-card);
      border: 1px solid var(--accent-orange-dim);
      border-left: 4px solid var(--accent-orange);
      border-radius: var(--radius);
      padding: 16px 20px;
      margin-bottom: 20px;
      animation: fadeIn 400ms ease forwards;
    }
    .reminder-banner-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent-orange);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .reminder-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: var(--bg-input);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      gap: 12px;
    }
    .reminder-item:last-child { margin-bottom: 0; }
    .reminder-info { flex: 1; }
    .reminder-company { font-weight: 600; font-size: 13px; }
    .reminder-time { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .reminder-phone { font-size: 12px; color: var(--accent-brand); font-weight: 600; }
    .reminder-actions { display: flex; gap: 6px; flex-shrink: 0; }

    /* Week grid */
    .week-grid {
      display: grid;
      grid-template-columns: 60px repeat(7, 1fr);
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    .week-header {
      display: contents;
    }
    .week-header-cell {
      padding: 14px 8px;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border-color);
      background: rgba(0,0,0,0.15);
    }
    .week-header-cell.today {
      color: var(--accent-brand);
      background: var(--accent-brand-dim);
    }
    .week-header-day {
      font-size: 20px;
      font-weight: 800;
      color: var(--text-primary);
      display: block;
      margin-top: 2px;
    }
    .week-header-cell.today .week-header-day {
      color: var(--accent-brand);
    }
    .week-time-col {
      border-bottom: 1px solid rgba(255,255,255,0.05);
      padding: 0 8px;
      font-size: 11px;
      color: var(--text-muted);
      text-align: right;
      height: 60px;
      display: flex;
      align-items: flex-start;
      justify-content: flex-end;
      padding-top: 2px;
    }
    .week-cell {
      border-bottom: 1px solid rgba(255,255,255,0.05);
      border-left: 1px solid rgba(255,255,255,0.05);
      height: 60px;
      position: relative;
      transition: background var(--transition);
    }
    .week-cell:hover {
      background: rgba(59,130,246,0.04);
    }
    .week-cell.today {
      background: rgba(59,130,246,0.03);
    }

    /* Events */
    .cal-event {
      position: absolute;
      left: 2px;
      right: 2px;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 600;
      overflow: hidden;
      cursor: pointer;
      z-index: 2;
      transition: all var(--transition);
      line-height: 1.3;
    }
    .cal-event:hover {
      transform: scale(1.02);
      box-shadow: var(--shadow);
      z-index: 10;
    }
    .cal-event.crm {
      background: var(--accent-brand-dim);
      border-left: 3px solid var(--accent-brand);
      color: var(--accent-brand);
    }
    .cal-event.google {
      background: var(--accent-purple-dim);
      border-left: 3px solid var(--accent-purple);
      color: var(--accent-purple);
    }
    .cal-event-time {
      font-size: 10px;
      opacity: 0.7;
      font-weight: 500;
    }
    .cal-event-title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Event detail popover */
    .event-popover {
      position: fixed;
      z-index: 1100;
      background: rgba(20, 20, 20, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius);
      padding: 20px;
      width: 320px;
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      display: none;
    }
    .event-popover.active { display: block; }
    .event-popover-title { font-size: 15px; font-weight: 700; margin-bottom: 12px; }
    .event-popover-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .event-popover-row i { width: 16px; height: 16px; flex-shrink: 0; margin-top: 2px; color: var(--text-muted); }

    /* Day view */
    .day-list { display: none; }
    .day-list.active { display: block; }
    .day-event {
      display: flex;
      gap: 16px;
      padding: 16px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      margin-bottom: 12px;
      transition: all var(--transition);
    }
    .day-event:hover {
      border-color: var(--border-color-hover);
      box-shadow: var(--shadow);
    }
    .day-event-time {
      min-width: 80px;
      font-size: 13px;
      font-weight: 700;
      color: var(--accent-brand);
    }
    .day-event-content { flex: 1; }
    .day-event-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .day-event-meta { font-size: 12px; color: var(--text-muted); }
    .day-event-badge {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 8px;
    }
    .day-event-badge.crm { background: var(--accent-brand-dim); color: var(--accent-brand); }
    .day-event-badge.google { background: var(--accent-purple-dim); color: var(--accent-purple); }

    /* Month grid */
    .month-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      overflow: hidden;
    }
    .month-header-cell {
      padding: 10px 8px;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border-color);
      background: rgba(0,0,0,0.1);
    }
    .month-cell {
      min-height: 100px;
      padding: 6px;
      border-bottom: 1px solid rgba(99,152,235,0.06);
      border-right: 1px solid rgba(99,152,235,0.06);
      vertical-align: top;
      transition: background var(--transition);
    }
    .month-cell:nth-child(7n) { border-right: none; }
    .month-cell:hover { background: rgba(59,130,246,0.04); }
    .month-cell.today { background: rgba(59,130,246,0.06); }
    .month-cell.other-month { opacity: 0.35; }
    .month-day-num {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    .month-cell.today .month-day-num { color: var(--accent-brand); font-weight: 700; }
    .month-event {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      transition: all var(--transition);
    }
    .month-event:hover { filter: brightness(1.2); }
    .month-event.crm { background: var(--accent-brand-dim); color: var(--accent-brand); }
    .month-event.google { background: var(--accent-purple-dim); color: var(--accent-purple); }
  </style>
</head>
<body>
  <div class="app-layout">
    <aside class="sidebar" id="sidebar"></aside>
    <div class="main-content">
      <header class="topbar" id="topbar"></header>
      <main class="page-content" id="page-content">

        <!-- Reminder Banner (filled by JS) -->
        <div id="reminder-banner"></div>

        <!-- Agenda Header -->
        <div class="agenda-header">
          <div class="agenda-nav">
            <button class="btn btn-secondary btn-sm" onclick="goToday()">Vandaag</button>
            <button class="btn-icon" onclick="navigate(-1)"><i data-lucide="chevron-left" style="width:16px;height:16px;"></i></button>
            <span class="agenda-nav-label" id="nav-label"></span>
            <button class="btn-icon" onclick="navigate(1)"><i data-lucide="chevron-right" style="width:16px;height:16px;"></i></button>
          </div>
          <div class="agenda-views">
            <button class="btn btn-ghost btn-sm" id="view-month-btn" onclick="setView('month')">Maand</button>
            <button class="btn btn-ghost btn-sm active" id="view-week-btn" onclick="setView('week')">Week</button>
            <button class="btn btn-ghost btn-sm" id="view-day-btn" onclick="setView('day')">Dag</button>
          </div>
        </div>

        <!-- Week View -->
        <div id="week-view">
          <div class="week-grid" id="week-grid"></div>
        </div>

        <!-- Month View -->
        <div id="month-view" style="display:none;">
          <div class="month-grid" id="month-grid"></div>
        </div>

        <!-- Day View -->
        <div class="day-list" id="day-view"></div>

      </main>
    </div>
  </div>

  <!-- Event Popover -->
  <div class="event-popover" id="event-popover"></div>

  <script src="assets/js/config.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/components.js"></script>
  <script src="assets/js/sidebar.js"></script>
  <script>
    let currentDate = new Date();
    let currentView = 'week';
    let allEvents = [];

    async function init() {
      await checkAuth();
      initSidebar();
      initTopbar('Agenda');
      lucide.createIcons();
      await loadReminders();
      await loadEvents();
    }

    // ===== REMINDERS =====
    async function loadReminders() {
      try {
        const reminders = await API.get('/calendar/reminders');
        const container = document.getElementById('reminder-banner');

        if (!reminders || reminders.length === 0) {
          container.innerHTML = '';
          return;
        }

        container.innerHTML = `
          <div class="reminder-banner">
            <div class="reminder-banner-title">
              <i data-lucide="bell-ring" style="width:18px;height:18px;"></i>
              ${reminders.length} afspraak${reminders.length > 1 ? 'en' : ''} in de komende 24 uur - stuur een herinnering!
            </div>
            ${reminders.map(r => {
              const time = new Date(r.startTime).toLocaleString('nl-BE', { weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
              const phone = r.lead?.phone || '';
              const company = r.lead?.companyName || r.title;
              const contact = r.lead?.contactPerson || '';
              return `
                <div class="reminder-item">
                  <div class="reminder-info">
                    <div class="reminder-company">${company}${contact ? ' - ' + contact : ''}</div>
                    <div class="reminder-time">${time}${r.location ? ' | ' + r.location : ''}</div>
                    ${phone ? `<div class="reminder-phone"><i data-lucide="phone" style="width:12px;height:12px;display:inline;vertical-align:middle;margin-right:4px;"></i>${phone}</div>` : '<div class="reminder-phone" style="color:var(--accent-red);">Geen telefoonnummer</div>'}
                  </div>
                  <div class="reminder-actions">
                    ${phone ? `<a href="tel:${phone}" class="btn btn-primary btn-sm"><i data-lucide="phone" style="width:12px;height:12px;"></i> Bellen</a>` : ''}
                    ${phone ? `<a href="sms:${phone}" class="btn btn-secondary btn-sm"><i data-lucide="message-square" style="width:12px;height:12px;"></i> SMS</a>` : ''}
                    <button class="btn btn-ghost btn-sm" onclick="markReminderSent('${r.id}')">Gedaan</button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
        lucide.createIcons();
      } catch (err) {
        console.error('Reminders error:', err);
      }
    }

    async function markReminderSent(id) {
      try {
        await API.post(`/calendar/reminders/${id}/sent`);
        showToast('Herinnering gemarkeerd als verstuurd');
        await loadReminders();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    // ===== EVENTS =====
    async function loadEvents() {
      const { start, end } = getDateRange();
      try {
        allEvents = await API.get(`/calendar/events?start=${start.toISOString()}&end=${end.toISOString()}`);
      } catch (err) {
        allEvents = [];
        console.error('Events error:', err);
      }
      render();
    }

    function getDateRange() {
      if (currentView === 'month') {
        const start = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        start.setDate(start.getDate() - start.getDay() + (start.getDay() === 0 ? -6 : 1)); // Monday of first week
        const end = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        const endDay = end.getDay();
        end.setDate(end.getDate() + (endDay === 0 ? 0 : 7 - endDay)); // Sunday of last week
        end.setHours(23, 59, 59, 999);
        start.setHours(0, 0, 0, 0);
        return { start, end };
      } else if (currentView === 'week') {
        const start = getWeekStart(currentDate);
        const end = new Date(start);
        end.setDate(end.getDate() + 7);
        return { start, end };
      } else {
        const start = new Date(currentDate);
        start.setHours(0, 0, 0, 0);
        const end = new Date(start);
        end.setDate(end.getDate() + 1);
        return { start, end };
      }
    }

    function getWeekStart(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Monday
      d.setDate(diff);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    // ===== NAVIGATION =====
    function navigate(dir) {
      if (currentView === 'month') {
        currentDate.setMonth(currentDate.getMonth() + dir);
      } else if (currentView === 'week') {
        currentDate.setDate(currentDate.getDate() + dir * 7);
      } else {
        currentDate.setDate(currentDate.getDate() + dir);
      }
      loadEvents();
    }

    function goToday() {
      currentDate = new Date();
      loadEvents();
    }

    function setView(view) {
      currentView = view;
      document.getElementById('view-month-btn').classList.toggle('active', view === 'month');
      document.getElementById('view-week-btn').classList.toggle('active', view === 'week');
      document.getElementById('view-day-btn').classList.toggle('active', view === 'day');
      document.getElementById('month-view').style.display = view === 'month' ? 'block' : 'none';
      document.getElementById('week-view').style.display = view === 'week' ? 'block' : 'none';
      document.getElementById('day-view').classList.toggle('active', view === 'day');
      loadEvents();
    }

    // ===== RENDER =====
    function render() {
      updateNavLabel();
      if (currentView === 'month') renderMonth();
      else if (currentView === 'week') renderWeek();
      else renderDay();
    }

    function updateNavLabel() {
      const label = document.getElementById('nav-label');
      if (currentView === 'month') {
        label.textContent = currentDate.toLocaleDateString('nl-BE', { month: 'long', year: 'numeric' });
      } else if (currentView === 'week') {
        const start = getWeekStart(currentDate);
        const end = new Date(start);
        end.setDate(end.getDate() + 6);
        const fmt = (d) => d.toLocaleDateString('nl-BE', { day: 'numeric', month: 'short' });
        label.textContent = `${fmt(start)} - ${fmt(end)} ${end.getFullYear()}`;
      } else {
        label.textContent = currentDate.toLocaleDateString('nl-BE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      }
    }

    function renderMonth() {
      const grid = document.getElementById('month-grid');
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const currentMonth = currentDate.getMonth();

      const { start, end } = getDateRange();
      const dayNames = ['Ma', 'Di', 'Wo', 'Do', 'Vr', 'Za', 'Zo'];

      let html = dayNames.map(d => `<div class="month-header-cell">${d}</div>`).join('');

      const cursor = new Date(start);
      while (cursor <= end) {
        const dateStr = cursor.toDateString();
        const isToday = dateStr === today.toDateString();
        const isOther = cursor.getMonth() !== currentMonth;
        const dayEvents = allEvents.filter(ev => new Date(ev.start).toDateString() === dateStr);
        const fmt = (d) => new Date(d).toLocaleTimeString('nl-BE', { hour: '2-digit', minute: '2-digit' });

        html += `<div class="month-cell${isToday ? ' today' : ''}${isOther ? ' other-month' : ''}">`;
        html += `<div class="month-day-num">${cursor.getDate()}</div>`;
        dayEvents.slice(0, 3).forEach(ev => {
          html += `<div class="month-event ${ev.source}" onclick="showEventPopover(${JSON.stringify(ev).replace(/"/g, '&quot;').replace(/'/g, '&#39;')}, event)">${fmt(ev.start)} ${ev.title}</div>`;
        });
        if (dayEvents.length > 3) {
          html += `<div style="font-size:10px;color:var(--text-muted);padding:2px 6px;">+${dayEvents.length - 3} meer</div>`;
        }
        html += '</div>';
        cursor.setDate(cursor.getDate() + 1);
      }

      grid.innerHTML = html;
    }

    function renderWeek() {
      const grid = document.getElementById('week-grid');
      const weekStart = getWeekStart(currentDate);
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const days = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date(weekStart);
        d.setDate(d.getDate() + i);
        days.push(d);
      }

      const dayNames = ['Ma', 'Di', 'Wo', 'Do', 'Vr', 'Za', 'Zo'];
      const startHour = 7;
      const endHour = 20;

      let html = '<div class="week-header">';
      html += '<div class="week-header-cell"></div>'; // time column header
      days.forEach((d, i) => {
        const isToday = d.getTime() === today.getTime();
        html += `<div class="week-header-cell ${isToday ? 'today' : ''}">
          ${dayNames[i]}
          <span class="week-header-day">${d.getDate()}</span>
        </div>`;
      });
      html += '</div>';

      for (let h = startHour; h < endHour; h++) {
        html += `<div class="week-time-col">${String(h).padStart(2, '0')}:00</div>`;
        days.forEach((d, di) => {
          const isToday = d.getTime() === today.getTime();
          html += `<div class="week-cell ${isToday ? 'today' : ''}" data-day="${di}" data-hour="${h}"></div>`;
        });
      }

      grid.innerHTML = html;

      // Place events
      allEvents.forEach(ev => {
        const evStart = new Date(ev.start);
        const evEnd = new Date(ev.end);
        const dayIdx = days.findIndex(d => d.toDateString() === evStart.toDateString());
        if (dayIdx === -1) return;

        const startMinutes = evStart.getHours() * 60 + evStart.getMinutes();
        const endMinutes = evEnd.getHours() * 60 + evEnd.getMinutes();
        const topOffset = ((startMinutes - startHour * 60) / 60) * 60; // 60px per hour
        const height = Math.max(((endMinutes - startMinutes) / 60) * 60, 20);

        const cell = grid.querySelector(`.week-cell[data-day="${dayIdx}"][data-hour="${Math.max(startHour, evStart.getHours())}"]`);
        if (!cell) return;

        const fmt = (d) => d.toLocaleTimeString('nl-BE', { hour: '2-digit', minute: '2-digit' });
        const eventEl = document.createElement('div');
        eventEl.className = `cal-event ${ev.source}`;
        eventEl.style.top = `${(evStart.getMinutes() / 60) * 60}px`;
        eventEl.style.height = `${height}px`;
        eventEl.innerHTML = `
          <div class="cal-event-time">${fmt(evStart)}</div>
          <div class="cal-event-title">${ev.title}</div>
        `;
        eventEl.onclick = (e) => showEventPopover(ev, e);
        cell.appendChild(eventEl);
      });
    }

    function renderDay() {
      const container = document.getElementById('day-view');
      const dayStr = currentDate.toDateString();
      const dayEvents = allEvents.filter(ev => new Date(ev.start).toDateString() === dayStr);

      if (dayEvents.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon"><i data-lucide="calendar-x" style="width:48px;height:48px;"></i></div>
            <div class="empty-state-title">Geen afspraken</div>
            <div class="empty-state-text">Er zijn geen afspraken gepland voor deze dag.</div>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      const fmt = (d) => new Date(d).toLocaleTimeString('nl-BE', { hour: '2-digit', minute: '2-digit' });

      container.innerHTML = dayEvents.map(ev => `
        <div class="day-event" onclick="showEventPopover(${JSON.stringify(ev).replace(/"/g, '&quot;')}, event)">
          <div class="day-event-time">${fmt(ev.start)} - ${fmt(ev.end)}</div>
          <div class="day-event-content">
            <div class="day-event-title">
              ${ev.title}
              <span class="day-event-badge ${ev.source}">${ev.source === 'crm' ? 'CRM' : 'Google'}</span>
            </div>
            <div class="day-event-meta">
              ${ev.lead ? ev.lead.companyName + (ev.lead.city ? ' - ' + ev.lead.city : '') : ''}
              ${ev.location ? '<br>' + ev.location : ''}
            </div>
          </div>
        </div>
      `).join('');
      lucide.createIcons();
    }

    // ===== EVENT POPOVER =====
    function showEventPopover(ev, e) {
      e.stopPropagation();
      const popover = document.getElementById('event-popover');
      const fmt = (d) => new Date(d).toLocaleTimeString('nl-BE', { hour: '2-digit', minute: '2-digit' });
      const dateFmt = (d) => new Date(d).toLocaleDateString('nl-BE', { weekday: 'long', day: 'numeric', month: 'long' });

      popover.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
          <div class="event-popover-title">${ev.title}</div>
          <button class="modal-close" onclick="closePopover()" style="width:24px;height:24px;"><i data-lucide="x" style="width:14px;height:14px;"></i></button>
        </div>
        
        <div style="margin-bottom:12px;">
          <div class="event-popover-row"><i data-lucide="clock"></i> ${dateFmt(ev.start)}, ${fmt(ev.start)} - ${fmt(ev.end)}</div>
          ${ev.location ? `<div class="event-popover-row"><i data-lucide="map-pin"></i> ${ev.location}</div>` : ''}
          ${ev.meetingType ? `<div class="event-popover-row"><i data-lucide="video"></i> ${ev.meetingType}</div>` : ''}
        </div>

        ${ev.lead ? `
          <div style="padding:12px;background:var(--bg-input);border-radius:var(--radius-sm);margin-bottom:12px;">
            <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px;">Lead informatie</div>
            <div class="event-popover-row"><i data-lucide="building-2"></i> ${ev.lead.companyName}</div>
            ${ev.lead.contactPerson ? `<div class="event-popover-row"><i data-lucide="user"></i> ${ev.lead.contactPerson}</div>` : ''}
            ${ev.lead.phone ? `<div class="event-popover-row"><i data-lucide="phone"></i> <a href="tel:${ev.lead.phone}" style="color:var(--accent-brand);">${ev.lead.phone}</a></div>` : ''}
            ${ev.lead.city ? `<div class="event-popover-row"><i data-lucide="map-pin"></i> ${ev.lead.city}</div>` : ''}
          </div>
        ` : ''}

        ${ev.description || ev.notes ? `
          <div style="padding:12px;background:var(--bg-input);border-radius:var(--radius-sm);margin-bottom:12px;">
            <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px;">
              ${ev.description ? 'Beschrijving' : 'Notities'}
            </div>
            <div style="font-size:13px;line-height:1.5;white-space:pre-wrap;">${ev.description || ev.notes}</div>
          </div>
        ` : ''}

        ${ev.createdBy ? `<div class="event-popover-row"><i data-lucide="user-circle"></i> Aangemaakt door: ${ev.createdBy}</div>` : ''}
        
        <div style="display:flex;gap:8px;margin-top:14px;padding-top:12px;border-top:1px solid var(--border-color);">
          <span class="day-event-badge ${ev.source}" style="font-size:11px;padding:3px 10px;">${ev.source === 'crm' ? 'CRM Afspraak' : 'Google Calendar'}</span>
          ${ev.source === 'crm' && ev.lead ? `<a href="${basePath('/leads.html')}?view=${ev.lead.id}" class="btn btn-ghost btn-sm" style="font-size:11px;">Bekijk lead</a>` : ''}
        </div>
      `;

      // Position
      const rect = e.target.getBoundingClientRect();
      let top = rect.bottom + 8;
      let left = rect.left;
      if (left + 380 > window.innerWidth) left = window.innerWidth - 400;
      if (top + 400 > window.innerHeight) top = rect.top - 400;
      popover.style.top = Math.max(10, top) + 'px';
      popover.style.left = Math.max(10, left) + 'px';
      popover.classList.add('active');
      lucide.createIcons();
    }

    function closePopover() {
      document.getElementById('event-popover').classList.remove('active');
    }

    document.addEventListener('click', (e) => {
      const popover = document.getElementById('event-popover');
      if (popover.classList.contains('active') && !popover.contains(e.target) && !e.target.closest('.cal-event')) {
        closePopover();
      }
    });

    // Keyboard nav
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if (e.key === 'ArrowLeft') navigate(-1);
      if (e.key === 'ArrowRight') navigate(1);
      if (e.key === 't' || e.key === 'T') goToday();
      if (e.key === 'Escape') closePopover();
    });

    init();
  </script>
</body>
</html>
