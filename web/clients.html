<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="icon" type="image/png" href="favicon.png">
  <title>Klanten - Cold Outreach CRM</title>
  <link rel="stylesheet" href="assets/css/global.css">
  <script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.min.js"></script>
</head>
<body>
  <div class="app-layout">
    <aside class="sidebar" id="sidebar"></aside>
    <div class="main-content">
      <header class="topbar" id="topbar"></header>
      <main class="page-content">
        <div class="toolbar">
          <div class="toolbar-left">
            <div class="topbar-search">
              <i data-lucide="search"></i>
              <input type="text" placeholder="Zoek klanten..." id="search-input" oninput="searchClients()">
            </div>
          </div>
          <div class="toolbar-right">
            <span id="client-count" style="font-size:13px;color:var(--text-muted);"></span>
            <button class="btn btn-primary" onclick="openNewClientModal()">
              <i data-lucide="plus"></i> Nieuwe klant
            </button>
          </div>
        </div>

        <div class="card" style="border-top:2px solid #34d399;">
          <div class="card-body" style="padding:0;">
            <table class="data-table" id="clients-table">
              <thead>
                <tr>
                  <th>Bedrijfsnaam</th>
                  <th>Herkomst</th>
                  <th>Contactpersoon</th>
                  <th>Gemeente</th>
                  <th>Telefoon</th>
                  <th>Email</th>
                  <th>Pakket</th>
                  <th>Hosting</th>
                  <th>Dealwaarde</th>
                  <th>Klant sinds</th>
                  <th>Acties</th>
                </tr>
              </thead>
              <tbody id="clients-body"></tbody>
            </table>
          </div>
        </div>
        <div id="pagination"></div>
      </main>
    </div>
  </div>

  <!-- Client Detail Modal -->
  <div class="modal-overlay" id="detail-modal" onclick="if(event.target===this)closeModal('detail-modal')">
    <div class="modal" style="max-width:560px;">
      <div class="modal-header">
        <span class="modal-title" id="detail-modal-title">Klant details</span>
        <button class="modal-close" onclick="closeModal('detail-modal')"><i data-lucide="x"></i></button>
      </div>
      <div class="modal-body" id="detail-modal-body"></div>
    </div>
  </div>

  <!-- New Client Modal -->
  <div class="modal-overlay" id="new-client-modal" onclick="if(event.target===this)closeModal('new-client-modal')">
    <div class="modal" style="max-width:560px;">
      <div class="modal-header">
        <span class="modal-title">Nieuwe klant toevoegen</span>
        <button class="modal-close" onclick="closeModal('new-client-modal')"><i data-lucide="x"></i></button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">BTW nummer opzoeken (optioneel)</label>
          <div style="display:flex;gap:8px;">
            <input type="text" class="form-input" id="new-client-vat" placeholder="BE0866.477.739" style="flex:1;">
            <button type="button" class="btn btn-primary" id="new-vat-lookup-btn" onclick="lookupNewClientVat()">
              <i data-lucide="search" style="width:16px;height:16px;"></i> Opzoeken
            </button>
          </div>
          <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Alle formaten werken: BE0866.477.739 / BE0866477739 / 0866.477.739 / 0866477739</div>
          <div id="new-vat-lookup-result" style="display:none;margin-top:8px;padding:8px 12px;border-radius:var(--radius-sm);font-size:12px;"></div>
        </div>
        <hr style="border-color:var(--border-color);margin:16px 0;">
        <div style="display:grid;gap:12px;">
          <div class="form-group" style="margin:0;">
            <label class="form-label">Bedrijfsnaam *</label>
            <input type="text" class="form-input" id="new-client-company" required>
          </div>
          <div class="form-group" style="margin:0;">
            <label class="form-label">Contactpersoon</label>
            <input type="text" class="form-input" id="new-client-contact">
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <div class="form-group" style="margin:0;">
              <label class="form-label">Telefoon</label>
              <input type="text" class="form-input" id="new-client-phone">
            </div>
            <div class="form-group" style="margin:0;">
              <label class="form-label">Email</label>
              <input type="email" class="form-input" id="new-client-email">
            </div>
          </div>
          <div class="form-group" style="margin:0;">
            <label class="form-label">Adres</label>
            <input type="text" class="form-input" id="new-client-address">
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <div class="form-group" style="margin:0;">
              <label class="form-label">Gemeente</label>
              <input type="text" class="form-input" id="new-client-city">
            </div>
            <div class="form-group" style="margin:0;">
              <label class="form-label">Website</label>
              <input type="url" class="form-input" id="new-client-website" placeholder="https://...">
            </div>
          </div>
          <div class="form-group" style="margin:0;">
            <label class="form-label">Notities</label>
            <textarea class="form-input" id="new-client-notes" rows="3"></textarea>
          </div>
        </div>
        <hr style="border-color:var(--border-color);margin:16px 0;">
        <div style="font-size:13px;font-weight:600;color:var(--text-primary);margin-bottom:12px;">Hosting</div>
        <div style="display:grid;gap:12px;">
          <div class="form-group" style="margin:0;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
              <input type="checkbox" id="new-client-has-hosting" onchange="toggleNewClientHosting()">
              <span class="form-label" style="margin:0;">Hosting toevoegen</span>
            </label>
          </div>
          <div id="new-client-hosting-details" style="display:none;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
              <div class="form-group" style="margin:0;">
                <label class="form-label">Hosting prijs per maand</label>
                <select class="form-input" id="new-client-hosting-price">
                  <option value="15">€15/mnd (€180/jaar)</option>
                  <option value="20" selected>€20/mnd (€240/jaar)</option>
                </select>
                <input type="hidden" id="new-client-hosting-interval" value="MONTHLY">
              </div>
              <div class="form-group" style="margin:0;">
                <label class="form-label">Gefactureerd per</label>
                <input type="text" class="form-input" value="Jaar" disabled style="background:var(--bg-secondary);color:var(--text-muted);cursor:not-allowed;">
              </div>
            </div>
            <div class="form-group" style="margin:0;">
              <label class="form-label">Startdatum hosting</label>
              <input type="date" class="form-input" id="new-client-hosting-start">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('new-client-modal')">Annuleren</button>
        <button class="btn btn-primary" onclick="saveNewClient()">Klant opslaan</button>
      </div>
    </div>
  </div>

  <!-- Client Edit Modal -->
  <div class="modal-overlay" id="edit-modal" onclick="if(event.target===this)closeModal('edit-modal')">
    <div class="modal" style="max-width:520px;">
      <div class="modal-header">
        <span class="modal-title">Klant bewerken</span>
        <button class="modal-close" onclick="closeModal('edit-modal')"><i data-lucide="x"></i></button>
      </div>
      <div class="modal-body" id="edit-modal-body"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('edit-modal')">Annuleren</button>
        <button class="btn btn-primary" onclick="saveClient()">Opslaan</button>
      </div>
    </div>
  </div>

  <script src="assets/js/config.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/components.js"></script>
  <script src="assets/js/sidebar.js"></script>
  <script>
    let currentPage = 1;
    let editingClientId = null;

    async function init() {
      if (!await requireLogin()) return;
      initSidebar();
      initTopbar('Klanten');
      loadClients();
    }

    async function loadClients(search = '') {
      try {
        const params = new URLSearchParams({ page: currentPage, limit: 50 });
        if (search) params.set('search', search);
        const data = await API.get(`/clients?${params}`);
        renderClients(data);
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    function searchClients() {
      const search = document.getElementById('search-input').value.trim();
      currentPage = 1;
      loadClients(search);
    }

    function renderClients(data) {
      const tbody = document.getElementById('clients-body');
      document.getElementById('client-count').innerHTML = `<span style="color:#34d399;font-weight:600;">${data.total}</span> klant${data.total !== 1 ? 'en' : ''}`;

      if (data.clients.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted" style="padding:40px;">Geen klanten gevonden</td></tr>';
        return;
      }

      tbody.innerHTML = data.clients.map(client => {
        const deal = client.deal;
        const hasHosting = deal?.hasHosting;
        const hostingBadge = hasHosting
          ? `<span style="background:var(--accent-green-dim);color:var(--accent-green);padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;">${formatCurrency(deal.hostingPrice)}/mnd</span>`
          : '<span style="color:var(--text-muted);font-size:12px;">Geen</span>';

        let originBadge = '<span class="source-badge direct">Direct</span>';
        if (deal?.acquisitionType === 'flyer') {
          originBadge = '<span class="source-badge flyer">Via lead (flyer)</span>';
        } else if (deal?.acquisitionType === 'manual' && deal?.acquisitionCost > 0) {
          originBadge = '<span class="source-badge cold-outreach">Via lead pipeline</span>';
        } else if (deal?.acquisitionType === 'none') {
          originBadge = '<span class="source-badge warm">Warm / direct</span>';
        }

        return `
          <tr style="cursor:pointer;" onclick="viewClient('${client.id}')">
            <td style="font-weight:500;">${client.companyName}</td>
            <td>${originBadge}</td>
            <td>${client.contactPerson || '-'}</td>
            <td>${client.city || '-'}</td>
            <td onclick="event.stopPropagation()">${client.phone ? `<a href="tel:${client.phone}" style="color:var(--accent-brand);">${client.phone}</a>` : '-'}</td>
            <td onclick="event.stopPropagation()">${client.email ? `<a href="mailto:${client.email}" style="color:var(--accent-brand);">${client.email}</a>` : '-'}</td>
            <td>${deal?.package ? `<span style="background:var(--accent-blue-dim);color:var(--accent-blue);padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;">${deal.package.name}</span>` : '-'}</td>
            <td>${hostingBadge}</td>
            <td style="font-weight:700;color:#34d399;">${deal ? formatCurrency(deal.totalValue) : '-'}</td>
            <td style="color:var(--text-muted);">${formatDate(client.createdAt)}</td>
            <td onclick="event.stopPropagation()">
              <div style="display:flex;gap:4px;">
                <button class="btn-icon" onclick="viewClient('${client.id}')" title="Bekijken">
                  <i data-lucide="eye" style="width:16px;height:16px;"></i>
                </button>
                <button class="btn-icon" onclick="openEditClient('${client.id}')" title="Bewerken">
                  <i data-lucide="pencil" style="width:16px;height:16px;"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      renderPagination(document.getElementById('pagination'), {
        page: data.page,
        totalPages: data.totalPages,
        total: data.total
      }, (p) => { currentPage = p; loadClients(document.getElementById('search-input').value.trim()); });

      refreshIcons();
    }

    async function viewClient(id) {
      try {
        const client = await API.get(`/clients/${id}`);
        const deal = client.deal;
        document.getElementById('detail-modal-title').textContent = client.companyName;

        const upsellList = deal?.upsells?.map(u =>
          `<span style="background:var(--accent-purple-dim);color:var(--accent-purple);padding:3px 10px;border-radius:12px;font-size:12px;font-weight:600;margin-right:4px;">${u.upsell.name}</span>`
        ).join('') || '<span class="text-muted">Geen</span>';

        document.getElementById('detail-modal-body').innerHTML = `
          <div style="display:flex;flex-direction:column;gap:14px;">
            <h4 style="font-size:14px;font-weight:600;margin:0;color:var(--text-primary);">Klantgegevens</h4>
            <div class="flex justify-between items-center">
              <span class="text-muted">Bedrijfsnaam</span>
              <span style="font-weight:600;">${client.companyName}</span>
            </div>
            ${client.vatNumber ? `<div class="flex justify-between items-center">
              <span class="text-muted">BTW nummer</span>
              <span>${client.vatNumber}</span>
            </div>` : ''}
            ${client.contactPerson ? `<div class="flex justify-between items-center">
              <span class="text-muted">Contactpersoon</span>
              <span>${client.contactPerson}</span>
            </div>` : ''}
            ${client.phone ? `<div class="flex justify-between items-center">
              <span class="text-muted">Telefoon</span>
              <span><a href="tel:${client.phone}" style="color:var(--accent-brand);">${client.phone}</a></span>
            </div>` : ''}
            ${client.email ? `<div class="flex justify-between items-center">
              <span class="text-muted">Email</span>
              <span><a href="mailto:${client.email}" style="color:var(--accent-brand);">${client.email}</a></span>
            </div>` : ''}
            ${client.address ? `<div class="flex justify-between items-center">
              <span class="text-muted">Adres</span>
              <span>${client.address}</span>
            </div>` : ''}
            ${client.city ? `<div class="flex justify-between items-center">
              <span class="text-muted">Gemeente</span>
              <span>${client.city}</span>
            </div>` : ''}
            ${client.website ? `<div class="flex justify-between items-center">
              <span class="text-muted">Website</span>
              <span><a href="${client.website}" target="_blank" style="color:var(--accent-brand);">${client.website}</a></span>
            </div>` : ''}

            ${deal ? `
              <hr style="border-color:var(--border-color);">
              <h4 style="font-size:14px;font-weight:600;margin:0;color:var(--text-primary);">Deal & pakket</h4>
              <div class="flex justify-between items-center">
                <span class="text-muted">Pakket</span>
                <span style="font-weight:600;">${deal.package?.name || '-'}</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-muted">Eenmalig</span>
                <span>${formatCurrency(deal.package?.oneTimePrice || 0)}</span>
              </div>
              <div>
                <span class="text-muted" style="display:block;margin-bottom:6px;">Upsells</span>
                <div>${upsellList}</div>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-muted">Dealwaarde</span>
                <span style="font-weight:700;color:var(--accent-brand);">${formatCurrency(deal.totalValue)}</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-muted">Klant sinds</span>
                <span>${formatDate(deal.saleDate)}</span>
              </div>

              <hr style="border-color:var(--border-color);">
              <h4 style="font-size:14px;font-weight:600;margin:0;color:var(--text-primary);">Hosting</h4>
              ${deal.hasHosting ? `
                <div class="flex justify-between items-center">
                  <span class="text-muted">Status</span>
                  <span style="background:var(--accent-green-dim);color:var(--accent-green);padding:3px 10px;border-radius:12px;font-size:12px;font-weight:600;">Actief</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-muted">Prijs</span>
                  <span style="font-weight:600;">${formatCurrency(deal.hostingPrice)}/${deal.hostingInterval === 'YEARLY' ? 'jaar' : 'mnd'}</span>
                </div>
                ${deal.hostingStartDate ? `<div class="flex justify-between items-center">
                  <span class="text-muted">Startdatum</span>
                  <span>${formatDate(deal.hostingStartDate)}</span>
                </div>` : ''}
                ${deal.nextInvoiceDate ? `<div class="flex justify-between items-center">
                  <span class="text-muted">Volgende factuur</span>
                  <span>${formatDate(deal.nextInvoiceDate)}</span>
                </div>` : ''}
              ` : `
                <div class="flex justify-between items-center">
                  <span class="text-muted">Status</span>
                  <span style="color:var(--text-muted);">Geen hosting</span>
                </div>
              `}
            ` : ''}

            ${client.notes ? `
              <hr style="border-color:var(--border-color);">
              <h4 style="font-size:14px;font-weight:600;margin:0;color:var(--text-primary);">Notities</h4>
              <div style="background:var(--bg-secondary);padding:10px;border-radius:6px;font-size:13px;">${client.notes}</div>
            ` : ''}

            <hr style="border-color:var(--border-color);">
            <div style="display:flex;gap:8px;justify-content:space-between;">
              <button class="btn btn-sm" style="color:var(--accent-red);border:1px solid var(--accent-red);background:transparent;" onclick="deleteClient('${client.id}','${client.companyName.replace(/'/g, "\\'")}')">
                <i data-lucide="trash-2" style="width:14px;height:14px;"></i> Verwijderen
              </button>
              <button class="btn btn-secondary btn-sm" onclick="closeModal('detail-modal');openEditClient('${client.id}')">
                <i data-lucide="pencil" style="width:14px;height:14px;"></i> Bewerken
              </button>
            </div>
          </div>
        `;

        openModal('detail-modal');
        refreshIcons();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function openEditClient(id) {
      try {
        const client = await API.get(`/clients/${id}`);
        editingClientId = id;

        document.getElementById('edit-modal-body').innerHTML = `
          <div style="display:grid;gap:12px;">
            <div class="form-group" style="margin:0;">
              <label class="form-label">Bedrijfsnaam</label>
              <input type="text" class="form-input" id="edit-company" value="${client.companyName || ''}">
            </div>
            <div class="form-group" style="margin:0;">
              <label class="form-label">BTW nummer</label>
              <input type="text" class="form-input" id="edit-vat" value="${client.vatNumber || ''}">
            </div>
            <div class="form-group" style="margin:0;">
              <label class="form-label">Contactpersoon</label>
              <input type="text" class="form-input" id="edit-contact" value="${client.contactPerson || ''}">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div class="form-group" style="margin:0;">
                <label class="form-label">Telefoon</label>
                <input type="text" class="form-input" id="edit-phone" value="${client.phone || ''}">
              </div>
              <div class="form-group" style="margin:0;">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="edit-email" value="${client.email || ''}">
              </div>
            </div>
            <div class="form-group" style="margin:0;">
              <label class="form-label">Adres</label>
              <input type="text" class="form-input" id="edit-address" value="${client.address || ''}">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div class="form-group" style="margin:0;">
                <label class="form-label">Gemeente</label>
                <input type="text" class="form-input" id="edit-city" value="${client.city || ''}">
              </div>
              <div class="form-group" style="margin:0;">
                <label class="form-label">Website</label>
                <input type="url" class="form-input" id="edit-website" value="${client.website || ''}">
              </div>
            </div>
            <div class="form-group" style="margin:0;">
              <label class="form-label">Notities</label>
              <textarea class="form-input" id="edit-notes" rows="3">${client.notes || ''}</textarea>
            </div>
          </div>
          <hr style="border-color:var(--border-color);margin:16px 0;">
          <div style="font-size:13px;font-weight:600;color:var(--text-primary);margin-bottom:12px;">Hosting</div>
          <div style="display:grid;gap:12px;">
            <div class="form-group" style="margin:0;">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                <input type="checkbox" id="edit-has-hosting" ${client.deal?.hasHosting ? 'checked' : ''} onchange="toggleEditHosting()">
                <span class="form-label" style="margin:0;">Hosting actief</span>
              </label>
            </div>
            <div id="edit-hosting-details" style="display:${client.deal?.hasHosting ? 'block' : 'none'};">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
                <div class="form-group" style="margin:0;">
                  <label class="form-label">Hosting prijs</label>
                  <input type="number" class="form-input" id="edit-hosting-price" value="${client.deal?.hostingPrice || 20}" step="0.01" min="0">
                </div>
                <div class="form-group" style="margin:0;">
                  <label class="form-label">Interval</label>
                  <select class="form-input" id="edit-hosting-interval">
                    <option value="MONTHLY" ${client.deal?.hostingInterval === 'MONTHLY' ? 'selected' : ''}>Maandelijks</option>
                    <option value="YEARLY" ${client.deal?.hostingInterval === 'YEARLY' ? 'selected' : ''}>Jaarlijks</option>
                  </select>
                </div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                <div class="form-group" style="margin:0;">
                  <label class="form-label">Startdatum</label>
                  <input type="date" class="form-input" id="edit-hosting-start" value="${client.deal?.hostingStartDate ? new Date(client.deal.hostingStartDate).toISOString().split('T')[0] : ''}">
                </div>
                <div class="form-group" style="margin:0;">
                  <label class="form-label">Einddatum (optioneel)</label>
                  <input type="date" class="form-input" id="edit-hosting-end" value="${client.deal?.hostingEndDate ? new Date(client.deal.hostingEndDate).toISOString().split('T')[0] : ''}">
                </div>
              </div>
            </div>
          </div>
        `;

        openModal('edit-modal');
        refreshIcons();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    function toggleEditHosting() {
      const hasHosting = document.getElementById('edit-has-hosting').checked;
      const details = document.getElementById('edit-hosting-details');
      details.style.display = hasHosting ? 'block' : 'none';
    }

    async function saveClient() {
      if (!editingClientId) return;
      try {
        const hasHosting = document.getElementById('edit-has-hosting').checked;
        const payload = {
          companyName: document.getElementById('edit-company').value,
          vatNumber: document.getElementById('edit-vat').value || null,
          contactPerson: document.getElementById('edit-contact').value || null,
          phone: document.getElementById('edit-phone').value || null,
          email: document.getElementById('edit-email').value || null,
          address: document.getElementById('edit-address').value || null,
          city: document.getElementById('edit-city').value || null,
          website: document.getElementById('edit-website').value || null,
          notes: document.getElementById('edit-notes').value || null,
          hasHosting
        };

        if (hasHosting) {
          payload.hostingPrice = parseFloat(document.getElementById('edit-hosting-price').value) || 20;
          payload.hostingInterval = document.getElementById('edit-hosting-interval').value;
          payload.hostingStartDate = document.getElementById('edit-hosting-start').value || null;
          payload.hostingEndDate = document.getElementById('edit-hosting-end').value || null;
        }

        await API.put(`/clients/${editingClientId}`, payload);
        closeModal('edit-modal');
        showToast('Klant bijgewerkt');
        loadClients(document.getElementById('search-input').value.trim());
      } catch (err) {
        showToast(err.message || 'Fout bij opslaan', 'error');
      }
    }

    function openNewClientModal() {
      document.getElementById('new-client-vat').value = '';
      document.getElementById('new-client-company').value = '';
      document.getElementById('new-client-contact').value = '';
      document.getElementById('new-client-phone').value = '';
      document.getElementById('new-client-email').value = '';
      document.getElementById('new-client-address').value = '';
      document.getElementById('new-client-city').value = '';
      document.getElementById('new-client-website').value = '';
      document.getElementById('new-client-notes').value = '';
      document.getElementById('new-client-has-hosting').checked = false;
      document.getElementById('new-client-hosting-price').value = '20';
      document.getElementById('new-client-hosting-interval').value = 'MONTHLY';
      document.getElementById('new-client-hosting-start').value = new Date().toISOString().split('T')[0];
      document.getElementById('new-client-hosting-details').style.display = 'none';
      const resultDiv = document.getElementById('new-vat-lookup-result');
      resultDiv.style.display = 'none';
      resultDiv.innerHTML = '';
      openModal('new-client-modal');
      refreshIcons();
    }

    async function lookupNewClientVat() {
      const vatInput = document.getElementById('new-client-vat').value.trim();
      const resultDiv = document.getElementById('new-vat-lookup-result');
      const btn = document.getElementById('new-vat-lookup-btn');
      
      if (!vatInput) {
        resultDiv.style.display = 'block';
        resultDiv.style.background = 'var(--accent-red-dim)';
        resultDiv.style.color = 'var(--accent-red)';
        resultDiv.textContent = 'Voer een BTW nummer in';
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<i data-lucide="loader" style="width:16px;height:16px;animation:spin 1s linear infinite;"></i> Zoeken...';
      resultDiv.style.display = 'none';

      try {
        const data = await API.get(`/kbo/lookup/${encodeURIComponent(vatInput)}`);
        
        document.getElementById('new-client-company').value = data.companyName || '';
        document.getElementById('new-client-phone').value = data.phone || '';
        document.getElementById('new-client-email').value = data.email || '';
        document.getElementById('new-client-address').value = data.address || '';
        document.getElementById('new-client-city').value = data.city || '';
        document.getElementById('new-client-website').value = data.website || '';
        document.getElementById('new-client-vat').value = data.vatNumberFormatted || vatInput;

        resultDiv.style.display = 'block';
        resultDiv.style.background = 'var(--accent-green-dim)';
        resultDiv.style.color = 'var(--accent-green)';
        resultDiv.innerHTML = `Bedrijf gevonden: <strong>${data.companyName}</strong>${data.legalForm ? ' (' + data.legalForm + ')' : ''}`;
      } catch (err) {
        resultDiv.style.display = 'block';
        resultDiv.style.background = 'var(--accent-red-dim)';
        resultDiv.style.color = 'var(--accent-red)';
        resultDiv.textContent = err.message || 'Bedrijf niet gevonden';
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i data-lucide="search" style="width:16px;height:16px;"></i> Opzoeken';
        refreshIcons();
      }
    }

    function toggleNewClientHosting() {
      const hasHosting = document.getElementById('new-client-has-hosting').checked;
      const details = document.getElementById('new-client-hosting-details');
      details.style.display = hasHosting ? 'block' : 'none';
      if (hasHosting && !document.getElementById('new-client-hosting-start').value) {
        document.getElementById('new-client-hosting-start').value = new Date().toISOString().split('T')[0];
      }
    }

    async function saveNewClient() {
      const companyName = document.getElementById('new-client-company').value.trim();
      if (!companyName) {
        showToast('Bedrijfsnaam is verplicht', 'warning');
        return;
      }

      const hasHosting = document.getElementById('new-client-has-hosting').checked;
      const payload = {
        companyName,
        vatNumber: document.getElementById('new-client-vat').value.trim() || null,
        contactPerson: document.getElementById('new-client-contact').value.trim() || null,
        phone: document.getElementById('new-client-phone').value.trim() || null,
        email: document.getElementById('new-client-email').value.trim() || null,
        address: document.getElementById('new-client-address').value.trim() || null,
        city: document.getElementById('new-client-city').value.trim() || null,
        website: document.getElementById('new-client-website').value.trim() || null,
        notes: document.getElementById('new-client-notes').value.trim() || null,
        hasHosting
      };

      if (hasHosting) {
        payload.hostingPrice = parseFloat(document.getElementById('new-client-hosting-price').value) || 20;
        payload.hostingInterval = 'MONTHLY';
        payload.hostingStartDate = document.getElementById('new-client-hosting-start').value || null;
      }

      try {
        const client = await API.post('/clients', payload);
        closeModal('new-client-modal');
        showToast(`Klant "${client.companyName}" aangemaakt${hasHosting ? ' met hosting' : ''}`);
        loadClients();
      } catch (err) {
        showToast(err.message || 'Fout bij aanmaken klant', 'error');
      }
    }

    async function deleteClient(id, name) {
      if (!confirm(`Weet je zeker dat je "${name}" wilt verwijderen? Dit verwijdert ook de bijbehorende lead en deal.`)) return;
      try {
        await API.delete(`/clients/${id}`);
        closeModal('detail-modal');
        showToast(`Klant "${name}" verwijderd`);
        loadClients();
      } catch (err) {
        showToast(err.message || 'Fout bij verwijderen', 'error');
      }
    }

    init();
  </script>
</body>
</html>
