<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="icon" type="image/png" href="favicon.png">
  <title>Dashboard - Cold Outreach CRM</title>
  <link rel="stylesheet" href="assets/css/global.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
</head>
<body>
  <div class="app-layout">
    <aside class="sidebar" id="sidebar"></aside>
    <div class="main-content">
      <header class="topbar" id="topbar"></header>
      <main class="page-content" id="page-content">
        <div id="dashboard-reminders"></div>
        <div id="kpi-grid"></div>
        <div class="grid-2 mb-24" id="charts-row">
          <div class="dashboard-card">
            <div class="dashboard-card-header">
              <span class="dashboard-label">Lead Pipeline Funnel</span>
            </div>
            <div class="card-body" style="padding:0;"><canvas id="funnel-chart" height="260"></canvas></div>
          </div>
          <div class="dashboard-card">
            <div class="dashboard-card-header">
              <span class="dashboard-label">Klant Omzet over tijd</span>
            </div>
            <div class="card-body" style="padding:0;"><canvas id="revenue-chart" height="260"></canvas></div>
          </div>
        </div>
        <div class="dashboard-card mb-24">
          <div class="dashboard-card-header">
            <span class="dashboard-label">Statistieken per locatie</span>
          </div>
          <div class="card-body" style="padding:0;">
            <div class="grid-2" style="gap:24px;">
              <div>
                <canvas id="location-chart" height="300"></canvas>
              </div>
              <div id="location-table-container" style="max-height:400px;overflow-y:auto;"></div>
            </div>
          </div>
        </div>
        <div class="grid-2 mb-24">
          <div class="dashboard-card">
            <div class="dashboard-card-header">
              <span class="dashboard-label">Recente leads</span>
            </div>
            <div class="card-body" style="padding:0;" id="recent-leads"></div>
          </div>
          <div class="dashboard-card">
            <div class="dashboard-card-header">
              <span class="dashboard-label">Klant Financieel overzicht</span>
            </div>
            <div class="card-body" style="padding:0;" id="financial-summary"></div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="assets/js/config.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/components.js"></script>
  <script src="assets/js/sidebar.js"></script>
  <script>
    async function init() {
      if (!await requireLogin()) return;
      initSidebar();
      initTopbar('Dashboard');
      lucide.createIcons();
      loadDashboardReminders();
      loadDashboard();
    }

    async function loadDashboardReminders() {
      try {
        const reminders = await API.get('/calendar/reminders');
        const container = document.getElementById('dashboard-reminders');
        if (!reminders || reminders.length === 0) { container.innerHTML = ''; return; }

        container.innerHTML = `
          <div style="background:var(--bg-card);border:1px solid var(--accent-orange-dim);border-left:4px solid var(--accent-orange);border-radius:var(--radius);padding:16px 20px;margin-bottom:20px;">
            <div style="font-size:14px;font-weight:700;color:var(--accent-orange);margin-bottom:12px;display:flex;align-items:center;gap:8px;">
              <i data-lucide="bell-ring" style="width:18px;height:18px;"></i>
              ${reminders.length} afspraak${reminders.length > 1 ? 'en' : ''} binnenkort - stuur een herinnering!
            </div>
            ${reminders.map(r => {
              const time = new Date(r.startTime).toLocaleString('nl-BE', { weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
              const phone = r.lead?.phone || '';
              const company = r.lead?.companyName || r.title;
              return `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg-input);border-radius:var(--radius-sm);margin-bottom:8px;gap:12px;">
                  <div style="flex:1;">
                    <div style="font-weight:600;font-size:13px;">${company}</div>
                    <div style="font-size:12px;color:var(--text-muted);">${time}</div>
                    ${phone ? `<div style="font-size:12px;color:var(--accent-brand);font-weight:600;">${phone}</div>` : '<div style="font-size:12px;color:var(--accent-red);">Geen telefoonnummer</div>'}
                  </div>
                  <div style="display:flex;gap:6px;flex-shrink:0;">
                    ${phone ? `<a href="tel:${phone}" class="btn btn-primary btn-sm"><i data-lucide="phone" style="width:12px;height:12px;"></i> Bellen</a>` : ''}
                    <button class="btn btn-ghost btn-sm" onclick="markDashboardReminder('${r.id}')">Gedaan</button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
        lucide.createIcons();
      } catch (err) {
        console.error('Reminders error:', err);
      }
    }

    async function markDashboardReminder(id) {
      try {
        await API.post(`/calendar/reminders/${id}/sent`);
        showToast('Herinnering gemarkeerd als verstuurd');
        loadDashboardReminders();
      } catch (err) { showToast(err.message, 'error'); }
    }

    async function loadDashboard() {
      try {
        try { await API.post('/leads/auto-expire', { days: 7 }); } catch(e) {}

        const [dashboard, funnel, revenue, recentLeads, locations, hosting] = await Promise.all([
          API.get('/stats/dashboard'),
          API.get('/stats/funnel'),
          API.get('/stats/revenue'),
          API.get('/stats/recent-leads'),
          API.get('/stats/locations'),
          API.get('/stats/hosting')
        ]);

        renderHostingReminders(hosting);
        renderKPIs(dashboard);
        renderFunnelChart(funnel);
        renderRevenueChart(revenue);
        renderLocationStats(locations.all || locations);
        renderRecentLeads(recentLeads);
        renderFinancialSummary(dashboard, revenue);
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    function renderKPIs(data) {
      const c = data.current;
      const f = data.funnel;
      const conv = data.conversions;
      const grid = document.getElementById('kpi-grid');
      
      // Helper to create small sparkline charts
      setTimeout(() => {
        createSparkline('chart-leads', [12, 19, 15, 25, 22, 30, data.totalLeads], '#60a5fa');
        createSparkline('chart-sent', [c.NIEUW, c.VERSTUURD + c.GEEN_REACTIE], '#60a5fa');
        createSparkline('chart-response', [5, 8, 12, 15, c.GEREAGEERD + c.NIET_GEINTERESSEERD], '#fb923c');
        createSparkline('chart-interest', [1, 2, 3, 5, c.AFSPRAAK], '#a78bfa');
        createSparkline('chart-clients', [10, 15, 20, c.KLANT], '#34d399');
        createSparkline('chart-revenue', [1000, 5000, 8000, data.totalRevenue], '#34d399');
      }, 100);

      grid.innerHTML = `
        <div class="section-header" style="border-bottom:1px solid var(--border-color);margin-bottom:20px;padding-bottom:10px;">
          <span class="section-header-title" style="color:var(--text-primary);font-size:16px;">Lead Pipeline</span>
        </div>
        <div class="dashboard-kpi-grid">
          <div class="dashboard-card">
            <div class="dashboard-card-header">
              <span class="dashboard-label">Total Leads</span>
              <i data-lucide="users" style="color:var(--accent-blue);width:18px;height:18px;"></i>
            </div>
            <div class="dashboard-value">${data.totalLeads}</div>
            <div class="dashboard-subtext">
              <span style="color:var(--accent-blue);">+${c.NIEUW}</span>
              <span>nieuw toegevoegd</span>
            </div>
            <div class="dashboard-chart-container">
              <canvas id="chart-leads"></canvas>
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header">
              <span class="dashboard-label">Verstuurd</span>
              <i data-lucide="send" style="color:var(--accent-blue);width:18px;height:18px;"></i>
            </div>
            <div class="dashboard-value">${c.VERSTUURD + c.GEEN_REACTIE}</div>
            <div class="dashboard-subtext">
              <span>${conv.sendRate}% van totaal</span>
            </div>
            <div class="dashboard-chart-container">
              <canvas id="chart-sent"></canvas>
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header">
              <span class="dashboard-label">Reacties</span>
              <i data-lucide="message-square" style="color:var(--accent-orange);width:18px;height:18px;"></i>
            </div>
            <div class="dashboard-value">${c.GEREAGEERD + c.NIET_GEINTERESSEERD}</div>
            <div class="dashboard-subtext">
              <span style="color:var(--accent-orange);">${conv.responseRate}%</span>
              <span>reactieratio</span>
            </div>
            <div class="dashboard-chart-container">
              <canvas id="chart-response"></canvas>
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header">
              <span class="dashboard-label">Interesse</span>
              <i data-lucide="thumbs-up" style="color:var(--accent-purple);width:18px;height:18px;"></i>
            </div>
            <div class="dashboard-value">${c.AFSPRAAK}</div>
            <div class="dashboard-subtext">
              <span style="color:var(--accent-purple);">${conv.interestRate}%</span>
              <span>conversie</span>
            </div>
            <div class="dashboard-chart-container">
              <canvas id="chart-interest"></canvas>
            </div>
          </div>
        </div>

        <div class="section-header" style="border-bottom:1px solid var(--border-color);margin-bottom:20px;padding-bottom:10px;margin-top:40px;">
          <span class="section-header-title" style="color:var(--text-primary);font-size:16px;">Klanten & Omzet</span>
        </div>
        <div class="dashboard-kpi-grid" style="grid-template-columns:repeat(3,1fr);">
          <div class="dashboard-card">
            <div class="dashboard-card-header">
              <span class="dashboard-label">Klanten</span>
              <i data-lucide="building-2" style="color:var(--accent-green);width:18px;height:18px;"></i>
            </div>
            <div class="dashboard-value">${data.totalClients || c.KLANT}</div>
            <div class="dashboard-subtext">
              <span style="color:var(--accent-green);">${data.totalClients || c.KLANT}</span>
              <span>actieve klanten</span>
            </div>
            <div class="dashboard-chart-container">
              <canvas id="chart-clients"></canvas>
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header">
              <span class="dashboard-label">Totale Omzet</span>
              <i data-lucide="euro" style="color:var(--accent-green);width:18px;height:18px;"></i>
            </div>
            <div class="dashboard-value">${formatCurrency(data.totalRevenue)}</div>
            <div class="dashboard-subtext">
              <span>Lifetime value</span>
            </div>
            <div class="dashboard-chart-container">
              <canvas id="chart-revenue"></canvas>
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header">
              <span class="dashboard-label">Gem. Dealwaarde</span>
              <i data-lucide="trending-up" style="color:var(--accent-green);width:18px;height:18px;"></i>
            </div>
            <div class="dashboard-value">${formatCurrency(data.avgDealValue)}</div>
            <div class="dashboard-subtext">
              <span>Per klant</span>
            </div>
            <!-- Geen chart hier, layout vullen met extra info of leeg laten -->
            <div style="height:60px;display:flex;align-items:end;font-size:12px;color:var(--text-muted);">
              Gemiddelde acquisitiekost: ${formatCurrency(data.avgAcquisitionCost)}
            </div>
          </div>
        </div>
      `;
      lucide.createIcons();
    }

    function renderHostingReminders(hosting) {
      const container = document.getElementById('dashboard-reminders');
      if (!hosting || hosting.upcomingInvoices === 0) {
        container.innerHTML = '';
        return;
      }

      const upcomingClients = hosting.clients.filter(c => {
        if (!c.nextInvoiceDate) return false;
        const invoiceDate = new Date(c.nextInvoiceDate);
        const now = new Date();
        const in30Days = new Date();
        in30Days.setDate(in30Days.getDate() + 30);
        return invoiceDate > now && invoiceDate <= in30Days;
      });

      if (upcomingClients.length === 0) {
        container.innerHTML = '';
        return;
      }

      // Find the closest upcoming invoice
      const sortedClients = upcomingClients.sort((a, b) => new Date(a.nextInvoiceDate) - new Date(b.nextInvoiceDate));
      const closestClient = sortedClients[0];
      const closestDate = new Date(closestClient.nextInvoiceDate);
      const daysUntilClosest = Math.ceil((closestDate - new Date()) / (1000 * 60 * 60 * 24));
      
      container.innerHTML = `
        <div style="background:var(--bg-card);border:1px solid var(--accent-orange);border-left:4px solid var(--accent-orange);border-radius:var(--radius);padding:16px 20px;margin-bottom:20px;">
          <div style="font-size:14px;font-weight:700;color:var(--accent-orange);margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;">
            <div style="display:flex;align-items:center;gap:8px;">
              <i data-lucide="alert-circle" style="width:18px;height:18px;"></i>
              ${upcomingClients.length} klant${upcomingClients.length > 1 ? 'en' : ''} ${upcomingClients.length === 1 ? 'moet' : 'moeten'} gefactureerd worden ${daysUntilClosest === 0 ? 'vandaag' : daysUntilClosest === 1 ? 'morgen' : `binnen ${daysUntilClosest} dagen`}
            </div>
            <a href="hosting.html" class="btn btn-sm btn-ghost" style="color:var(--accent-orange);border-color:var(--accent-orange);">
              <i data-lucide="arrow-right" style="width:14px;height:14px;"></i>
              Naar hosting
            </a>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            ${sortedClients.slice(0, 5).map(c => {
              const invoiceDate = new Date(c.nextInvoiceDate);
              const now = new Date();
              now.setHours(0, 0, 0, 0);
              const invDate = new Date(invoiceDate);
              invDate.setHours(0, 0, 0, 0);
              const daysUntil = Math.ceil((invDate - now) / (1000 * 60 * 60 * 24));
              return `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg-input);border-radius:var(--radius-sm);gap:12px;">
                  <div style="flex:1;">
                    <div style="font-weight:600;font-size:13px;color:var(--text-primary);">${c.companyName}</div>
                    <div style="font-size:12px;color:var(--text-muted);">${c.city || 'Geen locatie'} â€¢ ${formatCurrency(c.hostingPrice)}/${c.hostingInterval === 'MONTHLY' ? 'mnd' : 'jaar'}</div>
                  </div>
                  <div style="text-align:right;">
                    <div style="font-size:12px;font-weight:600;color:var(--accent-orange);">${daysUntil === 0 ? 'Vandaag' : daysUntil === 1 ? 'Morgen' : `${daysUntil} dag${daysUntil === 1 ? '' : 'en'}`}</div>
                    <div style="font-size:11px;color:var(--text-muted);">${invoiceDate.toLocaleDateString('nl-BE', { day: 'numeric', month: 'short' })}</div>
                  </div>
                </div>
              `;
            }).join('')}
            ${upcomingClients.length > 5 ? `<div style="font-size:12px;color:var(--text-muted);text-align:center;padding:8px;">+ ${upcomingClients.length - 5} meer</div>` : ''}
          </div>
        </div>
      `;
      lucide.createIcons();
    }

    function createSparkline(id, dataPoints, color) {
      const ctx = document.getElementById(id);
      if(!ctx) return;
      new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels: dataPoints.map((_, i) => i),
          datasets: [{
            data: dataPoints,
            borderColor: color,
            borderWidth: 2,
            tension: 0.4,
            pointRadius: 0,
            pointHoverRadius: 4,
            pointHoverBackgroundColor: color,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { display: false }, 
            tooltip: { 
              enabled: true,
              backgroundColor: '#111111',
              borderColor: 'rgba(255,255,255,0.1)',
              borderWidth: 1,
              titleColor: '#f0f0f0',
              bodyColor: color,
              displayColors: false,
              padding: 8,
              cornerRadius: 6,
              callbacks: {
                title: () => '',
                label: (context) => context.parsed.y.toString()
              }
            } 
          },
          scales: {
            x: { display: false },
            y: { display: false }
          },
          layout: { padding: 0 }
        }
      });
    }

    function renderFunnelChart(data) {
      const ctx = document.getElementById('funnel-chart').getContext('2d');
      const labels = data.funnel.map(f => STATUS_LABELS[f.status] || f.status);
      const values = data.funnel.map(f => f.count);
      const colors = [
        'rgba(107, 114, 128, 0.8)',
        'rgba(96, 165, 250, 0.8)',
        'rgba(251, 146, 60, 0.8)',
        'rgba(34, 211, 238, 0.8)',
        'rgba(167, 139, 250, 0.8)',
        'rgba(59, 130, 246, 0.8)',
        'rgba(248, 113, 113, 0.8)'
      ];
      const borderColors = ['#6B7280', '#60A5FA', '#FB923C', '#22D3EE', '#A78BFA', '#3B82F6', '#F87171'];

      const totalLeads = values.reduce((a, b) => a + b, 0);
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: colors,
            borderColor: borderColors,
            borderWidth: 1,
            borderRadius: 8,
            borderSkipped: false,
            barThickness: 28
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#111111',
              borderColor: 'rgba(255,255,255,0.1)',
              borderWidth: 1,
              titleColor: '#f0f0f0',
              bodyColor: '#a0a0a0',
              cornerRadius: 8,
              padding: 12,
              callbacks: {
                label: (context) => {
                  const value = context.parsed.x;
                  const percentage = totalLeads > 0 ? ((value / totalLeads) * 100).toFixed(1) : 0;
                  return [
                    `Aantal: ${value} leads`,
                    `Percentage: ${percentage}% van totaal`,
                    `Totaal: ${totalLeads} leads`
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)', drawBorder: false },
              ticks: { color: '#94a3b8', font: { size: 11 } }
            },
            y: {
              grid: { display: false },
              ticks: { color: '#cbd5e1', font: { size: 12, weight: 500 } }
            }
          }
        }
      });
    }

    function renderRevenueChart(data) {
      const ctx = document.getElementById('revenue-chart').getContext('2d');
      const months = data.monthlyRevenue.map(m => m.month);
      const values = data.monthlyRevenue.map(m => m.revenue);

      const gradient = ctx.createLinearGradient(0, 0, 0, 260);
      gradient.addColorStop(0, 'rgba(52, 211, 153, 0.25)');
      gradient.addColorStop(1, 'rgba(52, 211, 153, 0)');

      const totalRevenue = values.reduce((a, b) => a + b, 0);
      const avgRevenue = totalRevenue / values.length;
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [{
            label: 'Omzet',
            data: values,
            borderColor: '#34d399',
            backgroundColor: gradient,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: '#34d399',
            pointBorderColor: '#111111',
            pointBorderWidth: 2,
            borderWidth: 2.5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#111111',
              borderColor: 'rgba(255,255,255,0.1)',
              borderWidth: 1,
              titleColor: '#f0f0f0',
              bodyColor: '#34d399',
              cornerRadius: 8,
              padding: 12,
              callbacks: {
                label: (context) => {
                  const value = context.parsed.y;
                  const percentage = totalRevenue > 0 ? ((value / totalRevenue) * 100).toFixed(1) : 0;
                  const diff = value - avgRevenue;
                  const diffText = diff >= 0 ? `+${formatCurrency(diff)}` : formatCurrency(diff);
                  return [
                    `Omzet: ${formatCurrency(value)}`,
                    `${percentage}% van totaal`,
                    `${diffText} vs gemiddelde`,
                    `Gem: ${formatCurrency(avgRevenue)}`
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)', drawBorder: false },
              ticks: { color: '#94a3b8', font: { size: 11 } }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.05)', drawBorder: false },
              ticks: {
                color: '#94a3b8',
                font: { size: 11 },
                callback: v => formatCurrency(v)
              }
            }
          }
        }
      });
    }

    function renderLocationStats(locations) {
      const topLocations = locations.slice(0, 10);
      
      const ctx = document.getElementById('location-chart').getContext('2d');
      const cities = topLocations.map(l => l.city);
      const totals = topLocations.map(l => l.total);
      const verstuurd = topLocations.map(l => l.verstuurd);
      const gereageerd = topLocations.map(l => l.gereageerd);
      const klanten = topLocations.map(l => l.klanten);

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: cities,
          datasets: [
            {
              label: 'Totaal leads',
              data: totals,
              backgroundColor: 'rgba(107, 114, 128, 0.6)',
              borderColor: 'rgba(107, 114, 128, 0.8)',
              borderWidth: 1,
              borderRadius: 6
            },
            {
              label: 'Verstuurd',
              data: verstuurd,
              backgroundColor: 'rgba(96, 165, 250, 0.6)',
              borderColor: 'rgba(96, 165, 250, 0.8)',
              borderWidth: 1,
              borderRadius: 6
            },
            {
              label: 'Gereageerd',
              data: gereageerd,
              backgroundColor: 'rgba(251, 146, 60, 0.6)',
              borderColor: 'rgba(251, 146, 60, 0.8)',
              borderWidth: 1,
              borderRadius: 6
            },
            {
              label: 'Klanten',
              data: klanten,
              backgroundColor: 'rgba(52, 211, 153, 0.6)',
              borderColor: 'rgba(52, 211, 153, 0.8)',
              borderWidth: 1,
              borderRadius: 6
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: { color: '#94a3b8', font: { size: 11 }, boxWidth: 12, padding: 16 }
            },
            tooltip: {
              backgroundColor: '#111111',
              borderColor: 'rgba(255,255,255,0.1)',
              borderWidth: 1,
              titleColor: '#f0f0f0',
              bodyColor: '#a0a0a0',
              cornerRadius: 8,
              padding: 12,
              callbacks: {
                label: (context) => {
                  const datasetLabel = context.dataset.label;
                  const value = context.parsed.y;
                  const city = context.label;
                  const dataIndex = context.dataIndex;
                  
                  // Get all values for this city
                  const allDatasets = context.chart.data.datasets;
                  const totaal = allDatasets[0].data[dataIndex];
                  const verstuurd = allDatasets[1].data[dataIndex];
                  const gereageerd = allDatasets[2].data[dataIndex];
                  const klanten = allDatasets[3].data[dataIndex];
                  
                  const responseRate = verstuurd > 0 ? ((gereageerd / verstuurd) * 100).toFixed(1) : 0;
                  const conversionRate = gereageerd > 0 ? ((klanten / gereageerd) * 100).toFixed(1) : 0;
                  
                  return [
                    `${datasetLabel}: ${value}`,
                    `Reactieratio: ${responseRate}%`,
                    `Conversie: ${conversionRate}%`
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: '#94a3b8', font: { size: 10 } }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.05)', drawBorder: false },
              ticks: { color: '#94a3b8' }
            }
          }
        }
      });

      const tableContainer = document.getElementById('location-table-container');
      if (locations.length === 0) {
        tableContainer.innerHTML = '<div class="empty-state"><div class="empty-state-text">Nog geen locatie data</div></div>';
        return;
      }

      tableContainer.innerHTML = `
        <table class="data-table" style="font-size:12px;">
          <thead>
            <tr>
              <th>Gemeente</th>
              <th style="text-align:right;">Totaal</th>
              <th style="text-align:right;">Verstuurd</th>
              <th style="text-align:right;">Reactie</th>
              <th style="text-align:right;">Klanten</th>
              <th style="text-align:right;">Omzet</th>
            </tr>
          </thead>
          <tbody>
            ${locations.map(loc => `
              <tr>
                <td style="font-weight:600;">${loc.city}</td>
                <td style="text-align:right;">${loc.total}</td>
                <td style="text-align:right;">${loc.verstuurd}</td>
                <td style="text-align:right;">
                  ${loc.gereageerd}
                  <span style="color:var(--text-muted);font-size:11px;">(${loc.responseRate}%)</span>
                </td>
                <td style="text-align:right;">
                  ${loc.klanten}
                  <span style="color:var(--text-muted);font-size:11px;">(${loc.conversionRate}%)</span>
                </td>
                <td style="text-align:right;font-weight:600;color:var(--accent-green);">
                  ${loc.revenue > 0 ? formatCurrency(loc.revenue) : '-'}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderRecentLeads(leads) {
      const container = document.getElementById('recent-leads');
      if (leads.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-title">Geen leads</div><div class="empty-state-text">Importeer leads om te beginnen</div></div>';
        return;
      }

      container.innerHTML = `
        <table class="data-table">
          <thead><tr><th>Bedrijf</th><th>Gemeente</th><th>Status</th><th>Datum</th></tr></thead>
          <tbody>
            ${leads.map(l => `
              <tr>
                <td>${l.companyName}</td>
                <td>${l.city || '-'}</td>
                <td>${statusBadge(l.status)}</td>
                <td>${formatDate(l.createdAt)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderFinancialSummary(dashboard, revenue) {
      const container = document.getElementById('financial-summary');
      container.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:14px;">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:rgba(52,211,153,0.1);border-radius:8px;border-left:3px solid #34d399;">
            <span style="color:var(--text-muted);font-size:13px;">Totale omzet</span>
            <span style="font-weight:800;font-size:18px;color:#34d399;">${formatCurrency(dashboard.totalRevenue)}</span>
          </div>
          <div class="flex justify-between items-center" style="padding:0 4px;">
            <span style="color:var(--text-muted);font-size:13px;">Gem. dealwaarde</span>
            <span style="font-weight:600;font-size:14px;color:var(--text-primary);">${formatCurrency(dashboard.avgDealValue)}</span>
          </div>
          <div class="flex justify-between items-center" style="padding:0 4px;">
            <span style="color:var(--text-muted);font-size:13px;">Gem. acquisitiekost</span>
            <span style="font-weight:600;font-size:14px;color:var(--text-primary);">${formatCurrency(dashboard.avgAcquisitionCost)}</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:rgba(52,211,153,0.1);border-radius:8px;border-left:3px solid #34d399;">
            <span style="color:var(--text-muted);font-size:13px;">ROI</span>
            <span style="font-weight:800;font-size:18px;color:#34d399;">${revenue.roi}%</span>
          </div>
          <hr style="border-color:var(--border-color);margin:4px 0;">
          <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">Omzet per pakket</div>
          ${revenue.packageRevenue.length > 0 ? revenue.packageRevenue.map(p => `
            <div class="flex justify-between items-center" style="padding:0 4px;">
              <span style="font-size:13px;color:var(--text-muted);">${p.name}</span>
              <span style="font-weight:600;font-size:13px;color:var(--text-primary);">${formatCurrency(p.revenue)}</span>
            </div>
          `).join('') : '<span style="font-size:13px;color:var(--text-muted);">Nog geen deals</span>'}
        </div>
      `;
    }

    init();
  </script>
</body>
</html>
