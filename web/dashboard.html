<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="favicon.png">
  <title>Dashboard - Cold Outreach CRM</title>
  <link rel="stylesheet" href="assets/css/global.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
</head>
<body>
  <div class="app-layout">
    <aside class="sidebar" id="sidebar"></aside>
    <div class="main-content">
      <header class="topbar" id="topbar"></header>
      <main class="page-content" id="page-content">
        <div id="dashboard-reminders"></div>
        <div class="kpi-grid" id="kpi-grid"></div>
        <div class="grid-2 mb-24" id="charts-row">
          <div class="card">
            <div class="card-header"><span class="card-title">Pipeline Funnel</span></div>
            <div class="card-body"><canvas id="funnel-chart" height="260"></canvas></div>
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">Omzet over tijd</span></div>
            <div class="card-body"><canvas id="revenue-chart" height="260"></canvas></div>
          </div>
        </div>
        <div class="card mb-24">
          <div class="card-header">
            <span class="card-title">Statistieken per locatie</span>
          </div>
          <div class="card-body">
            <div class="grid-2" style="gap:24px;">
              <div>
                <canvas id="location-chart" height="300"></canvas>
              </div>
              <div id="location-table-container" style="max-height:400px;overflow-y:auto;"></div>
            </div>
          </div>
        </div>
        <div class="grid-2 mb-24">
          <div class="card">
            <div class="card-header"><span class="card-title">Recente leads</span></div>
            <div class="card-body" id="recent-leads"></div>
          </div>
          <div class="card">
            <div class="card-header"><span class="card-title">Financieel overzicht</span></div>
            <div class="card-body" id="financial-summary"></div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="assets/js/config.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/components.js"></script>
  <script src="assets/js/sidebar.js"></script>
  <script>
    async function init() {
      if (!await requireLogin()) return;
      initSidebar();
      initTopbar('Dashboard');
      lucide.createIcons();
      loadDashboardReminders();
      loadDashboard();
    }

    async function loadDashboardReminders() {
      try {
        const reminders = await API.get('/calendar/reminders');
        const container = document.getElementById('dashboard-reminders');
        if (!reminders || reminders.length === 0) { container.innerHTML = ''; return; }

        container.innerHTML = `
          <div style="background:var(--bg-card);border:1px solid var(--accent-orange-dim);border-left:4px solid var(--accent-orange);border-radius:var(--radius);padding:16px 20px;margin-bottom:20px;">
            <div style="font-size:14px;font-weight:700;color:var(--accent-orange);margin-bottom:12px;display:flex;align-items:center;gap:8px;">
              <i data-lucide="bell-ring" style="width:18px;height:18px;"></i>
              ${reminders.length} afspraak${reminders.length > 1 ? 'en' : ''} binnenkort - stuur een herinnering!
            </div>
            ${reminders.map(r => {
              const time = new Date(r.startTime).toLocaleString('nl-BE', { weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
              const phone = r.lead?.phone || '';
              const company = r.lead?.companyName || r.title;
              return `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg-input);border-radius:var(--radius-sm);margin-bottom:8px;gap:12px;">
                  <div style="flex:1;">
                    <div style="font-weight:600;font-size:13px;">${company}</div>
                    <div style="font-size:12px;color:var(--text-muted);">${time}</div>
                    ${phone ? `<div style="font-size:12px;color:var(--accent-brand);font-weight:600;">${phone}</div>` : '<div style="font-size:12px;color:var(--accent-red);">Geen telefoonnummer</div>'}
                  </div>
                  <div style="display:flex;gap:6px;flex-shrink:0;">
                    ${phone ? `<a href="tel:${phone}" class="btn btn-primary btn-sm"><i data-lucide="phone" style="width:12px;height:12px;"></i> Bellen</a>` : ''}
                    <button class="btn btn-ghost btn-sm" onclick="markDashboardReminder('${r.id}')">Gedaan</button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
        lucide.createIcons();
      } catch (err) {
        console.error('Reminders error:', err);
      }
    }

    async function markDashboardReminder(id) {
      try {
        await API.post(`/calendar/reminders/${id}/sent`);
        showToast('Herinnering gemarkeerd als verstuurd');
        loadDashboardReminders();
      } catch (err) { showToast(err.message, 'error'); }
    }

    async function loadDashboard() {
      try {
        try { await API.post('/leads/auto-expire', { days: 7 }); } catch(e) {}

        const [dashboard, funnel, revenue, recentLeads, locations] = await Promise.all([
          API.get('/stats/dashboard'),
          API.get('/stats/funnel'),
          API.get('/stats/revenue'),
          API.get('/stats/recent-leads'),
          API.get('/stats/locations')
        ]);

        renderKPIs(dashboard);
        renderFunnelChart(funnel);
        renderRevenueChart(revenue);
        renderLocationStats(locations);
        renderRecentLeads(recentLeads);
        renderFinancialSummary(dashboard, revenue);
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    function renderKPIs(data) {
      const c = data.current;
      const f = data.funnel;
      const conv = data.conversions;
      const grid = document.getElementById('kpi-grid');
      grid.innerHTML = `
        <div class="kpi-card">
          <div class="kpi-label">Totaal leads</div>
          <div class="kpi-value">${data.totalLeads}</div>
          <span class="kpi-badge neutral">${c.NIEUW} nieuw</span>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Verstuurd</div>
          <div class="kpi-value">${c.VERSTUURD + c.GEEN_REACTIE}</div>
          <span class="kpi-badge neutral">${conv.sendRate}% van totaal (${f.verstuurd} door funnel)</span>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Gereageerd</div>
          <div class="kpi-value">${c.GEREAGEERD + c.NIET_GEINTERESSEERD}</div>
          <span class="kpi-badge positive">${conv.responseRate}% reactieratio (${f.gereageerd} door funnel)</span>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Interesse</div>
          <div class="kpi-value">${c.AFSPRAAK}</div>
          <span class="kpi-badge positive">${conv.interestRate}% van reacties (${f.interesse} door funnel)</span>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Klanten</div>
          <div class="kpi-value">${c.KLANT}</div>
          <span class="kpi-badge positive">${conv.closeRate}% close ratio</span>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Totale omzet</div>
          <div class="kpi-value">${formatCurrency(data.totalRevenue)}</div>
          <span class="kpi-badge positive">Omzet</span>
        </div>
      `;
    }

    function renderFunnelChart(data) {
      const ctx = document.getElementById('funnel-chart').getContext('2d');
      const labels = data.funnel.map(f => STATUS_LABELS[f.status] || f.status);
      const values = data.funnel.map(f => f.count);
      const colors = ['#6B7280', '#60A5FA', '#FB923C', '#22D3EE', '#A78BFA', '#3B82F6', '#F87171'];

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: colors,
            borderRadius: 6,
            borderSkipped: false
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#9CA3AF' }
            },
            y: {
              grid: { display: false },
              ticks: { color: '#9CA3AF', font: { size: 12 } }
            }
          }
        }
      });
    }

    function renderRevenueChart(data) {
      const ctx = document.getElementById('revenue-chart').getContext('2d');
      const months = data.monthlyRevenue.map(m => m.month);
      const values = data.monthlyRevenue.map(m => m.revenue);

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [{
            label: 'Omzet',
            data: values,
            borderColor: '#3B82F6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: '#3B82F6'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: {
              grid: { color: 'rgba(100, 160, 255, 0.05)' },
              ticks: { color: '#94A3B8' }
            },
            y: {
              grid: { color: 'rgba(100, 160, 255, 0.05)' },
              ticks: {
                color: '#94A3B8',
                callback: v => formatCurrency(v)
              }
            }
          }
        }
      });
    }

    function renderLocationStats(locations) {
      const topLocations = locations.slice(0, 10);
      
      const ctx = document.getElementById('location-chart').getContext('2d');
      const cities = topLocations.map(l => l.city);
      const totals = topLocations.map(l => l.total);
      const verstuurd = topLocations.map(l => l.verstuurd);
      const gereageerd = topLocations.map(l => l.gereageerd);
      const klanten = topLocations.map(l => l.klanten);

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: cities,
          datasets: [
            {
              label: 'Totaal leads',
              data: totals,
              backgroundColor: 'rgba(107, 114, 128, 0.8)',
              borderRadius: 4
            },
            {
              label: 'Verstuurd',
              data: verstuurd,
              backgroundColor: 'rgba(96, 165, 250, 0.8)',
              borderRadius: 4
            },
            {
              label: 'Gereageerd',
              data: gereageerd,
              backgroundColor: 'rgba(251, 146, 60, 0.8)',
              borderRadius: 4
            },
            {
              label: 'Klanten',
              data: klanten,
              backgroundColor: 'rgba(34, 197, 94, 0.8)',
              borderRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: { color: '#9CA3AF', font: { size: 11 } }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: '#9CA3AF', font: { size: 10 } }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#9CA3AF' }
            }
          }
        }
      });

      const tableContainer = document.getElementById('location-table-container');
      if (locations.length === 0) {
        tableContainer.innerHTML = '<div class="empty-state"><div class="empty-state-text">Nog geen locatie data</div></div>';
        return;
      }

      tableContainer.innerHTML = `
        <table class="data-table" style="font-size:12px;">
          <thead>
            <tr>
              <th>Gemeente</th>
              <th style="text-align:right;">Totaal</th>
              <th style="text-align:right;">Verstuurd</th>
              <th style="text-align:right;">Reactie</th>
              <th style="text-align:right;">Klanten</th>
              <th style="text-align:right;">Omzet</th>
            </tr>
          </thead>
          <tbody>
            ${locations.map(loc => `
              <tr>
                <td style="font-weight:600;">${loc.city}</td>
                <td style="text-align:right;">${loc.total}</td>
                <td style="text-align:right;">${loc.verstuurd}</td>
                <td style="text-align:right;">
                  ${loc.gereageerd}
                  <span style="color:var(--text-muted);font-size:11px;">(${loc.responseRate}%)</span>
                </td>
                <td style="text-align:right;">
                  ${loc.klanten}
                  <span style="color:var(--text-muted);font-size:11px;">(${loc.conversionRate}%)</span>
                </td>
                <td style="text-align:right;font-weight:600;color:var(--accent-green);">
                  ${loc.revenue > 0 ? formatCurrency(loc.revenue) : '-'}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderRecentLeads(leads) {
      const container = document.getElementById('recent-leads');
      if (leads.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-title">Geen leads</div><div class="empty-state-text">Importeer leads om te beginnen</div></div>';
        return;
      }

      container.innerHTML = `
        <table class="data-table">
          <thead><tr><th>Bedrijf</th><th>Gemeente</th><th>Status</th><th>Datum</th></tr></thead>
          <tbody>
            ${leads.map(l => `
              <tr>
                <td>${l.companyName}</td>
                <td>${l.city || '-'}</td>
                <td>${statusBadge(l.status)}</td>
                <td>${formatDate(l.createdAt)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderFinancialSummary(dashboard, revenue) {
      const container = document.getElementById('financial-summary');
      container.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:16px;">
          <div class="flex justify-between items-center">
            <span class="text-muted">Totale omzet</span>
            <span style="font-weight:700;font-size:16px;" class="text-green">${formatCurrency(dashboard.totalRevenue)}</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-muted">Gem. dealwaarde</span>
            <span style="font-weight:600;">${formatCurrency(dashboard.avgDealValue)}</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-muted">Gem. acquisitiekost</span>
            <span style="font-weight:600;">${formatCurrency(dashboard.avgAcquisitionCost)}</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-muted">ROI</span>
            <span style="font-weight:700;font-size:16px;" class="text-green">${revenue.roi}%</span>
          </div>
          <hr style="border-color:var(--border-color);">
          <div style="font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:4px;">Omzet per pakket</div>
          ${revenue.packageRevenue.length > 0 ? revenue.packageRevenue.map(p => `
            <div class="flex justify-between items-center">
              <span style="font-size:13px;">${p.name}</span>
              <span style="font-weight:600;font-size:13px;">${formatCurrency(p.revenue)}</span>
            </div>
          `).join('') : '<span class="text-muted" style="font-size:13px;">Nog geen deals</span>'}
        </div>
      `;
    }

    init();
  </script>
</body>
</html>
