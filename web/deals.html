<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="icon" type="image/png" href="favicon.png">
  <title>Deals - Cold Outreach CRM</title>
  <link rel="stylesheet" href="assets/css/global.css">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <div class="app-layout">
    <aside class="sidebar" id="sidebar"></aside>
    <div class="main-content">
      <header class="topbar" id="topbar"></header>
      <main class="page-content">
        <div class="toolbar">
          <div class="toolbar-left">
            <div class="topbar-search">
              <i data-lucide="search"></i>
              <input type="text" placeholder="Zoek deals..." id="search-input">
            </div>
          </div>
          <div class="toolbar-right">
            <button class="btn btn-primary" onclick="openNewDealModal()">
              <i data-lucide="plus"></i> Nieuwe deal
            </button>
          </div>
        </div>

        <div class="card" style="border-top:2px solid #34d399;">
          <div class="card-body" style="padding:0;">
            <table class="data-table" id="deals-table">
              <thead>
                <tr>
                  <th>Bedrijfsnaam</th>
                  <th>Herkomst</th>
                  <th>Pakket</th>
                  <th>Upsells</th>
                  <th>Eenmalig</th>
                  <th>Maandelijks</th>
                  <th>Acquisitiekost</th>
                  <th>Dealwaarde</th>
                  <th>Datum</th>
                  <th>Acties</th>
                </tr>
              </thead>
              <tbody id="deals-body"></tbody>
            </table>
          </div>
        </div>
        <div id="pagination"></div>
      </main>
    </div>
  </div>

  <!-- New/Edit Deal Modal - Wizard -->
  <div class="modal-overlay" id="deal-modal">
    <div class="modal" style="max-width:700px;">
      <div class="modal-header">
        <span class="modal-title" id="deal-modal-title">Nieuwe deal</span>
        <button class="modal-close" onclick="closeModal('deal-modal')"><i data-lucide="x"></i></button>
      </div>
      
      <!-- Progress Bar -->
      <div class="wizard-progress">
        <div class="wizard-progress-bar" id="wizard-progress-bar"></div>
      </div>
      
      <div class="modal-body">
        <!-- Step 1: Basis deal info -->
        <div class="wizard-step" id="wizard-step-1">
          <h3 class="wizard-step-title">Basis deal informatie</h3>
          <div class="form-group">
            <label class="form-label">Lead (bedrijf)</label>
            <div style="position:relative;">
              <input type="text" class="form-input" id="deal-lead-search" placeholder="Zoek bedrijf..." autocomplete="off">
              <input type="hidden" id="deal-lead" value="">
              <div id="lead-suggestions" class="suggestions-dropdown" style="display:none;"></div>
            </div>
            <button type="button" class="btn btn-secondary" onclick="openNewLeadModal()" style="margin-top:8px;width:100%;">
              <i data-lucide="plus" style="width:16px;height:16px;"></i>
              <span>Nieuwe lead toevoegen</span>
            </button>
          </div>
          <div class="form-group">
            <label class="form-label">Pakket</label>
            <select class="form-select" id="deal-package"></select>
          </div>
          <div class="form-group">
            <label class="form-label">Upsells</label>
            <div id="deal-upsells"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Korting (optioneel)</label>
            <div class="radio-group" style="margin-bottom:8px;">
              <label class="radio-label">
                <input type="radio" name="discount-type" value="none" checked onchange="updateDiscountUI()">
                <span>Geen korting</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="discount-type" value="percentage" onchange="updateDiscountUI()">
                <span>Percentage</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="discount-type" value="fixed" onchange="updateDiscountUI()">
                <span>Vast bedrag</span>
              </label>
            </div>
            <div id="discount-percentage-group" style="display:none;">
              <div style="display:flex;gap:8px;align-items:center;">
                <input type="number" class="form-input" id="deal-discount-percentage" placeholder="0" step="0.1" min="0" max="100" onchange="updateCalculation()" style="flex:1;">
                <span style="color:var(--text-muted);font-size:14px;">%</span>
              </div>
            </div>
            <div id="discount-fixed-group" style="display:none;">
              <input type="number" class="form-input" id="deal-discount-fixed" placeholder="0.00" step="0.01" min="0" onchange="updateCalculation()">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Acquisitiekost</label>
            <div class="radio-group" style="margin-bottom:8px;">
              <label class="radio-label">
                <input type="radio" name="acquisition-type" value="none" onchange="updateAcquisitionUI()">
                <span>Geen acquisitiekost</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="acquisition-type" value="flyer" onchange="updateAcquisitionUI()">
                <span>Flyer actie</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="acquisition-type" value="manual" checked onchange="updateAcquisitionUI()">
                <span>Handmatig bedrag</span>
              </label>
            </div>
            <div id="flyer-cost-group" style="display:none;">
              <div style="display:flex;gap:8px;align-items:center;">
                <input type="number" class="form-input" id="deal-flyer-rate" placeholder="Vast tarief per flyer" step="0.01" min="0" style="flex:1;" value="">
                <button type="button" class="btn btn-ghost btn-sm" onclick="saveFlyerRate()" title="Sla tarief op als standaard" style="white-space:nowrap;">Bewaar tarief</button>
              </div>
              <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Dit tarief wordt onthouden voor volgende deals</div>
            </div>
            <div id="manual-cost-group">
              <input type="number" class="form-input" id="deal-cost" placeholder="0.00" step="0.01" min="0">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Hosting</label>
            <div class="radio-group" style="margin-bottom:8px;">
              <label class="radio-label">
                <input type="radio" name="has-hosting" value="true" checked onchange="updateHostingUI()">
                <span>Klant neemt hosting af</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="has-hosting" value="false" onchange="updateHostingUI()">
                <span>Geen hosting</span>
              </label>
            </div>
            <div id="hosting-details">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                <div>
                  <label class="form-label" style="font-size:11px;">Hosting prijs</label>
                  <input type="number" class="form-input" id="deal-hosting-price" value="20" step="0.01" min="0" onchange="updateCalculation()">
                </div>
                <div>
                  <label class="form-label" style="font-size:11px;">Interval</label>
                  <select class="form-select" id="deal-hosting-interval" onchange="updateCalculation()">
                    <option value="MONTHLY">Maandelijks</option>
                    <option value="YEARLY">Jaarlijks</option>
                  </select>
                </div>
                <div>
                  <label class="form-label" style="font-size:11px;">Startdatum hosting</label>
                  <input type="date" class="form-input" id="deal-hosting-start">
                </div>
                <div>
                  <label class="form-label" style="font-size:11px;">Einddatum (optioneel)</label>
                  <input type="date" class="form-input" id="deal-hosting-end">
                </div>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Datum verkoop</label>
            <input type="date" class="form-input" id="deal-date">
          </div>
          <div class="card" style="margin-top:16px;">
            <div class="card-body">
              <div style="font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px;">Berekening</div>
              <div id="deal-calculation" style="font-size:13px;"></div>
            </div>
          </div>
        </div>

        <!-- Step 2: Website doelen en context -->
        <div class="wizard-step" id="wizard-step-2" style="display:none;">
          <h3 class="wizard-step-title">Website doelen & context</h3>
          <div class="form-group">
            <label class="form-label">Wat is het hoofddoel van de website?</label>
            <select class="form-select" id="deal-website-goal">
              <option value="">Selecteer doel...</option>
              <option value="leads">Leads genereren</option>
              <option value="sales">Online verkopen</option>
              <option value="branding">Merkbekendheid</option>
              <option value="info">Informatievoorziening</option>
              <option value="portfolio">Portfolio tonen</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Wie is de doelgroep?</label>
            <input type="text" class="form-input" id="deal-target-audience" placeholder="B2B, particulieren, jongeren, etc.">
          </div>
          <div class="form-group">
            <label class="form-label">Heeft de klant al een website?</label>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="has-existing" value="false" checked>
                <span>Nee, volledig nieuw</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="has-existing" value="true">
                <span>Ja, bestaande website</span>
              </label>
            </div>
          </div>
          <div class="form-group" id="existing-url-group" style="display:none;">
            <label class="form-label">URL bestaande website</label>
            <input type="url" class="form-input" id="deal-existing-url" placeholder="https://...">
          </div>
        </div>

        <!-- Step 3: Design & visuele identiteit -->
        <div class="wizard-step" id="wizard-step-3" style="display:none;">
          <h3 class="wizard-step-title">Design & visuele identiteit</h3>
          <div class="form-group">
            <label class="form-label">Welke sfeer/mood past bij het merk?</label>
            <select class="form-select" id="deal-mood">
              <option value="">Selecteer sfeer...</option>
              <option value="modern-minimalistisch">Modern & minimalistisch</option>
              <option value="professioneel-zakelijk">Professioneel & zakelijk</option>
              <option value="creatief-speels">Creatief & speels</option>
              <option value="luxe-premium">Luxe & premium</option>
              <option value="warm-toegankelijk">Warm & toegankelijk</option>
              <option value="stoer-industrieel">Stoer & industrieel</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Wat voor hero sectie heeft voorkeur?</label>
            <select class="form-select" id="deal-hero-type">
              <option value="">Selecteer hero type...</option>
              <option value="foto-groot">Grote foto/visual</option>
              <option value="video-achtergrond">Video achtergrond</option>
              <option value="illustratie">Illustratie/grafisch</option>
              <option value="minimaal-tekst">Minimaal met focus op tekst</option>
              <option value="product-showcase">Product showcase</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Tone of voice</label>
            <select class="form-select" id="deal-tone">
              <option value="">Selecteer tone...</option>
              <option value="formeel">Formeel & professioneel</option>
              <option value="vriendelijk">Vriendelijk & persoonlijk</option>
              <option value="direct">Direct & to-the-point</option>
              <option value="inspirerend">Inspirerend & motiverend</option>
              <option value="humoristisch">Humoristisch & luchtig</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Referentie websites (die ze mooi vinden / concurrenten)</label>
            <textarea class="form-input" id="deal-reference-urls" rows="3" placeholder="EÃ©n URL per regel, bijv:&#10;https://www.voorbeeld.be&#10;https://www.concurrent.be"></textarea>
            <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Websites die de klant mooi vindt of van concurrenten ter inspiratie</div>
          </div>
        </div>

        <!-- Step 4: Strategie & content -->
        <div class="wizard-step" id="wizard-step-4" style="display:none;">
          <h3 class="wizard-step-title">Strategie & content</h3>
          <div class="form-group">
            <label class="form-label">Belangrijkste USP's (unieke verkooppunten)</label>
            <textarea class="form-input" id="deal-usps" rows="3" placeholder="Bijv: 24/7 service, 20 jaar ervaring, gratis verzending..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Primaire call-to-action</label>
            <input type="text" class="form-input" id="deal-cta" placeholder="Bijv: Vraag offerte aan, Bestel nu, Plan gesprek...">
          </div>
          <div class="form-group">
            <label class="form-label">Gewenste functionaliteiten</label>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" value="contactform">
                <span>Contactformulier</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="blog">
                <span>Blog/nieuws</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="webshop">
                <span>Webshop</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="booking">
                <span>Boekingssysteem</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="portfolio">
                <span>Portfolio/projecten</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="login">
                <span>Inlogomgeving</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="cms">
                <span>CMS (zelf content beheren)</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="seo">
                <span>SEO optimalisatie</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="analytics">
                <span>Analytics / statistieken</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="newsletter">
                <span>Nieuwsbrief integratie</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="social">
                <span>Social media integratie</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="reviews">
                <span>Reviews / testimonials</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="maps">
                <span>Google Maps</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="chat">
                <span>Live chat / WhatsApp</span>
              </label>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Talen</label>
            <select class="form-select" id="deal-languages">
              <option value="nl">Nederlands</option>
              <option value="nl-en">Nederlands + Engels</option>
              <option value="nl-en-de">Nederlands + Engels + Duits</option>
              <option value="custom">Anders (specificeren in opmerkingen)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Content status</label>
            <select class="form-select" id="deal-content-status">
              <option value="">Selecteer status...</option>
              <option value="ready">Content is klaar</option>
              <option value="partial">Deels beschikbaar</option>
              <option value="needs-help">Hulp nodig bij teksten</option>
              <option value="none">Nog geen content</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Urgentie</label>
            <select class="form-select" id="deal-urgency">
              <option value="">Selecteer urgentie...</option>
              <option value="asap">Zo snel mogelijk</option>
              <option value="1-month">Binnen 1 maand</option>
              <option value="2-3-months">2-3 maanden</option>
              <option value="flexible">Flexibel</option>
            </select>
          </div>
        </div>

        <!-- Step 5: Overzicht & bevestiging -->
        <div class="wizard-step" id="wizard-step-5" style="display:none;">
          <h3 class="wizard-step-title">Overzicht & bevestiging</h3>
          <div id="deal-summary" class="deal-summary"></div>
          <div class="form-group">
            <label class="form-label">Speciale wensen of opmerkingen</label>
            <textarea class="form-input" id="deal-special-requests" rows="4" placeholder="Eventuele aanvullende informatie..."></textarea>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" id="wizard-prev-btn" onclick="prevStep()" style="display:none;">Vorige</button>
        <button class="btn btn-secondary" onclick="closeModal('deal-modal')">Annuleren</button>
        <button class="btn btn-primary" id="wizard-next-btn" onclick="nextStep()">Volgende</button>
        <button class="btn btn-primary" id="save-deal-btn" onclick="saveDeal()" style="display:none;">Opslaan</button>
      </div>
    </div>
  </div>

  <!-- New Lead Modal (BTW Lookup) -->
  <div class="modal-overlay" id="new-lead-modal">
    <div class="modal" style="max-width:560px;">
      <div class="modal-header">
        <span class="modal-title">Nieuwe lead toevoegen</span>
        <button class="modal-close" onclick="closeModal('new-lead-modal')"><i data-lucide="x"></i></button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">BTW nummer opzoeken</label>
          <div style="display:flex;gap:8px;">
            <input type="text" class="form-input" id="new-lead-vat" placeholder="BE0866.477.739" style="flex:1;">
            <button type="button" class="btn btn-primary" id="vat-lookup-btn" onclick="lookupVat()">
              <i data-lucide="search" style="width:16px;height:16px;"></i> Opzoeken
            </button>
          </div>
          <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Alle formaten werken: BE0866.477.739 / BE0866477739 / 0866.477.739 / 0866477739</div>
          <div id="vat-lookup-result" style="display:none;margin-top:8px;padding:8px 12px;border-radius:var(--radius-sm);font-size:12px;"></div>
        </div>
        <hr style="border-color:var(--border-color);margin:16px 0;">
        <div style="display:grid;gap:12px;">
          <div class="form-group" style="margin:0;">
            <label class="form-label">Bedrijfsnaam *</label>
            <input type="text" class="form-input" id="new-lead-company" required>
          </div>
          <div class="form-group" style="margin:0;">
            <label class="form-label">Contactpersoon</label>
            <input type="text" class="form-input" id="new-lead-contact">
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <div class="form-group" style="margin:0;">
              <label class="form-label">Telefoon</label>
              <input type="text" class="form-input" id="new-lead-phone">
            </div>
            <div class="form-group" style="margin:0;">
              <label class="form-label">Email</label>
              <input type="email" class="form-input" id="new-lead-email">
            </div>
          </div>
          <div class="form-group" style="margin:0;">
            <label class="form-label">Adres</label>
            <input type="text" class="form-input" id="new-lead-address">
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <div class="form-group" style="margin:0;">
              <label class="form-label">Gemeente</label>
              <input type="text" class="form-input" id="new-lead-city">
            </div>
            <div class="form-group" style="margin:0;">
              <label class="form-label">Website</label>
              <input type="url" class="form-input" id="new-lead-website" placeholder="https://...">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('new-lead-modal')">Annuleren</button>
        <button class="btn btn-primary" onclick="saveNewLead()">Lead opslaan & selecteren</button>
      </div>
    </div>
  </div>

  <!-- Deal Detail Modal -->
  <div class="modal-overlay" id="detail-modal" onclick="if(event.target===this)closeModal('detail-modal')">
    <div class="modal" style="max-width:560px;">
      <div class="modal-header">
        <span class="modal-title" id="detail-modal-title">Deal details</span>
        <button class="modal-close" onclick="closeModal('detail-modal')"><i data-lucide="x"></i></button>
      </div>
      <div class="modal-body" id="detail-modal-body"></div>
    </div>
  </div>

  <script src="assets/js/config.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/components.js"></script>
  <script src="assets/js/sidebar.js"></script>
  <script>
    let currentPage = 1;
    let packages = [];
    let upsells = [];
    let editingDealId = null;
    let currentWizardStep = 1;
    const totalWizardSteps = 5;

    async function init() {
      if (!await requireLogin()) return;
      initSidebar();
      initTopbar('Deals');
      lucide.createIcons();
      loadDeals();

      const params = new URLSearchParams(window.location.search);
      const newDealLeadId = params.get('newDeal');
      if (newDealLeadId) {
        history.replaceState(null, '', basePath('/deals.html'));
        setTimeout(() => openNewDealModal(newDealLeadId), 500);
      }
    }

    async function loadDeals() {
      try {
        const data = await API.get(`/deals?page=${currentPage}&limit=50`);
        renderDeals(data);
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    function renderDeals(data) {
      const tbody = document.getElementById('deals-body');
      if (data.deals.length === 0) {
        tbody.innerHTML = `<tr><td colspan="10" class="text-center text-muted" style="padding:40px;">Geen deals gevonden</td></tr>`;
        return;
      }

      tbody.innerHTML = data.deals.map(deal => {
        const upsellTags = deal.upsells.map(u =>
          `<span style="background:var(--accent-purple-dim);color:var(--accent-purple);padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-right:4px;">${u.upsell.name}</span>`
        ).join('');

        let originBadge = '<span class="source-badge cold-outreach">Via lead</span>';
        if (deal.acquisitionType === 'flyer') {
          originBadge = '<span class="source-badge flyer">Flyer acquisitie</span>';
        } else if (deal.acquisitionType === 'none' || deal.acquisitionCost === 0) {
          originBadge = '<span class="source-badge warm">Warm / direct</span>';
        }

        return `
          <tr style="cursor:pointer;" onclick="viewDeal('${deal.id}')">
            <td style="font-weight:500;">${deal.lead.companyName}</td>
            <td>${originBadge}</td>
            <td><span style="background:var(--accent-blue-dim);color:var(--accent-blue);padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;">${deal.package.name}</span></td>
            <td>${upsellTags || '-'}</td>
            <td>${formatCurrency(deal.package.oneTimePrice)}</td>
            <td>${formatCurrency(deal.package.monthlyPrice)}/mnd</td>
            <td>${formatCurrency(deal.acquisitionCost)}</td>
            <td style="font-weight:700;color:#34d399;">${formatCurrency(deal.totalValue)}</td>
            <td style="color:var(--text-muted);">${formatDate(deal.saleDate)}</td>
            <td onclick="event.stopPropagation()">
              <button class="btn-icon" onclick="viewDeal('${deal.id}')" title="Bekijken">
                <i data-lucide="eye" style="width:16px;height:16px;"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');

      renderPagination(document.getElementById('pagination'), data, (page) => { currentPage = page; loadDeals(); });
      lucide.createIcons();
    }

    let allLeads = [];

    async function openNewDealModal(preselectedLeadId) {
      editingDealId = null;
      document.getElementById('deal-modal-title').textContent = 'Nieuwe deal';

      try {
        const [pkgs, ups, leadsData] = await Promise.all([
          API.get('/packages'),
          API.get('/packages/upsells'),
          API.get('/leads?limit=1000&status=')
        ]);
        packages = pkgs;
        upsells = ups;
        allLeads = leadsData.leads;

        const leadSearchInput = document.getElementById('deal-lead-search');
        const leadHiddenInput = document.getElementById('deal-lead');
        
        if (preselectedLeadId) {
          const preselectedLead = allLeads.find(l => l.id === preselectedLeadId);
          if (preselectedLead) {
            leadSearchInput.value = `${preselectedLead.companyName}${preselectedLead.city ? ' - ' + preselectedLead.city : ''}`;
            leadHiddenInput.value = preselectedLead.id;
          }
        } else {
          leadSearchInput.value = '';
          leadHiddenInput.value = '';
        }
        
        initLeadSearch();

        const pkgSelect = document.getElementById('deal-package');
        pkgSelect.innerHTML = packages.map(p =>
          `<option value="${p.id}">${p.name} - ${formatCurrency(p.oneTimePrice)}</option>`
        ).join('');

        const upsellsDiv = document.getElementById('deal-upsells');
        upsellsDiv.innerHTML = upsells.map(u => `
          <label style="display:flex;align-items:center;gap:8px;padding:6px 0;cursor:pointer;">
            <input type="checkbox" value="${u.id}" class="upsell-checkbox">
            <span style="font-size:13px;">${u.name} - ${formatCurrency(u.price)}${u.billingType === 'MONTHLY' ? '/mnd' : ''}</span>
          </label>
        `).join('');

        document.getElementById('deal-cost').value = '';
        document.getElementById('deal-date').value = new Date().toISOString().split('T')[0];

        pkgSelect.addEventListener('change', updateCalculation);
        document.querySelectorAll('.upsell-checkbox').forEach(cb => cb.addEventListener('change', updateCalculation));
        updateCalculation();

        currentWizardStep = 1;
        updateWizardUI();
        
        document.querySelectorAll('input[name="has-existing"]').forEach(radio => {
          radio.addEventListener('change', (e) => {
            document.getElementById('existing-url-group').style.display = e.target.value === 'true' ? 'block' : 'none';
          });
        });

        openModal('deal-modal');
        lucide.createIcons();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    function initLeadSearch() {
      const searchInput = document.getElementById('deal-lead-search');
      const hiddenInput = document.getElementById('deal-lead');
      const suggestionsDiv = document.getElementById('lead-suggestions');
      
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        
        if (query.length < 2) {
          suggestionsDiv.style.display = 'none';
          hiddenInput.value = '';
          return;
        }
        
        const filtered = allLeads.filter(lead => {
          const companyName = lead.companyName.toLowerCase();
          const city = (lead.city || '').toLowerCase();
          return companyName.includes(query) || city.includes(query);
        }).slice(0, 10);
        
        if (filtered.length === 0) {
          suggestionsDiv.innerHTML = '<div class="suggestion-item" style="color:var(--text-muted);cursor:default;">Geen resultaten</div>';
          suggestionsDiv.style.display = 'block';
          hiddenInput.value = '';
          return;
        }
        
        suggestionsDiv.innerHTML = filtered.map(lead => `
          <div class="suggestion-item" data-id="${lead.id}" data-name="${lead.companyName}${lead.city ? ' - ' + lead.city : ''}">
            <div style="font-weight:500;">${lead.companyName}</div>
            ${lead.city ? `<div style="font-size:12px;color:var(--text-muted);">${lead.city}</div>` : ''}
          </div>
        `).join('');
        
        suggestionsDiv.style.display = 'block';
        
        suggestionsDiv.querySelectorAll('.suggestion-item[data-id]').forEach(item => {
          item.addEventListener('click', () => {
            searchInput.value = item.dataset.name;
            hiddenInput.value = item.dataset.id;
            suggestionsDiv.style.display = 'none';
          });
        });
      });
      
      searchInput.addEventListener('blur', () => {
        setTimeout(() => {
          suggestionsDiv.style.display = 'none';
        }, 200);
      });
      
      searchInput.addEventListener('focus', () => {
        if (searchInput.value.length >= 2) {
          searchInput.dispatchEvent(new Event('input'));
        }
      });
    }

    function openNewLeadModal() {
      document.getElementById('new-lead-vat').value = '';
      document.getElementById('new-lead-company').value = '';
      document.getElementById('new-lead-contact').value = '';
      document.getElementById('new-lead-phone').value = '';
      document.getElementById('new-lead-email').value = '';
      document.getElementById('new-lead-address').value = '';
      document.getElementById('new-lead-city').value = '';
      document.getElementById('new-lead-website').value = '';
      const resultDiv = document.getElementById('vat-lookup-result');
      resultDiv.style.display = 'none';
      resultDiv.innerHTML = '';
      openModal('new-lead-modal');
      lucide.createIcons();
    }

    async function lookupVat() {
      const vatInput = document.getElementById('new-lead-vat').value.trim();
      const resultDiv = document.getElementById('vat-lookup-result');
      const btn = document.getElementById('vat-lookup-btn');
      
      if (!vatInput) {
        resultDiv.style.display = 'block';
        resultDiv.style.background = 'var(--accent-red-dim)';
        resultDiv.style.color = 'var(--accent-red)';
        resultDiv.textContent = 'Voer een BTW nummer in';
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<i data-lucide="loader" style="width:16px;height:16px;animation:spin 1s linear infinite;"></i> Zoeken...';
      resultDiv.style.display = 'none';

      try {
        const data = await API.get(`/kbo/lookup/${encodeURIComponent(vatInput)}`);
        
        document.getElementById('new-lead-company').value = data.companyName || '';
        document.getElementById('new-lead-phone').value = data.phone || '';
        document.getElementById('new-lead-email').value = data.email || '';
        document.getElementById('new-lead-address').value = data.address || '';
        document.getElementById('new-lead-city').value = data.city || '';
        document.getElementById('new-lead-website').value = data.website || '';
        document.getElementById('new-lead-vat').value = data.vatNumberFormatted || vatInput;

        resultDiv.style.display = 'block';
        resultDiv.style.background = 'var(--accent-green-dim)';
        resultDiv.style.color = 'var(--accent-green)';
        resultDiv.innerHTML = `Bedrijf gevonden: <strong>${data.companyName}</strong>${data.legalForm ? ' (' + data.legalForm + ')' : ''}`;
      } catch (err) {
        resultDiv.style.display = 'block';
        resultDiv.style.background = 'var(--accent-red-dim)';
        resultDiv.style.color = 'var(--accent-red)';
        resultDiv.textContent = err.message || 'Bedrijf niet gevonden';
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i data-lucide="search" style="width:16px;height:16px;"></i> Opzoeken';
        lucide.createIcons();
      }
    }

    async function saveNewLead() {
      const companyName = document.getElementById('new-lead-company').value.trim();
      if (!companyName) {
        showToast('Bedrijfsnaam is verplicht', 'warning');
        return;
      }

      try {
        const lead = await API.post('/leads', {
          companyName,
          vatNumber: document.getElementById('new-lead-vat').value.trim() || null,
          contactPerson: document.getElementById('new-lead-contact').value.trim() || null,
          phone: document.getElementById('new-lead-phone').value.trim() || null,
          email: document.getElementById('new-lead-email').value.trim() || null,
          address: document.getElementById('new-lead-address').value.trim() || null,
          city: document.getElementById('new-lead-city').value.trim() || null,
          website: document.getElementById('new-lead-website').value.trim() || null,
          source: 'CRM'
        });

        allLeads.push(lead);
        
        const searchInput = document.getElementById('deal-lead-search');
        const hiddenInput = document.getElementById('deal-lead');
        searchInput.value = lead.companyName + (lead.city ? ' - ' + lead.city : '');
        hiddenInput.value = lead.id;

        closeModal('new-lead-modal');
        showToast(`Lead "${lead.companyName}" aangemaakt en geselecteerd`);
      } catch (err) {
        showToast(err.message || 'Fout bij aanmaken lead', 'error');
      }
    }

    function updateAcquisitionUI() {
      const type = document.querySelector('input[name="acquisition-type"]:checked').value;
      const flyerGroup = document.getElementById('flyer-cost-group');
      const manualGroup = document.getElementById('manual-cost-group');
      
      flyerGroup.style.display = type === 'flyer' ? 'block' : 'none';
      manualGroup.style.display = type === 'manual' ? 'block' : 'none';
      
      if (type === 'none') {
        document.getElementById('deal-cost').value = '0';
      } else if (type === 'flyer') {
        const savedRate = localStorage.getItem('flyerRate');
        if (savedRate) {
          document.getElementById('deal-flyer-rate').value = savedRate;
        }
      }
    }

    function saveFlyerRate() {
      const rate = document.getElementById('deal-flyer-rate').value;
      if (rate) {
        localStorage.setItem('flyerRate', rate);
        showToast('Flyer tarief opgeslagen als standaard');
      }
    }

    function getAcquisitionCost() {
      const type = document.querySelector('input[name="acquisition-type"]:checked').value;
      if (type === 'none') return 0;
      if (type === 'flyer') return parseFloat(document.getElementById('deal-flyer-rate').value) || 0;
      return parseFloat(document.getElementById('deal-cost').value) || 0;
    }

    function updateHostingUI() {
      const hasHosting = document.querySelector('input[name="has-hosting"]:checked').value === 'true';
      document.getElementById('hosting-details').style.display = hasHosting ? 'block' : 'none';
      updateCalculation();
    }

    function updateDiscountUI() {
      const type = document.querySelector('input[name="discount-type"]:checked').value;
      const percentageGroup = document.getElementById('discount-percentage-group');
      const fixedGroup = document.getElementById('discount-fixed-group');
      
      percentageGroup.style.display = type === 'percentage' ? 'block' : 'none';
      fixedGroup.style.display = type === 'fixed' ? 'block' : 'none';
      
      if (type === 'none') {
        document.getElementById('deal-discount-percentage').value = '';
        document.getElementById('deal-discount-fixed').value = '';
      }
      
      updateCalculation();
    }

    function updateWizardUI() {
      for (let i = 1; i <= totalWizardSteps; i++) {
        const step = document.getElementById(`wizard-step-${i}`);
        if (step) step.style.display = i === currentWizardStep ? 'block' : 'none';
      }
      
      const progressBar = document.getElementById('wizard-progress-bar');
      progressBar.style.width = `${(currentWizardStep / totalWizardSteps) * 100}%`;
      
      document.getElementById('wizard-prev-btn').style.display = currentWizardStep > 1 ? 'inline-block' : 'none';
      document.getElementById('wizard-next-btn').style.display = currentWizardStep < totalWizardSteps ? 'inline-block' : 'none';
      document.getElementById('save-deal-btn').style.display = currentWizardStep === totalWizardSteps ? 'inline-block' : 'none';
      
      if (currentWizardStep === totalWizardSteps) {
        updateSummary();
      }
    }

    function nextStep() {
      if (!validateStep(currentWizardStep)) return;
      if (currentWizardStep < totalWizardSteps) {
        currentWizardStep++;
        updateWizardUI();
      }
    }

    function prevStep() {
      if (currentWizardStep > 1) {
        currentWizardStep--;
        updateWizardUI();
      }
    }

    function validateStep(step) {
      if (step === 1) {
        const leadId = document.getElementById('deal-lead').value;
        const packageId = document.getElementById('deal-package').value;
        if (!leadId) {
          showToast('Selecteer een lead', 'warning');
          return false;
        }
        if (!packageId) {
          showToast('Selecteer een pakket', 'warning');
          return false;
        }
      }
      return true;
    }

    function updateSummary() {
      const leadSelect = document.getElementById('deal-lead');
      const pkgSelect = document.getElementById('deal-package');
      const leadName = leadSelect.options[leadSelect.selectedIndex]?.text || '-';
      const pkgName = pkgSelect.options[pkgSelect.selectedIndex]?.text || '-';
      
      const selectedUpsells = Array.from(document.querySelectorAll('.upsell-checkbox:checked')).map(cb => {
        const upsell = upsells.find(u => u.id === cb.value);
        return upsell ? upsell.name : '';
      }).filter(Boolean);
      
      const discountType = document.querySelector('input[name="discount-type"]:checked')?.value || 'none';
      const discountPercentage = parseFloat(document.getElementById('deal-discount-percentage').value) || 0;
      const discountFixed = parseFloat(document.getElementById('deal-discount-fixed').value) || 0;
      
      const websiteGoal = document.getElementById('deal-website-goal').value;
      const targetAudience = document.getElementById('deal-target-audience').value;
      const hasExisting = document.querySelector('input[name="has-existing"]:checked').value === 'true';
      const existingUrl = document.getElementById('deal-existing-url').value;
      const mood = document.getElementById('deal-mood').value;
      const heroType = document.getElementById('deal-hero-type').value;
      const tone = document.getElementById('deal-tone').value;
      const referenceUrls = document.getElementById('deal-reference-urls').value;
      const usps = document.getElementById('deal-usps').value;
      const cta = document.getElementById('deal-cta').value;
      const selectedFeatures = Array.from(document.querySelectorAll('.checkbox-group input:checked')).map(cb => cb.nextElementSibling.textContent);
      const languages = document.getElementById('deal-languages').value;
      const contentStatus = document.getElementById('deal-content-status').value;
      const urgency = document.getElementById('deal-urgency').value;
      
      document.getElementById('deal-summary').innerHTML = `
        <div style="display:grid;gap:16px;">
          <div>
            <h4 style="font-size:14px;font-weight:600;margin-bottom:8px;color:var(--text-primary);">Deal informatie</h4>
            <div style="display:grid;gap:6px;font-size:13px;">
              <div class="flex justify-between"><span class="text-muted">Lead:</span><span>${leadName}</span></div>
              <div class="flex justify-between"><span class="text-muted">Pakket:</span><span>${pkgName}</span></div>
              ${selectedUpsells.length > 0 ? `<div class="flex justify-between"><span class="text-muted">Upsells:</span><span>${selectedUpsells.join(', ')}</span></div>` : ''}
              ${discountType === 'percentage' && discountPercentage > 0 ? `<div class="flex justify-between"><span class="text-muted">Korting:</span><span style="color:var(--accent-green);">${discountPercentage}%</span></div>` : ''}
              ${discountType === 'fixed' && discountFixed > 0 ? `<div class="flex justify-between"><span class="text-muted">Korting:</span><span style="color:var(--accent-green);">${formatCurrency(discountFixed)}</span></div>` : ''}
            </div>
          </div>
          
          ${websiteGoal || targetAudience ? `
          <div>
            <h4 style="font-size:14px;font-weight:600;margin-bottom:8px;color:var(--text-primary);">Website context</h4>
            <div style="display:grid;gap:6px;font-size:13px;">
              ${websiteGoal ? `<div class="flex justify-between"><span class="text-muted">Doel:</span><span>${document.querySelector(`#deal-website-goal option[value="${websiteGoal}"]`)?.text || websiteGoal}</span></div>` : ''}
              ${targetAudience ? `<div class="flex justify-between"><span class="text-muted">Doelgroep:</span><span>${targetAudience}</span></div>` : ''}
              ${hasExisting ? `<div class="flex justify-between"><span class="text-muted">Bestaande site:</span><span>${existingUrl || 'Ja'}</span></div>` : ''}
            </div>
          </div>
          ` : ''}
          
          ${mood || heroType || tone || referenceUrls ? `
          <div>
            <h4 style="font-size:14px;font-weight:600;margin-bottom:8px;color:var(--text-primary);">Design & identiteit</h4>
            <div style="display:grid;gap:6px;font-size:13px;">
              ${mood ? `<div class="flex justify-between"><span class="text-muted">Sfeer:</span><span>${document.querySelector(`#deal-mood option[value="${mood}"]`)?.text || mood}</span></div>` : ''}
              ${heroType ? `<div class="flex justify-between"><span class="text-muted">Hero:</span><span>${document.querySelector(`#deal-hero-type option[value="${heroType}"]`)?.text || heroType}</span></div>` : ''}
              ${tone ? `<div class="flex justify-between"><span class="text-muted">Tone:</span><span>${document.querySelector(`#deal-tone option[value="${tone}"]`)?.text || tone}</span></div>` : ''}
              ${referenceUrls ? `<div><span class="text-muted">Referentie websites:</span><div style="margin-top:4px;">${referenceUrls.split('\\n').filter(Boolean).map(u => `<a href="${u.trim()}" target="_blank" style="color:var(--accent-brand);display:block;">${u.trim()}</a>`).join('')}</div></div>` : ''}
            </div>
          </div>
          ` : ''}
          
          ${usps || cta || selectedFeatures.length > 0 ? `
          <div>
            <h4 style="font-size:14px;font-weight:600;margin-bottom:8px;color:var(--text-primary);">Strategie & content</h4>
            <div style="display:grid;gap:6px;font-size:13px;">
              ${usps ? `<div><span class="text-muted">USP's:</span><div style="margin-top:4px;">${usps}</div></div>` : ''}
              ${cta ? `<div class="flex justify-between"><span class="text-muted">CTA:</span><span>${cta}</span></div>` : ''}
              ${selectedFeatures.length > 0 ? `<div><span class="text-muted">Features:</span><div style="margin-top:4px;">${selectedFeatures.join(', ')}</div></div>` : ''}
              ${contentStatus ? `<div class="flex justify-between"><span class="text-muted">Content:</span><span>${document.querySelector(`#deal-content-status option[value="${contentStatus}"]`)?.text || contentStatus}</span></div>` : ''}
              ${urgency ? `<div class="flex justify-between"><span class="text-muted">Urgentie:</span><span>${document.querySelector(`#deal-urgency option[value="${urgency}"]`)?.text || urgency}</span></div>` : ''}
            </div>
          </div>
          ` : ''}
        </div>
      `;
    }

    function updateCalculation() {
      const pkgId = document.getElementById('deal-package').value;
      const pkg = packages.find(p => p.id === pkgId);
      if (!pkg) return;

      const selectedUpsells = Array.from(document.querySelectorAll('.upsell-checkbox:checked')).map(cb => {
        return upsells.find(u => u.id === cb.value);
      }).filter(Boolean);

      const hasHosting = document.querySelector('input[name="has-hosting"]:checked')?.value === 'true';
      const hostingPrice = hasHosting ? (parseFloat(document.getElementById('deal-hosting-price').value) || 0) : 0;
      const hostingInterval = document.getElementById('deal-hosting-interval').value;

      const upsellOneTime = selectedUpsells.filter(u => u.billingType === 'ONE_TIME').reduce((s, u) => s + u.price, 0);
      const upsellMonthly = selectedUpsells.filter(u => u.billingType === 'MONTHLY').reduce((s, u) => s + u.price, 0);
      
      // Calculate discount
      const discountType = document.querySelector('input[name="discount-type"]:checked')?.value || 'none';
      let discountAmount = 0;
      const oneTimeTotal = pkg.oneTimePrice + upsellOneTime;
      
      if (discountType === 'percentage') {
        const percentage = parseFloat(document.getElementById('deal-discount-percentage').value) || 0;
        discountAmount = (oneTimeTotal * percentage) / 100;
      } else if (discountType === 'fixed') {
        discountAmount = parseFloat(document.getElementById('deal-discount-fixed').value) || 0;
      }
      
      const oneTimeTotalAfterDiscount = Math.max(0, oneTimeTotal - discountAmount);
      const totalMonthly = hostingPrice + upsellMonthly;
      const yearlyValue = oneTimeTotalAfterDiscount + (totalMonthly * 12);

      document.getElementById('deal-calculation').innerHTML = `
        <div class="flex justify-between" style="margin-bottom:6px;"><span class="text-muted">Eenmalig pakket</span><span>${formatCurrency(pkg.oneTimePrice)}</span></div>
        ${upsellOneTime > 0 ? `<div class="flex justify-between" style="margin-bottom:6px;"><span class="text-muted">Eenmalige upsells</span><span>${formatCurrency(upsellOneTime)}</span></div>` : ''}
        ${discountAmount > 0 ? `<div class="flex justify-between" style="margin-bottom:6px;"><span class="text-muted">Korting</span><span style="color:var(--accent-green);">-${formatCurrency(discountAmount)}</span></div>` : ''}
        ${discountAmount > 0 ? `<div class="flex justify-between" style="margin-bottom:6px;"><span style="font-weight:600;">Eenmalig totaal</span><span style="font-weight:600;">${formatCurrency(oneTimeTotalAfterDiscount)}</span></div>` : ''}
        ${hasHosting ? `<div class="flex justify-between" style="margin-bottom:6px;"><span class="text-muted">Hosting</span><span>${formatCurrency(hostingPrice)}/${hostingInterval === 'YEARLY' ? 'jaar' : 'mnd'}</span></div>` : '<div class="flex justify-between" style="margin-bottom:6px;"><span class="text-muted">Hosting</span><span style="color:var(--text-muted);">Geen</span></div>'}
        ${upsellMonthly > 0 ? `<div class="flex justify-between" style="margin-bottom:6px;"><span class="text-muted">Maandelijkse upsells</span><span>${formatCurrency(upsellMonthly)}/mnd</span></div>` : ''}
        <hr style="border-color:var(--border-color);margin:8px 0;">
        <div class="flex justify-between"><span style="font-weight:600;">Jaarwaarde (12 mnd)</span><span style="font-weight:700;color:var(--accent-brand);">${formatCurrency(yearlyValue)}</span></div>
      `;
    }

    async function saveDeal() {
      const leadId = document.getElementById('deal-lead').value;
      const packageId = document.getElementById('deal-package').value;
      const upsellIds = Array.from(document.querySelectorAll('.upsell-checkbox:checked')).map(cb => cb.value);
      const acquisitionCost = getAcquisitionCost();
      const acquisitionType = document.querySelector('input[name="acquisition-type"]:checked').value;
      const saleDate = document.getElementById('deal-date').value;

      const hasHosting = document.querySelector('input[name="has-hosting"]:checked').value === 'true';
      const hostingPrice = hasHosting ? (parseFloat(document.getElementById('deal-hosting-price').value) || 20) : 0;
      const hostingInterval = document.getElementById('deal-hosting-interval').value;
      const hostingStartDate = document.getElementById('deal-hosting-start').value || null;
      const hostingEndDate = document.getElementById('deal-hosting-end').value || null;

      if (!leadId) return showToast('Selecteer een lead', 'warning');
      if (!packageId) return showToast('Selecteer een pakket', 'warning');

      const websiteGoal = document.getElementById('deal-website-goal').value || null;
      const targetAudience = document.getElementById('deal-target-audience').value || null;
      const hasExistingWebsite = document.querySelector('input[name="has-existing"]:checked').value === 'true';
      const existingWebsiteUrl = document.getElementById('deal-existing-url').value || null;
      const mood = document.getElementById('deal-mood').value || null;
      const heroType = document.getElementById('deal-hero-type').value || null;
      const toneOfVoice = document.getElementById('deal-tone').value || null;
      const referenceUrls = document.getElementById('deal-reference-urls').value || null;
      const usps = document.getElementById('deal-usps').value || null;
      const primaryCta = document.getElementById('deal-cta').value || null;
      const selectedFeatures = Array.from(document.querySelectorAll('.checkbox-group input:checked')).map(cb => cb.value);
      const features = selectedFeatures.length > 0 ? selectedFeatures.join(',') : null;
      const languages = document.getElementById('deal-languages').value || null;
      const contentStatus = document.getElementById('deal-content-status').value || null;
      const urgency = document.getElementById('deal-urgency').value || null;
      const specialRequests = document.getElementById('deal-special-requests').value || null;

      const discountType = document.querySelector('input[name="discount-type"]:checked')?.value || 'none';
      const discountPercentage = discountType === 'percentage' ? (parseFloat(document.getElementById('deal-discount-percentage').value) || 0) : 0;
      const discountAmount = discountType === 'fixed' ? (parseFloat(document.getElementById('deal-discount-fixed').value) || 0) : 0;

      const dealData = {
        packageId, upsellIds, acquisitionCost, acquisitionType, saleDate,
        hasHosting, hostingPrice, hostingInterval, hostingStartDate, hostingEndDate,
        discountType, discountPercentage, discountAmount,
        websiteGoal, targetAudience, hasExistingWebsite, existingWebsiteUrl,
        mood, heroType, toneOfVoice, referenceUrls, usps, primaryCta,
        features, languages, contentStatus, urgency, specialRequests
      };

      if (!editingDealId) {
        dealData.leadId = leadId;
      }

      try {
        if (editingDealId) {
          await API.put(`/deals/${editingDealId}`, dealData);
          showToast('Deal bijgewerkt');
        } else {
          await API.post('/deals', dealData);
          showToast('Deal aangemaakt');
        }
        closeModal('deal-modal');
        loadDeals();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function viewDeal(id) {
      try {
        const deal = await API.get(`/deals/${id}`);
        document.getElementById('detail-modal-title').textContent = deal.lead.companyName;

        const upsellList = deal.upsells.map(u =>
          `<span style="background:var(--accent-purple-dim);color:var(--accent-purple);padding:3px 10px;border-radius:12px;font-size:12px;font-weight:600;margin-right:4px;">${u.upsell.name} - ${formatCurrency(u.upsell.price)}${u.upsell.billingType === 'MONTHLY' ? '/mnd' : ''}</span>`
        ).join('') || '<span class="text-muted">Geen</span>';

        const websiteGoalLabels = {
          'leads': 'Leads genereren',
          'sales': 'Online verkopen',
          'branding': 'Merkbekendheid',
          'info': 'Informatievoorziening',
          'portfolio': 'Portfolio tonen'
        };
        
        const moodLabels = {
          'modern-minimalistisch': 'Modern & minimalistisch',
          'professioneel-zakelijk': 'Professioneel & zakelijk',
          'creatief-speels': 'Creatief & speels',
          'luxe-premium': 'Luxe & premium',
          'warm-toegankelijk': 'Warm & toegankelijk',
          'stoer-industrieel': 'Stoer & industrieel'
        };
        
        const heroTypeLabels = {
          'foto-groot': 'Grote foto/visual',
          'video-achtergrond': 'Video achtergrond',
          'illustratie': 'Illustratie/grafisch',
          'minimaal-tekst': 'Minimaal met focus op tekst',
          'product-showcase': 'Product showcase'
        };
        
        const toneLabels = {
          'formeel': 'Formeel & professioneel',
          'vriendelijk': 'Vriendelijk & persoonlijk',
          'direct': 'Direct & to-the-point',
          'inspirerend': 'Inspirerend & motiverend',
          'humoristisch': 'Humoristisch & luchtig'
        };
        
        const languageLabels = {
          'nl': 'Nederlands',
          'nl-en': 'Nederlands + Engels',
          'nl-en-de': 'Nederlands + Engels + Duits',
          'custom': 'Anders'
        };
        
        const contentStatusLabels = {
          'ready': 'Content is klaar',
          'partial': 'Deels beschikbaar',
          'needs-help': 'Hulp nodig bij teksten',
          'none': 'Nog geen content'
        };
        
        const urgencyLabels = {
          'asap': 'Zo snel mogelijk',
          '1-month': 'Binnen 1 maand',
          '2-3-months': '2-3 maanden',
          'flexible': 'Flexibel'
        };
        
        const featureLabels = {
          'contactform': 'Contactformulier',
          'blog': 'Blog/nieuws',
          'webshop': 'Webshop',
          'booking': 'Boekingssysteem',
          'portfolio': 'Portfolio/projecten',
          'login': 'Inlogomgeving',
          'cms': 'CMS (zelf content beheren)',
          'seo': 'SEO optimalisatie',
          'analytics': 'Analytics / statistieken',
          'newsletter': 'Nieuwsbrief integratie',
          'social': 'Social media integratie',
          'reviews': 'Reviews / testimonials',
          'maps': 'Google Maps',
          'chat': 'Live chat / WhatsApp'
        };

        document.getElementById('detail-modal-body').innerHTML = `
          <div style="display:flex;flex-direction:column;gap:14px;">
            <h4 style="font-size:14px;font-weight:600;margin:0;color:var(--text-primary);">Deal informatie</h4>
            <div class="flex justify-between items-center">
              <span class="text-muted">Bedrijf</span>
              <span style="font-weight:600;">${deal.lead.companyName}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-muted">Gemeente</span>
              <span>${deal.lead.city || '-'}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-muted">Pakket</span>
              <span style="font-weight:600;">${deal.package.name}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-muted">Eenmalige prijs</span>
              <span>${formatCurrency(deal.package.oneTimePrice)}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-muted">Maandelijks</span>
              <span>${formatCurrency(deal.package.monthlyPrice)}/mnd</span>
            </div>
            <div>
              <span class="text-muted" style="display:block;margin-bottom:6px;">Upsells</span>
              <div>${upsellList}</div>
            </div>
            ${deal.discountType && deal.discountType !== 'none' ? `
            <div class="flex justify-between items-center">
              <span class="text-muted">Korting</span>
              <span style="font-weight:600;color:var(--accent-green);">
                ${deal.discountType === 'percentage' ? `${deal.discountPercentage}%` : formatCurrency(deal.discountAmount)}
              </span>
            </div>
            ` : ''}
            <hr style="border-color:var(--border-color);">
            <div class="flex justify-between items-center">
              <span class="text-muted">Acquisitiekost</span>
              <span style="font-weight:600;">${formatCurrency(deal.acquisitionCost)}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-muted">Totale dealwaarde</span>
              <span style="font-weight:700;font-size:18px;color:var(--accent-brand);">${formatCurrency(deal.totalValue)}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-muted">ROI</span>
              <span style="font-weight:700;color:var(--accent-brand);">${deal.acquisitionCost > 0 ? (((deal.totalValue - deal.acquisitionCost) / deal.acquisitionCost) * 100).toFixed(1) : '0'}%</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-muted">Datum verkoop</span>
              <span>${formatDate(deal.saleDate)}</span>
            </div>
            
            <hr style="border-color:var(--border-color);">
            <h4 style="font-size:14px;font-weight:600;margin:0;color:var(--text-primary);">Hosting</h4>
            ${deal.hasHosting ? `
              <div class="flex justify-between items-center">
                <span class="text-muted">Status</span>
                <span style="background:var(--accent-green-dim);color:var(--accent-green);padding:3px 10px;border-radius:12px;font-size:12px;font-weight:600;">Actief</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-muted">Prijs</span>
                <span style="font-weight:600;">${formatCurrency(deal.hostingPrice)}/${deal.hostingInterval === 'YEARLY' ? 'jaar' : 'mnd'}</span>
              </div>
              ${deal.hostingStartDate ? `<div class="flex justify-between items-center">
                <span class="text-muted">Startdatum</span>
                <span>${formatDate(deal.hostingStartDate)}</span>
              </div>` : ''}
              ${deal.nextInvoiceDate ? `<div class="flex justify-between items-center">
                <span class="text-muted">Volgende factuur</span>
                <span>${formatDate(deal.nextInvoiceDate)}</span>
              </div>` : ''}
            ` : `
              <div class="flex justify-between items-center">
                <span class="text-muted">Status</span>
                <span style="color:var(--text-muted);">Geen hosting</span>
              </div>
            `}
            
            ${deal.websiteGoal || deal.targetAudience || deal.hasExistingWebsite ? `
              <hr style="border-color:var(--border-color);">
              <h4 style="font-size:14px;font-weight:600;margin:0;color:var(--text-primary);">Website context</h4>
              ${deal.websiteGoal ? `<div class="flex justify-between items-center">
                <span class="text-muted">Doel</span>
                <span>${websiteGoalLabels[deal.websiteGoal] || deal.websiteGoal}</span>
              </div>` : ''}
              ${deal.targetAudience ? `<div class="flex justify-between items-center">
                <span class="text-muted">Doelgroep</span>
                <span>${deal.targetAudience}</span>
              </div>` : ''}
              ${deal.hasExistingWebsite ? `<div class="flex justify-between items-center">
                <span class="text-muted">Bestaande website</span>
                <span>${deal.existingWebsiteUrl ? `<a href="${deal.existingWebsiteUrl}" target="_blank" style="color:var(--accent-brand);">${deal.existingWebsiteUrl}</a>` : 'Ja'}</span>
              </div>` : ''}
            ` : ''}
            
            ${deal.mood || deal.heroType || deal.toneOfVoice || deal.referenceUrls ? `
              <hr style="border-color:var(--border-color);">
              <h4 style="font-size:14px;font-weight:600;margin:0;color:var(--text-primary);">Design & identiteit</h4>
              ${deal.mood ? `<div class="flex justify-between items-center">
                <span class="text-muted">Sfeer</span>
                <span>${moodLabels[deal.mood] || deal.mood}</span>
              </div>` : ''}
              ${deal.heroType ? `<div class="flex justify-between items-center">
                <span class="text-muted">Hero sectie</span>
                <span>${heroTypeLabels[deal.heroType] || deal.heroType}</span>
              </div>` : ''}
              ${deal.toneOfVoice ? `<div class="flex justify-between items-center">
                <span class="text-muted">Tone of voice</span>
                <span>${toneLabels[deal.toneOfVoice] || deal.toneOfVoice}</span>
              </div>` : ''}
              ${deal.referenceUrls ? `<div>
                <span class="text-muted" style="display:block;margin-bottom:6px;">Referentie websites</span>
                <div style="background:var(--bg-secondary);padding:10px;border-radius:6px;font-size:13px;">${deal.referenceUrls.split('\n').filter(Boolean).map(u => `<a href="${u.trim()}" target="_blank" style="color:var(--accent-brand);display:block;">${u.trim()}</a>`).join('')}</div>
              </div>` : ''}
            ` : ''}
            
            ${deal.usps || deal.primaryCta || deal.features || deal.languages || deal.contentStatus || deal.urgency ? `
              <hr style="border-color:var(--border-color);">
              <h4 style="font-size:14px;font-weight:600;margin:0;color:var(--text-primary);">Strategie & content</h4>
              ${deal.usps ? `<div>
                <span class="text-muted" style="display:block;margin-bottom:6px;">USP's</span>
                <div style="background:var(--bg-secondary);padding:10px;border-radius:6px;font-size:13px;">${deal.usps}</div>
              </div>` : ''}
              ${deal.primaryCta ? `<div class="flex justify-between items-center">
                <span class="text-muted">Primaire CTA</span>
                <span>${deal.primaryCta}</span>
              </div>` : ''}
              ${deal.features ? `<div>
                <span class="text-muted" style="display:block;margin-bottom:6px;">Functionaliteiten</span>
                <div>${deal.features.split(',').map(f => `<span style="background:var(--accent-blue-dim);color:var(--accent-blue);padding:3px 10px;border-radius:12px;font-size:12px;font-weight:600;margin-right:4px;margin-bottom:4px;display:inline-block;">${featureLabels[f] || f}</span>`).join('')}</div>
              </div>` : ''}
              ${deal.languages ? `<div class="flex justify-between items-center">
                <span class="text-muted">Talen</span>
                <span>${languageLabels[deal.languages] || deal.languages}</span>
              </div>` : ''}
              ${deal.contentStatus ? `<div class="flex justify-between items-center">
                <span class="text-muted">Content status</span>
                <span>${contentStatusLabels[deal.contentStatus] || deal.contentStatus}</span>
              </div>` : ''}
              ${deal.urgency ? `<div class="flex justify-between items-center">
                <span class="text-muted">Urgentie</span>
                <span>${urgencyLabels[deal.urgency] || deal.urgency}</span>
              </div>` : ''}
            ` : ''}
            
            ${deal.specialRequests ? `
              <hr style="border-color:var(--border-color);">
              <h4 style="font-size:14px;font-weight:600;margin:0;color:var(--text-primary);">Speciale wensen</h4>
              <div style="background:var(--bg-secondary);padding:10px;border-radius:6px;font-size:13px;">${deal.specialRequests}</div>
            ` : ''}
            
            <hr style="border-color:var(--border-color);">
            <div style="display:flex;gap:8px;justify-content:flex-end;">
              <button class="btn btn-secondary btn-sm" onclick="closeModal('detail-modal');editDeal('${deal.id}')">
                <i data-lucide="pencil" style="width:14px;height:14px;"></i> Bewerken
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteDeal('${deal.id}')">
                <i data-lucide="trash-2" style="width:14px;height:14px;"></i> Verwijderen
              </button>
            </div>
          </div>
        `;

        openModal('detail-modal');
        lucide.createIcons();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function editDeal(id) {
      try {
        const deal = await API.get(`/deals/${id}`);
        editingDealId = id;
        document.getElementById('deal-modal-title').textContent = 'Deal bewerken';

        const [pkgs, ups, leadsData] = await Promise.all([
          API.get('/packages'),
          API.get('/packages/upsells'),
          API.get('/leads?limit=1000&status=')
        ]);
        packages = pkgs;
        upsells = ups;
        allLeads = leadsData.leads;

        const leadSearchInput = document.getElementById('deal-lead-search');
        const leadHiddenInput = document.getElementById('deal-lead');
        leadSearchInput.value = `${deal.lead.companyName}${deal.lead.city ? ' - ' + deal.lead.city : ''}`;
        leadHiddenInput.value = deal.leadId;
        leadSearchInput.disabled = true;
        
        initLeadSearch();

        const pkgSelect = document.getElementById('deal-package');
        pkgSelect.innerHTML = packages.map(p =>
          `<option value="${p.id}" ${p.id === deal.packageId ? 'selected' : ''}>${p.name} - ${formatCurrency(p.oneTimePrice)}</option>`
        ).join('');

        const dealUpsellIds = deal.upsells.map(u => u.upsellId);
        const upsellsDiv = document.getElementById('deal-upsells');
        upsellsDiv.innerHTML = upsells.map(u => `
          <label style="display:flex;align-items:center;gap:8px;padding:6px 0;cursor:pointer;">
            <input type="checkbox" value="${u.id}" class="upsell-checkbox" ${dealUpsellIds.includes(u.id) ? 'checked' : ''}>
            <span style="font-size:13px;">${u.name} - ${formatCurrency(u.price)}${u.billingType === 'MONTHLY' ? '/mnd' : ''}</span>
          </label>
        `).join('');

        document.getElementById('deal-cost').value = deal.acquisitionCost || '';
        document.getElementById('deal-date').value = deal.saleDate ? deal.saleDate.split('T')[0] : '';

        const acquisitionTypeRadio = document.querySelector(`input[name="acquisition-type"][value="${deal.acquisitionType || 'cold-outreach'}"]`);
        if (acquisitionTypeRadio) acquisitionTypeRadio.checked = true;
        updateAcquisitionUI();

        if (deal.hasHosting) {
          document.querySelector('input[name="has-hosting"][value="true"]').checked = true;
          document.getElementById('deal-hosting-price').value = deal.hostingPrice || 20;
          document.getElementById('deal-hosting-interval').value = deal.hostingInterval || 'MONTHLY';
          document.getElementById('deal-hosting-start').value = deal.hostingStartDate ? deal.hostingStartDate.split('T')[0] : '';
          document.getElementById('deal-hosting-end').value = deal.hostingEndDate ? deal.hostingEndDate.split('T')[0] : '';
        } else {
          document.querySelector('input[name="has-hosting"][value="false"]').checked = true;
        }
        updateHostingUI();

        if (deal.websiteGoal) document.getElementById('deal-website-goal').value = deal.websiteGoal;
        if (deal.targetAudience) document.getElementById('deal-target-audience').value = deal.targetAudience;
        
        if (deal.hasExistingWebsite !== null) {
          const hasExistingRadio = document.querySelector(`input[name="has-existing"][value="${deal.hasExistingWebsite}"]`);
          if (hasExistingRadio) hasExistingRadio.checked = true;
          if (deal.hasExistingWebsite && deal.existingWebsiteUrl) {
            document.getElementById('existing-url-group').style.display = 'block';
            document.getElementById('deal-existing-url').value = deal.existingWebsiteUrl;
          }
        }

        if (deal.mood) document.getElementById('deal-mood').value = deal.mood;
        if (deal.heroType) document.getElementById('deal-hero-type').value = deal.heroType;
        if (deal.toneOfVoice) document.getElementById('deal-tone').value = deal.toneOfVoice;
        if (deal.referenceUrls) document.getElementById('deal-reference-urls').value = deal.referenceUrls;

        if (deal.usps) document.getElementById('deal-usps').value = deal.usps;
        if (deal.primaryCta) document.getElementById('deal-cta').value = deal.primaryCta;
        
        if (deal.features) {
          const selectedFeatures = deal.features.split(',');
          document.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach(cb => {
            if (selectedFeatures.includes(cb.value)) cb.checked = true;
          });
        }

        if (deal.languages) document.getElementById('deal-languages').value = deal.languages;
        if (deal.contentStatus) document.getElementById('deal-content-status').value = deal.contentStatus;
        if (deal.urgency) document.getElementById('deal-urgency').value = deal.urgency;
        if (deal.specialRequests) document.getElementById('deal-special-requests').value = deal.specialRequests;

        pkgSelect.addEventListener('change', updateCalculation);
        document.querySelectorAll('.upsell-checkbox').forEach(cb => cb.addEventListener('change', updateCalculation));
        updateCalculation();

        currentWizardStep = 1;
        updateWizardUI();

        document.querySelectorAll('input[name="has-existing"]').forEach(radio => {
          radio.addEventListener('change', (e) => {
            document.getElementById('existing-url-group').style.display = e.target.value === 'true' ? 'block' : 'none';
          });
        });

        openModal('deal-modal');
        lucide.createIcons();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function deleteDeal(id) {
      if (!confirm('Weet je zeker dat je deze deal wilt verwijderen?')) return;
      try {
        await API.delete(`/deals/${id}`);
        showToast('Deal verwijderd');
        closeModal('detail-modal');
        loadDeals();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    init();
  </script>
</body>
</html>
