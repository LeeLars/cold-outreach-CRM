<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="favicon.png">
  <title>Deals - Cold Outreach CRM</title>
  <link rel="stylesheet" href="assets/css/global.css">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <div class="app-layout">
    <aside class="sidebar" id="sidebar"></aside>
    <div class="main-content">
      <header class="topbar" id="topbar"></header>
      <main class="page-content">
        <div class="toolbar">
          <div class="toolbar-left">
            <div class="topbar-search">
              <i data-lucide="search"></i>
              <input type="text" placeholder="Zoek deals..." id="search-input">
            </div>
          </div>
          <div class="toolbar-right">
            <button class="btn btn-primary" onclick="openNewDealModal()">
              <i data-lucide="plus"></i> Nieuwe deal
            </button>
          </div>
        </div>

        <div class="card">
          <div class="card-body" style="padding:0;">
            <table class="data-table" id="deals-table">
              <thead>
                <tr>
                  <th>Bedrijfsnaam</th>
                  <th>Pakket</th>
                  <th>Upsells</th>
                  <th>Eenmalig</th>
                  <th>Maandelijks</th>
                  <th>Acquisitiekost</th>
                  <th>Dealwaarde</th>
                  <th>Datum</th>
                  <th>Acties</th>
                </tr>
              </thead>
              <tbody id="deals-body"></tbody>
            </table>
          </div>
        </div>
        <div id="pagination"></div>
      </main>
    </div>
  </div>

  <!-- New/Edit Deal Modal - Wizard -->
  <div class="modal-overlay" id="deal-modal">
    <div class="modal" style="max-width:700px;">
      <div class="modal-header">
        <span class="modal-title" id="deal-modal-title">Nieuwe deal</span>
        <button class="modal-close" onclick="closeModal('deal-modal')"><i data-lucide="x"></i></button>
      </div>
      
      <!-- Progress Bar -->
      <div class="wizard-progress">
        <div class="wizard-progress-bar" id="wizard-progress-bar"></div>
      </div>
      
      <div class="modal-body">
        <!-- Step 1: Basis deal info -->
        <div class="wizard-step" id="wizard-step-1">
          <h3 class="wizard-step-title">Basis deal informatie</h3>
          <div class="form-group">
            <label class="form-label">Lead (bedrijf)</label>
            <select class="form-select" id="deal-lead"></select>
          </div>
          <div class="form-group">
            <label class="form-label">Pakket</label>
            <select class="form-select" id="deal-package"></select>
          </div>
          <div class="form-group">
            <label class="form-label">Upsells</label>
            <div id="deal-upsells"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Acquisitiekost</label>
            <input type="number" class="form-input" id="deal-cost" placeholder="0.00" step="0.01" min="0">
          </div>
          <div class="form-group">
            <label class="form-label">Datum verkoop</label>
            <input type="date" class="form-input" id="deal-date">
          </div>
          <div class="card" style="margin-top:16px;">
            <div class="card-body">
              <div style="font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px;">Berekening</div>
              <div id="deal-calculation" style="font-size:13px;"></div>
            </div>
          </div>
        </div>

        <!-- Step 2: Website doelen en context -->
        <div class="wizard-step" id="wizard-step-2" style="display:none;">
          <h3 class="wizard-step-title">Website doelen & context</h3>
          <div class="form-group">
            <label class="form-label">Wat is het hoofddoel van de website?</label>
            <select class="form-select" id="deal-website-goal">
              <option value="">Selecteer doel...</option>
              <option value="leads">Leads genereren</option>
              <option value="sales">Online verkopen</option>
              <option value="branding">Merkbekendheid</option>
              <option value="info">Informatievoorziening</option>
              <option value="portfolio">Portfolio tonen</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Wie is de doelgroep?</label>
            <input type="text" class="form-input" id="deal-target-audience" placeholder="B2B, particulieren, jongeren, etc.">
          </div>
          <div class="form-group">
            <label class="form-label">Heeft de klant al een website?</label>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="has-existing" value="false" checked>
                <span>Nee, volledig nieuw</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="has-existing" value="true">
                <span>Ja, bestaande website</span>
              </label>
            </div>
          </div>
          <div class="form-group" id="existing-url-group" style="display:none;">
            <label class="form-label">URL bestaande website</label>
            <input type="url" class="form-input" id="deal-existing-url" placeholder="https://...">
          </div>
        </div>

        <!-- Step 3: Design & visuele identiteit -->
        <div class="wizard-step" id="wizard-step-3" style="display:none;">
          <h3 class="wizard-step-title">Design & visuele identiteit</h3>
          <div class="form-group">
            <label class="form-label">Welke sfeer/mood past bij het merk?</label>
            <select class="form-select" id="deal-mood">
              <option value="">Selecteer sfeer...</option>
              <option value="modern-minimalistisch">Modern & minimalistisch</option>
              <option value="professioneel-zakelijk">Professioneel & zakelijk</option>
              <option value="creatief-speels">Creatief & speels</option>
              <option value="luxe-premium">Luxe & premium</option>
              <option value="warm-toegankelijk">Warm & toegankelijk</option>
              <option value="stoer-industrieel">Stoer & industrieel</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Wat voor hero sectie heeft voorkeur?</label>
            <select class="form-select" id="deal-hero-type">
              <option value="">Selecteer hero type...</option>
              <option value="foto-groot">Grote foto/visual</option>
              <option value="video-achtergrond">Video achtergrond</option>
              <option value="illustratie">Illustratie/grafisch</option>
              <option value="minimaal-tekst">Minimaal met focus op tekst</option>
              <option value="product-showcase">Product showcase</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Tone of voice</label>
            <select class="form-select" id="deal-tone">
              <option value="">Selecteer tone...</option>
              <option value="formeel">Formeel & professioneel</option>
              <option value="vriendelijk">Vriendelijk & persoonlijk</option>
              <option value="direct">Direct & to-the-point</option>
              <option value="inspirerend">Inspirerend & motiverend</option>
              <option value="humoristisch">Humoristisch & luchtig</option>
            </select>
          </div>
        </div>

        <!-- Step 4: Strategie & content -->
        <div class="wizard-step" id="wizard-step-4" style="display:none;">
          <h3 class="wizard-step-title">Strategie & content</h3>
          <div class="form-group">
            <label class="form-label">Belangrijkste USP's (unieke verkooppunten)</label>
            <textarea class="form-input" id="deal-usps" rows="3" placeholder="Bijv: 24/7 service, 20 jaar ervaring, gratis verzending..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Primaire call-to-action</label>
            <input type="text" class="form-input" id="deal-cta" placeholder="Bijv: Vraag offerte aan, Bestel nu, Plan gesprek...">
          </div>
          <div class="form-group">
            <label class="form-label">Gewenste functionaliteiten</label>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" value="contactform">
                <span>Contactformulier</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="blog">
                <span>Blog/nieuws</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="webshop">
                <span>Webshop</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="booking">
                <span>Boekingssysteem</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="portfolio">
                <span>Portfolio/projecten</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="login">
                <span>Inlogomgeving</span>
              </label>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Talen</label>
            <select class="form-select" id="deal-languages">
              <option value="nl">Nederlands</option>
              <option value="nl-en">Nederlands + Engels</option>
              <option value="nl-en-de">Nederlands + Engels + Duits</option>
              <option value="custom">Anders (specificeren in opmerkingen)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Content status</label>
            <select class="form-select" id="deal-content-status">
              <option value="">Selecteer status...</option>
              <option value="ready">Content is klaar</option>
              <option value="partial">Deels beschikbaar</option>
              <option value="needs-help">Hulp nodig bij teksten</option>
              <option value="none">Nog geen content</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Urgentie</label>
            <select class="form-select" id="deal-urgency">
              <option value="">Selecteer urgentie...</option>
              <option value="asap">Zo snel mogelijk</option>
              <option value="1-month">Binnen 1 maand</option>
              <option value="2-3-months">2-3 maanden</option>
              <option value="flexible">Flexibel</option>
            </select>
          </div>
        </div>

        <!-- Step 5: Overzicht & bevestiging -->
        <div class="wizard-step" id="wizard-step-5" style="display:none;">
          <h3 class="wizard-step-title">Overzicht & bevestiging</h3>
          <div id="deal-summary" class="deal-summary"></div>
          <div class="form-group">
            <label class="form-label">Speciale wensen of opmerkingen</label>
            <textarea class="form-input" id="deal-special-requests" rows="4" placeholder="Eventuele aanvullende informatie..."></textarea>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" id="wizard-prev-btn" onclick="prevStep()" style="display:none;">Vorige</button>
        <button class="btn btn-secondary" onclick="closeModal('deal-modal')">Annuleren</button>
        <button class="btn btn-primary" id="wizard-next-btn" onclick="nextStep()">Volgende</button>
        <button class="btn btn-primary" id="save-deal-btn" onclick="saveDeal()" style="display:none;">Opslaan</button>
      </div>
    </div>
  </div>

  <!-- Deal Detail Modal -->
  <div class="modal-overlay" id="detail-modal">
    <div class="modal" style="max-width:560px;">
      <div class="modal-header">
        <span class="modal-title" id="detail-modal-title">Deal details</span>
        <button class="modal-close" onclick="closeModal('detail-modal')"><i data-lucide="x"></i></button>
      </div>
      <div class="modal-body" id="detail-modal-body"></div>
    </div>
  </div>

  <script src="assets/js/config.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/components.js"></script>
  <script src="assets/js/sidebar.js"></script>
  <script>
    let currentPage = 1;
    let packages = [];
    let upsells = [];
    let editingDealId = null;
    let currentWizardStep = 1;
    const totalWizardSteps = 5;

    async function init() {
      if (!await requireLogin()) return;
      initSidebar();
      initTopbar('Deals');
      lucide.createIcons();
      loadDeals();

      const params = new URLSearchParams(window.location.search);
      const newDealLeadId = params.get('newDeal');
      if (newDealLeadId) {
        history.replaceState(null, '', basePath('/deals.html'));
        setTimeout(() => openNewDealModal(newDealLeadId), 500);
      }
    }

    async function loadDeals() {
      try {
        const data = await API.get(`/deals?page=${currentPage}&limit=50`);
        renderDeals(data);
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    function renderDeals(data) {
      const tbody = document.getElementById('deals-body');
      if (data.deals.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted" style="padding:40px;">Geen deals gevonden</td></tr>`;
        return;
      }

      tbody.innerHTML = data.deals.map(deal => {
        const upsellTags = deal.upsells.map(u =>
          `<span style="background:var(--accent-purple-dim);color:var(--accent-purple);padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-right:4px;">${u.upsell.name}</span>`
        ).join('');

        return `
          <tr>
            <td style="font-weight:500;">${deal.lead.companyName}</td>
            <td><span style="background:var(--accent-blue-dim);color:var(--accent-blue);padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;">${deal.package.name}</span></td>
            <td>${upsellTags || '-'}</td>
            <td>${formatCurrency(deal.package.oneTimePrice)}</td>
            <td>${formatCurrency(deal.package.monthlyPrice)}/mnd</td>
            <td>${formatCurrency(deal.acquisitionCost)}</td>
            <td style="font-weight:700;color:var(--accent-brand);">${formatCurrency(deal.totalValue)}</td>
            <td style="color:var(--text-muted);">${formatDate(deal.saleDate)}</td>
            <td>
              <button class="btn-icon" onclick="viewDeal('${deal.id}')" title="Bekijken">
                <i data-lucide="eye" style="width:16px;height:16px;"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');

      renderPagination(document.getElementById('pagination'), data, (page) => { currentPage = page; loadDeals(); });
      lucide.createIcons();
    }

    async function openNewDealModal(preselectedLeadId) {
      editingDealId = null;
      document.getElementById('deal-modal-title').textContent = 'Nieuwe deal';
      document.getElementById('deal-lead').disabled = false;

      try {
        const [pkgs, ups, leadsData] = await Promise.all([
          API.get('/packages'),
          API.get('/packages/upsells'),
          API.get('/leads?limit=1000&status=')
        ]);
        packages = pkgs;
        upsells = ups;

        const leadSelect = document.getElementById('deal-lead');
        leadSelect.innerHTML = `<option value="">Selecteer een lead...</option>` +
          leadsData.leads.map(l =>
            `<option value="${l.id}" ${l.id === preselectedLeadId ? 'selected' : ''}>${l.companyName}${l.city ? ' - ' + l.city : ''}</option>`
          ).join('');

        const pkgSelect = document.getElementById('deal-package');
        pkgSelect.innerHTML = packages.map(p =>
          `<option value="${p.id}">${p.name} - ${formatCurrency(p.oneTimePrice)}</option>`
        ).join('');

        const upsellsDiv = document.getElementById('deal-upsells');
        upsellsDiv.innerHTML = upsells.map(u => `
          <label style="display:flex;align-items:center;gap:8px;padding:6px 0;cursor:pointer;">
            <input type="checkbox" value="${u.id}" class="upsell-checkbox">
            <span style="font-size:13px;">${u.name} - ${formatCurrency(u.price)}${u.billingType === 'MONTHLY' ? '/mnd' : ''}</span>
          </label>
        `).join('');

        document.getElementById('deal-cost').value = '';
        document.getElementById('deal-date').value = new Date().toISOString().split('T')[0];

        pkgSelect.addEventListener('change', updateCalculation);
        document.querySelectorAll('.upsell-checkbox').forEach(cb => cb.addEventListener('change', updateCalculation));
        updateCalculation();

        currentWizardStep = 1;
        updateWizardUI();
        
        document.querySelectorAll('input[name="has-existing"]').forEach(radio => {
          radio.addEventListener('change', (e) => {
            document.getElementById('existing-url-group').style.display = e.target.value === 'true' ? 'block' : 'none';
          });
        });

        openModal('deal-modal');
        lucide.createIcons();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    function updateWizardUI() {
      for (let i = 1; i <= totalWizardSteps; i++) {
        const step = document.getElementById(`wizard-step-${i}`);
        if (step) step.style.display = i === currentWizardStep ? 'block' : 'none';
      }
      
      const progressBar = document.getElementById('wizard-progress-bar');
      progressBar.style.width = `${(currentWizardStep / totalWizardSteps) * 100}%`;
      
      document.getElementById('wizard-prev-btn').style.display = currentWizardStep > 1 ? 'inline-block' : 'none';
      document.getElementById('wizard-next-btn').style.display = currentWizardStep < totalWizardSteps ? 'inline-block' : 'none';
      document.getElementById('save-deal-btn').style.display = currentWizardStep === totalWizardSteps ? 'inline-block' : 'none';
      
      if (currentWizardStep === totalWizardSteps) {
        updateSummary();
      }
    }

    function nextStep() {
      if (!validateStep(currentWizardStep)) return;
      if (currentWizardStep < totalWizardSteps) {
        currentWizardStep++;
        updateWizardUI();
      }
    }

    function prevStep() {
      if (currentWizardStep > 1) {
        currentWizardStep--;
        updateWizardUI();
      }
    }

    function validateStep(step) {
      if (step === 1) {
        const leadId = document.getElementById('deal-lead').value;
        const packageId = document.getElementById('deal-package').value;
        if (!leadId) {
          showToast('Selecteer een lead', 'warning');
          return false;
        }
        if (!packageId) {
          showToast('Selecteer een pakket', 'warning');
          return false;
        }
      }
      return true;
    }

    function updateSummary() {
      const leadSelect = document.getElementById('deal-lead');
      const pkgSelect = document.getElementById('deal-package');
      const leadName = leadSelect.options[leadSelect.selectedIndex]?.text || '-';
      const pkgName = pkgSelect.options[pkgSelect.selectedIndex]?.text || '-';
      
      const selectedUpsells = Array.from(document.querySelectorAll('.upsell-checkbox:checked')).map(cb => {
        const upsell = upsells.find(u => u.id === cb.value);
        return upsell ? upsell.name : '';
      }).filter(Boolean);
      
      const websiteGoal = document.getElementById('deal-website-goal').value;
      const targetAudience = document.getElementById('deal-target-audience').value;
      const hasExisting = document.querySelector('input[name="has-existing"]:checked').value === 'true';
      const existingUrl = document.getElementById('deal-existing-url').value;
      const mood = document.getElementById('deal-mood').value;
      const heroType = document.getElementById('deal-hero-type').value;
      const tone = document.getElementById('deal-tone').value;
      const usps = document.getElementById('deal-usps').value;
      const cta = document.getElementById('deal-cta').value;
      const selectedFeatures = Array.from(document.querySelectorAll('.checkbox-group input:checked')).map(cb => cb.nextElementSibling.textContent);
      const languages = document.getElementById('deal-languages').value;
      const contentStatus = document.getElementById('deal-content-status').value;
      const urgency = document.getElementById('deal-urgency').value;
      
      document.getElementById('deal-summary').innerHTML = `
        <div style="display:grid;gap:16px;">
          <div>
            <h4 style="font-size:14px;font-weight:600;margin-bottom:8px;color:var(--text-primary);">Deal informatie</h4>
            <div style="display:grid;gap:6px;font-size:13px;">
              <div class="flex justify-between"><span class="text-muted">Lead:</span><span>${leadName}</span></div>
              <div class="flex justify-between"><span class="text-muted">Pakket:</span><span>${pkgName}</span></div>
              ${selectedUpsells.length > 0 ? `<div class="flex justify-between"><span class="text-muted">Upsells:</span><span>${selectedUpsells.join(', ')}</span></div>` : ''}
            </div>
          </div>
          
          ${websiteGoal || targetAudience ? `
          <div>
            <h4 style="font-size:14px;font-weight:600;margin-bottom:8px;color:var(--text-primary);">Website context</h4>
            <div style="display:grid;gap:6px;font-size:13px;">
              ${websiteGoal ? `<div class="flex justify-between"><span class="text-muted">Doel:</span><span>${document.querySelector(`#deal-website-goal option[value="${websiteGoal}"]`)?.text || websiteGoal}</span></div>` : ''}
              ${targetAudience ? `<div class="flex justify-between"><span class="text-muted">Doelgroep:</span><span>${targetAudience}</span></div>` : ''}
              ${hasExisting ? `<div class="flex justify-between"><span class="text-muted">Bestaande site:</span><span>${existingUrl || 'Ja'}</span></div>` : ''}
            </div>
          </div>
          ` : ''}
          
          ${mood || heroType || tone ? `
          <div>
            <h4 style="font-size:14px;font-weight:600;margin-bottom:8px;color:var(--text-primary);">Design & identiteit</h4>
            <div style="display:grid;gap:6px;font-size:13px;">
              ${mood ? `<div class="flex justify-between"><span class="text-muted">Sfeer:</span><span>${document.querySelector(`#deal-mood option[value="${mood}"]`)?.text || mood}</span></div>` : ''}
              ${heroType ? `<div class="flex justify-between"><span class="text-muted">Hero:</span><span>${document.querySelector(`#deal-hero-type option[value="${heroType}"]`)?.text || heroType}</span></div>` : ''}
              ${tone ? `<div class="flex justify-between"><span class="text-muted">Tone:</span><span>${document.querySelector(`#deal-tone option[value="${tone}"]`)?.text || tone}</span></div>` : ''}
            </div>
          </div>
          ` : ''}
          
          ${usps || cta || selectedFeatures.length > 0 ? `
          <div>
            <h4 style="font-size:14px;font-weight:600;margin-bottom:8px;color:var(--text-primary);">Strategie & content</h4>
            <div style="display:grid;gap:6px;font-size:13px;">
              ${usps ? `<div><span class="text-muted">USP's:</span><div style="margin-top:4px;">${usps}</div></div>` : ''}
              ${cta ? `<div class="flex justify-between"><span class="text-muted">CTA:</span><span>${cta}</span></div>` : ''}
              ${selectedFeatures.length > 0 ? `<div><span class="text-muted">Features:</span><div style="margin-top:4px;">${selectedFeatures.join(', ')}</div></div>` : ''}
              ${contentStatus ? `<div class="flex justify-between"><span class="text-muted">Content:</span><span>${document.querySelector(`#deal-content-status option[value="${contentStatus}"]`)?.text || contentStatus}</span></div>` : ''}
              ${urgency ? `<div class="flex justify-between"><span class="text-muted">Urgentie:</span><span>${document.querySelector(`#deal-urgency option[value="${urgency}"]`)?.text || urgency}</span></div>` : ''}
            </div>
          </div>
          ` : ''}
        </div>
      `;
    }

    function updateCalculation() {
      const pkgId = document.getElementById('deal-package').value;
      const pkg = packages.find(p => p.id === pkgId);
      if (!pkg) return;

      const selectedUpsells = Array.from(document.querySelectorAll('.upsell-checkbox:checked')).map(cb => {
        return upsells.find(u => u.id === cb.value);
      }).filter(Boolean);

      const upsellOneTime = selectedUpsells.filter(u => u.billingType === 'ONE_TIME').reduce((s, u) => s + u.price, 0);
      const upsellMonthly = selectedUpsells.filter(u => u.billingType === 'MONTHLY').reduce((s, u) => s + u.price, 0);
      const totalMonthly = pkg.monthlyPrice + upsellMonthly;
      const yearlyValue = pkg.oneTimePrice + upsellOneTime + (totalMonthly * 12);

      document.getElementById('deal-calculation').innerHTML = `
        <div class="flex justify-between" style="margin-bottom:6px;"><span class="text-muted">Eenmalig pakket</span><span>${formatCurrency(pkg.oneTimePrice)}</span></div>
        ${upsellOneTime > 0 ? `<div class="flex justify-between" style="margin-bottom:6px;"><span class="text-muted">Eenmalige upsells</span><span>${formatCurrency(upsellOneTime)}</span></div>` : ''}
        <div class="flex justify-between" style="margin-bottom:6px;"><span class="text-muted">Maandelijks (hosting)</span><span>${formatCurrency(pkg.monthlyPrice)}/mnd</span></div>
        ${upsellMonthly > 0 ? `<div class="flex justify-between" style="margin-bottom:6px;"><span class="text-muted">Maandelijkse upsells</span><span>${formatCurrency(upsellMonthly)}/mnd</span></div>` : ''}
        <hr style="border-color:var(--border-color);margin:8px 0;">
        <div class="flex justify-between"><span style="font-weight:600;">Jaarwaarde (12 mnd)</span><span style="font-weight:700;color:var(--accent-brand);">${formatCurrency(yearlyValue)}</span></div>
      `;
    }

    async function saveDeal() {
      const leadId = document.getElementById('deal-lead').value;
      const packageId = document.getElementById('deal-package').value;
      const upsellIds = Array.from(document.querySelectorAll('.upsell-checkbox:checked')).map(cb => cb.value);
      const acquisitionCost = document.getElementById('deal-cost').value || 0;
      const saleDate = document.getElementById('deal-date').value;

      if (!leadId) return showToast('Selecteer een lead', 'warning');
      if (!packageId) return showToast('Selecteer een pakket', 'warning');

      const websiteGoal = document.getElementById('deal-website-goal').value || null;
      const targetAudience = document.getElementById('deal-target-audience').value || null;
      const hasExistingWebsite = document.querySelector('input[name="has-existing"]:checked').value === 'true';
      const existingWebsiteUrl = document.getElementById('deal-existing-url').value || null;
      const mood = document.getElementById('deal-mood').value || null;
      const heroType = document.getElementById('deal-hero-type').value || null;
      const toneOfVoice = document.getElementById('deal-tone').value || null;
      const usps = document.getElementById('deal-usps').value || null;
      const primaryCta = document.getElementById('deal-cta').value || null;
      const selectedFeatures = Array.from(document.querySelectorAll('.checkbox-group input:checked')).map(cb => cb.value);
      const features = selectedFeatures.length > 0 ? selectedFeatures.join(',') : null;
      const languages = document.getElementById('deal-languages').value || null;
      const contentStatus = document.getElementById('deal-content-status').value || null;
      const urgency = document.getElementById('deal-urgency').value || null;
      const specialRequests = document.getElementById('deal-special-requests').value || null;

      const dealData = {
        packageId, upsellIds, acquisitionCost, saleDate,
        websiteGoal, targetAudience, hasExistingWebsite, existingWebsiteUrl,
        mood, heroType, toneOfVoice, usps, primaryCta,
        features, languages, contentStatus, urgency, specialRequests
      };

      if (!editingDealId) {
        dealData.leadId = leadId;
      }

      try {
        if (editingDealId) {
          await API.put(`/deals/${editingDealId}`, dealData);
          showToast('Deal bijgewerkt');
        } else {
          await API.post('/deals', dealData);
          showToast('Deal aangemaakt');
        }
        closeModal('deal-modal');
        loadDeals();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function viewDeal(id) {
      try {
        const deal = await API.get(`/deals/${id}`);
        document.getElementById('detail-modal-title').textContent = deal.lead.companyName;

        const upsellList = deal.upsells.map(u =>
          `<span style="background:var(--accent-purple-dim);color:var(--accent-purple);padding:3px 10px;border-radius:12px;font-size:12px;font-weight:600;margin-right:4px;">${u.upsell.name} - ${formatCurrency(u.upsell.price)}${u.upsell.billingType === 'MONTHLY' ? '/mnd' : ''}</span>`
        ).join('') || '<span class="text-muted">Geen</span>';

        document.getElementById('detail-modal-body').innerHTML = `
          <div style="display:flex;flex-direction:column;gap:14px;">
            <div class="flex justify-between items-center">
              <span class="text-muted">Bedrijf</span>
              <span style="font-weight:600;">${deal.lead.companyName}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-muted">Gemeente</span>
              <span>${deal.lead.city || '-'}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-muted">Pakket</span>
              <span style="font-weight:600;">${deal.package.name}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-muted">Eenmalige prijs</span>
              <span>${formatCurrency(deal.package.oneTimePrice)}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-muted">Maandelijks</span>
              <span>${formatCurrency(deal.package.monthlyPrice)}/mnd</span>
            </div>
            <div>
              <span class="text-muted" style="display:block;margin-bottom:6px;">Upsells</span>
              <div>${upsellList}</div>
            </div>
            <hr style="border-color:var(--border-color);">
            <div class="flex justify-between items-center">
              <span class="text-muted">Acquisitiekost</span>
              <span style="font-weight:600;">${formatCurrency(deal.acquisitionCost)}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-muted">Totale dealwaarde</span>
              <span style="font-weight:700;font-size:18px;color:var(--accent-brand);">${formatCurrency(deal.totalValue)}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-muted">ROI</span>
              <span style="font-weight:700;color:var(--accent-brand);">${deal.acquisitionCost > 0 ? (((deal.totalValue - deal.acquisitionCost) / deal.acquisitionCost) * 100).toFixed(1) : '0'}%</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-muted">Datum verkoop</span>
              <span>${formatDate(deal.saleDate)}</span>
            </div>
            <hr style="border-color:var(--border-color);">
            <div style="display:flex;gap:8px;justify-content:flex-end;">
              <button class="btn btn-secondary btn-sm" onclick="closeModal('detail-modal');editDeal('${deal.id}')">
                <i data-lucide="pencil" style="width:14px;height:14px;"></i> Bewerken
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteDeal('${deal.id}')">
                <i data-lucide="trash-2" style="width:14px;height:14px;"></i> Verwijderen
              </button>
            </div>
          </div>
        `;

        openModal('detail-modal');
        lucide.createIcons();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function editDeal(id) {
      try {
        const deal = await API.get(`/deals/${id}`);
        editingDealId = id;
        document.getElementById('deal-modal-title').textContent = 'Deal bewerken';

        const [pkgs, ups] = await Promise.all([
          API.get('/packages'),
          API.get('/packages/upsells')
        ]);
        packages = pkgs;
        upsells = ups;

        const leadSelect = document.getElementById('deal-lead');
        leadSelect.innerHTML = `<option value="${deal.leadId}" selected>${deal.lead.companyName}${deal.lead.city ? ' - ' + deal.lead.city : ''}</option>`;
        leadSelect.disabled = true;

        const pkgSelect = document.getElementById('deal-package');
        pkgSelect.innerHTML = packages.map(p =>
          `<option value="${p.id}" ${p.id === deal.packageId ? 'selected' : ''}>${p.name} - ${formatCurrency(p.oneTimePrice)}</option>`
        ).join('');

        const dealUpsellIds = deal.upsells.map(u => u.upsellId);
        const upsellsDiv = document.getElementById('deal-upsells');
        upsellsDiv.innerHTML = upsells.map(u => `
          <label style="display:flex;align-items:center;gap:8px;padding:6px 0;cursor:pointer;">
            <input type="checkbox" value="${u.id}" class="upsell-checkbox" ${dealUpsellIds.includes(u.id) ? 'checked' : ''}>
            <span style="font-size:13px;">${u.name} - ${formatCurrency(u.price)}${u.billingType === 'MONTHLY' ? '/mnd' : ''}</span>
          </label>
        `).join('');

        document.getElementById('deal-cost').value = deal.acquisitionCost || '';
        document.getElementById('deal-date').value = deal.saleDate ? deal.saleDate.split('T')[0] : '';

        pkgSelect.addEventListener('change', updateCalculation);
        document.querySelectorAll('.upsell-checkbox').forEach(cb => cb.addEventListener('change', updateCalculation));
        updateCalculation();

        openModal('deal-modal');
        lucide.createIcons();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function deleteDeal(id) {
      if (!confirm('Weet je zeker dat je deze deal wilt verwijderen?')) return;
      try {
        await API.delete(`/deals/${id}`);
        showToast('Deal verwijderd');
        closeModal('detail-modal');
        loadDeals();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    init();
  </script>
</body>
</html>
