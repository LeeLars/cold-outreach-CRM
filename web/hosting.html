<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="favicon.png">
  <title>Hosting - Cold Outreach CRM</title>
  <link rel="stylesheet" href="assets/css/global.css">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <div class="app-layout">
    <aside class="sidebar" id="sidebar"></aside>
    <div class="main-content">
      <header class="topbar" id="topbar"></header>
      <main class="page-content">
        <div class="kpi-grid" style="grid-template-columns:repeat(4,1fr);" id="hosting-kpis"></div>

        <div id="hosting-alerts" style="margin-bottom:20px;"></div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Hosting klanten</span>
            <input type="text" id="hosting-search" class="form-input" placeholder="Zoek klant..." style="width:250px;" oninput="filterHostingTable()">
          </div>
          <div class="card-body" style="padding:0;">
            <div style="max-height:700px;overflow-y:auto;">
              <table class="data-table" style="font-size:13px;">
                <thead style="position:sticky;top:0;background:var(--bg-card);z-index:10;">
                  <tr>
                    <th style="cursor:pointer;" onclick="sortTable('companyName')">
                      Bedrijf <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                    </th>
                    <th>Gemeente</th>
                    <th>Pakket</th>
                    <th style="text-align:right;cursor:pointer;" onclick="sortTable('hostingPrice')">
                      Prijs <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                    </th>
                    <th>Interval</th>
                    <th style="cursor:pointer;" onclick="sortTable('hostingStartDate')">
                      Startdatum <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                    </th>
                    <th style="cursor:pointer;" onclick="sortTable('hostingEndDate')">
                      Einddatum <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                    </th>
                    <th style="cursor:pointer;" onclick="sortTable('nextInvoiceDate')">
                      Volgende factuur <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                    </th>
                    <th>Status</th>
                    <th style="text-align:center;">Acties</th>
                  </tr>
                </thead>
                <tbody id="hosting-table-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Hosting Edit Modal -->
  <div class="modal-overlay" id="hosting-edit-modal" style="display:none;" onclick="if(event.target===this)closeHostingModal()">
    <div class="modal" style="max-width:500px;">
      <div class="modal-header">
        <h3 class="modal-title">Hosting bewerken</h3>
        <button class="btn-icon" onclick="closeHostingModal()"><i data-lucide="x"></i></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="hosting-edit-id">
        <div class="form-group">
          <label class="form-label">Bedrijf</label>
          <input type="text" id="hosting-edit-company" class="form-input" disabled>
        </div>
        <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="form-group">
            <label class="form-label">Prijs</label>
            <input type="number" step="0.01" id="hosting-edit-price" class="form-input">
          </div>
          <div class="form-group">
            <label class="form-label">Interval</label>
            <select id="hosting-edit-interval" class="form-select">
              <option value="MONTHLY">Maandelijks</option>
              <option value="YEARLY">Jaarlijks</option>
            </select>
          </div>
        </div>
        <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="form-group">
            <label class="form-label">Startdatum</label>
            <input type="date" id="hosting-edit-start" class="form-input">
          </div>
          <div class="form-group">
            <label class="form-label">Einddatum</label>
            <input type="date" id="hosting-edit-end" class="form-input">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Volgende factuurdatum</label>
          <input type="date" id="hosting-edit-invoice" class="form-input">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeHostingModal()">Annuleren</button>
        <button class="btn btn-primary" onclick="saveHosting()">Opslaan</button>
      </div>
    </div>
  </div>

  <script src="assets/js/config.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/components.js"></script>
  <script src="assets/js/sidebar.js"></script>
  <script>
    let hostingData = [];
    let sortColumn = 'nextInvoiceDate';
    let sortDirection = 'asc';

    async function init() {
      if (!await requireLogin()) return;
      initSidebar();
      initTopbar('Hosting');
      lucide.createIcons();
      loadHosting();
    }

    async function loadHosting() {
      try {
        const data = await API.get('/stats/hosting');
        hostingData = data.clients || [];

        const fmt = (v) => formatCurrency(v);

        document.getElementById('hosting-kpis').innerHTML = `
          <div class="kpi-card">
            <div class="kpi-label">Hosting klanten</div>
            <div class="kpi-value">${data.totalClients}</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Maandelijkse omzet</div>
            <div class="kpi-value">${fmt(data.monthlyRevenue)}</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Jaarlijkse omzet</div>
            <div class="kpi-value">${fmt(data.yearlyRevenue)}</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Gem. per klant/mnd</div>
            <div class="kpi-value">${fmt(data.avgPerClient)}</div>
          </div>
        `;

        let alertsHtml = '';
        if (data.needsInvoicing > 0) {
          alertsHtml += `
            <div style="padding:12px 16px;background:var(--accent-red-dim);border:1px solid var(--accent-red);border-radius:var(--radius-sm);margin-bottom:8px;font-size:13px;">
              <strong style="color:var(--accent-red);">${data.needsInvoicing} klant(en)</strong> moeten gefactureerd worden (factuurdatum verstreken)
            </div>`;
        }
        if (data.upcomingInvoices > 0) {
          alertsHtml += `
            <div style="padding:12px 16px;background:var(--accent-orange-dim);border:1px solid var(--accent-orange);border-radius:var(--radius-sm);margin-bottom:8px;font-size:13px;">
              <strong style="color:var(--accent-orange);">${data.upcomingInvoices} klant(en)</strong> moeten binnen 30 dagen gefactureerd worden
            </div>`;
        }
        if (data.expiringSoon > 0) {
          alertsHtml += `
            <div style="padding:12px 16px;background:var(--accent-orange-dim);border:1px solid var(--accent-orange);border-radius:var(--radius-sm);margin-bottom:8px;font-size:13px;">
              <strong style="color:var(--accent-orange);">${data.expiringSoon} hosting(s)</strong> verlopen binnen 30 dagen
            </div>`;
        }
        document.getElementById('hosting-alerts').innerHTML = alertsHtml;

        renderTable(hostingData);
        lucide.createIcons();
      } catch (err) {
        console.error('Hosting error:', err);
      }
    }

    function renderTable(data) {
      const fmtDate = (d) => d ? new Date(d).toLocaleDateString('nl-BE') : '-';

      const sorted = [...data].sort((a, b) => {
        let aVal = a[sortColumn];
        let bVal = b[sortColumn];

        if (sortColumn.includes('Date')) {
          aVal = aVal ? new Date(aVal).getTime() : (sortDirection === 'asc' ? Infinity : -Infinity);
          bVal = bVal ? new Date(bVal).getTime() : (sortDirection === 'asc' ? Infinity : -Infinity);
        } else if (typeof aVal === 'string') {
          aVal = (aVal || '').toLowerCase();
          bVal = (bVal || '').toLowerCase();
        }

        return sortDirection === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
      });

      const statusBadge = (status) => {
        const map = {
          active: { label: 'Actief', color: 'var(--accent-green)', bg: 'var(--accent-green-dim)' },
          overdue: { label: 'Te factureren', color: 'var(--accent-red)', bg: 'var(--accent-red-dim)' },
          expiring: { label: 'Verloopt binnenkort', color: 'var(--accent-orange)', bg: 'var(--accent-orange-dim)' },
          expired: { label: 'Verlopen', color: 'var(--accent-red)', bg: 'var(--accent-red-dim)' }
        };
        const s = map[status] || map.active;
        return `<span style="background:${s.bg};color:${s.color};padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;">${s.label}</span>`;
      };

      document.getElementById('hosting-table-body').innerHTML = sorted.map(c => `
        <tr style="cursor:pointer;" onclick="openHostingEdit('${c.id}')">
          <td style="font-weight:500;">${c.companyName}</td>
          <td>${c.city || '-'}</td>
          <td>${c.packageName}</td>
          <td style="text-align:right;font-weight:600;">${formatCurrency(c.hostingPrice)}</td>
          <td>${c.hostingInterval === 'YEARLY' ? 'Jaarlijks' : 'Maandelijks'}</td>
          <td>${fmtDate(c.hostingStartDate)}</td>
          <td>${fmtDate(c.hostingEndDate)}</td>
          <td style="${c.status === 'overdue' ? 'font-weight:600;color:var(--accent-red);' : ''}">${fmtDate(c.nextInvoiceDate)}</td>
          <td>${statusBadge(c.status)}</td>
          <td style="text-align:center;" onclick="event.stopPropagation()">
            <div style="display:flex;gap:4px;justify-content:center;">
              <button class="btn-icon" onclick="openHostingEdit('${c.id}')" title="Bewerken"><i data-lucide="pencil" style="width:14px;height:14px;"></i></button>
              <button class="btn-icon" onclick="deleteHosting('${c.id}','${c.companyName.replace(/'/g, "\\'")}')" 
                title="Verwijderen" style="color:var(--accent-red);"><i data-lucide="trash-2" style="width:14px;height:14px;"></i></button>
            </div>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-muted);">Geen hosting klanten gevonden</td></tr>';
    }

    function sortTable(column) {
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = column.includes('Date') ? 'asc' : 'desc';
      }
      renderTable(hostingData);
    }

    function filterHostingTable() {
      const search = document.getElementById('hosting-search').value.toLowerCase();
      const filtered = hostingData.filter(c =>
        c.companyName.toLowerCase().includes(search) ||
        (c.city || '').toLowerCase().includes(search) ||
        (c.packageName || '').toLowerCase().includes(search)
      );
      renderTable(filtered);
    }

    function openHostingEdit(dealId) {
      const item = hostingData.find(c => c.id === dealId);
      if (!item) return;
      document.getElementById('hosting-edit-id').value = item.id;
      document.getElementById('hosting-edit-company').value = item.companyName;
      document.getElementById('hosting-edit-price').value = item.hostingPrice;
      document.getElementById('hosting-edit-interval').value = item.hostingInterval;
      document.getElementById('hosting-edit-start').value = item.hostingStartDate ? item.hostingStartDate.slice(0, 10) : '';
      document.getElementById('hosting-edit-end').value = item.hostingEndDate ? item.hostingEndDate.slice(0, 10) : '';
      document.getElementById('hosting-edit-invoice').value = item.nextInvoiceDate ? item.nextInvoiceDate.slice(0, 10) : '';
      document.getElementById('hosting-edit-modal').style.display = 'flex';
      lucide.createIcons();
    }

    function closeHostingModal() {
      document.getElementById('hosting-edit-modal').style.display = 'none';
    }

    async function saveHosting() {
      const id = document.getElementById('hosting-edit-id').value;
      try {
        await API.put('/deals/' + id + '/hosting', {
          hostingPrice: parseFloat(document.getElementById('hosting-edit-price').value),
          hostingInterval: document.getElementById('hosting-edit-interval').value,
          hostingStartDate: document.getElementById('hosting-edit-start').value || null,
          hostingEndDate: document.getElementById('hosting-edit-end').value || null,
          nextInvoiceDate: document.getElementById('hosting-edit-invoice').value || null
        });
        closeHostingModal();
        showToast('Hosting bijgewerkt', 'success');
        loadHosting();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function deleteHosting(dealId, companyName) {
      if (!confirm('Hosting verwijderen voor ' + companyName + '? De deal blijft bestaan maar hosting wordt uitgeschakeld.')) return;
      try {
        await API.delete('/deals/' + dealId + '/hosting');
        showToast('Hosting verwijderd voor ' + companyName, 'success');
        loadHosting();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    init();
  </script>
</body>
</html>
