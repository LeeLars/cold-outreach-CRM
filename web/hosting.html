<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="icon" type="image/png" href="favicon.png">
  <title>Hosting - Cold Outreach CRM</title>
  <link rel="stylesheet" href="assets/css/global.css">
  <script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.min.js"></script>
</head>
<body>
  <div class="app-layout">
    <aside class="sidebar" id="sidebar"></aside>
    <div class="main-content">
      <header class="topbar" id="topbar"></header>
      <main class="page-content">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
          <h2 style="font-size:18px;font-weight:700;color:var(--text-primary);margin:0;">Hosting overzicht</h2>
          <div style="display:flex;align-items:center;gap:8px;">
            <label style="font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">Boekjaar</label>
            <select id="year-selector" class="form-select" style="width:120px;" onchange="changeYear()"></select>
          </div>
        </div>
        <div class="kpi-grid" style="grid-template-columns:repeat(4,1fr);" id="hosting-kpis"></div>

        <div id="hosting-alerts" style="margin-bottom:20px;"></div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Hosting klanten</span>
            <input type="text" id="hosting-search" class="form-input" placeholder="Zoek klant..." style="width:250px;" oninput="filterHostingTable()">
          </div>
          <div class="card-body" style="padding:0;">
            <div style="max-height:700px;overflow-y:auto;">
              <table class="data-table" style="font-size:13px;">
                <thead style="position:sticky;top:0;background:var(--bg-card);z-index:10;">
                  <tr>
                    <th style="cursor:pointer;" onclick="sortTable('companyName')">
                      Bedrijf <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                    </th>
                    <th>Gemeente</th>
                    <th>Pakket</th>
                    <th style="text-align:right;cursor:pointer;" onclick="sortTable('hostingPrice')">
                      Prijs/mnd <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                    </th>
                    <th>Per jaar</th>
                    <th style="cursor:pointer;" onclick="sortTable('hostingStartDate')">
                      Startdatum <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                    </th>
                    <th style="cursor:pointer;" onclick="sortTable('hostingEndDate')">
                      Einddatum <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                    </th>
                    <th style="cursor:pointer;" onclick="sortTable('nextInvoiceDate')">
                      Volgende factuur <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                    </th>
                    <th>Status</th>
                    <th style="text-align:center;">Acties</th>
                  </tr>
                </thead>
                <tbody id="hosting-table-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Hosting Edit Modal -->
  <div class="modal-overlay" id="hosting-edit-modal" onclick="if(event.target===this)closeHostingModal()">
    <div class="modal" style="max-width:500px;">
      <div class="modal-header">
        <h3 class="modal-title">Hosting bewerken</h3>
        <button class="btn-icon" onclick="closeHostingModal()"><i data-lucide="x"></i></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="hosting-edit-id">
        <div class="form-group">
          <label class="form-label">Bedrijf</label>
          <input type="text" id="hosting-edit-company" class="form-input" disabled>
        </div>
        <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="form-group">
            <label class="form-label">Hosting prijs per maand</label>
            <select id="hosting-edit-price" class="form-select">
              <option value="15">€15/mnd (€180/jaar)</option>
              <option value="20">€20/mnd (€240/jaar)</option>
            </select>
            <input type="hidden" id="hosting-edit-interval" value="MONTHLY">
          </div>
          <div class="form-group">
            <label class="form-label" style="color:var(--accent-orange);">Hosting kostprijs /mnd <span style="font-weight:400;font-size:11px;color:var(--text-muted);">(wat betaal jij)</span></label>
            <input type="number" id="hosting-edit-cost" class="form-input" placeholder="0.00" step="0.01" min="0" value="0">
          </div>
        </div>
        <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="form-group">
            <label class="form-label" style="color:var(--accent-orange);">Domein kost <span style="font-weight:400;font-size:11px;color:var(--text-muted);">(eenmalig aankoop/verhuis)</span></label>
            <input type="number" id="hosting-edit-domain" class="form-input" placeholder="0.00" step="0.01" min="0" value="0">
          </div>
          <div class="form-group">
            <label class="form-label" style="color:var(--accent-orange);">Email pakket /mnd <span style="font-weight:400;font-size:11px;color:var(--text-muted);">(bv. Google Workspace)</span></label>
            <input type="number" id="hosting-edit-email" class="form-input" placeholder="0.00" step="0.01" min="0" value="0">
          </div>
        </div>
        <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="form-group">
            <label class="form-label">Startdatum</label>
            <input type="date" id="hosting-edit-start" class="form-input">
          </div>
          <div class="form-group">
            <label class="form-label">Einddatum</label>
            <input type="date" id="hosting-edit-end" class="form-input">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Volgende factuurdatum</label>
          <input type="date" id="hosting-edit-invoice" class="form-input">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeHostingModal()">Annuleren</button>
        <button class="btn btn-primary" onclick="saveHosting()">Opslaan</button>
      </div>
    </div>
  </div>

  <script src="assets/js/config.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/components.js"></script>
  <script src="assets/js/sidebar.js"></script>
  <script src="assets/js/tooltips.js"></script>
  <script>
    let hostingData = [];
    let sortColumn = 'nextInvoiceDate';
    let sortDirection = 'asc';
    let selectedYear = new Date().getFullYear();

    async function init() {
      if (!await requireLogin()) return;
      initSidebar();
      initTopbar('Hosting');
      populateYearSelector();
      loadHosting();
    }

    function populateYearSelector() {
      const now = new Date().getFullYear();
      const startYear = 2025;
      const sel = document.getElementById('year-selector');
      sel.innerHTML = '';
      for (let y = now + 1; y >= startYear; y--) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        if (y === selectedYear) opt.selected = true;
        sel.appendChild(opt);
      }
    }

    function changeYear() {
      selectedYear = parseInt(document.getElementById('year-selector').value);
      loadHosting();
    }

    async function loadHosting() {
      try {
        const data = await API.get('/stats/hosting?year=' + selectedYear);
        hostingData = data.clients || [];

        const fmt = (v) => formatCurrency(v);

        const yr = data.currentYear || new Date().getFullYear();
        const qt = data.quarterTotals || {};
        const qLabels = { Q1: 'jan-mrt', Q2: 'apr-jun', Q3: 'jul-sep', Q4: 'okt-dec' };
        
        document.getElementById('hosting-kpis').innerHTML = `
          <div class="kpi-card">
            ${wrapWithTooltip('<div class="kpi-label">Hosting klanten</div>', 'hosting-klanten')}
            <div class="kpi-value">${data.totalClients}</div>
          </div>
          <div class="kpi-card">
            ${wrapWithTooltip('<div class="kpi-label">MRR (hosting)</div>', 'hosting-mrr')}
            <div class="kpi-value">${fmt(data.totalMRR || 0)}</div>
          </div>
          <div class="kpi-card" style="border-left-color:#34d399;">
            ${wrapWithTooltip(`<div class="kpi-label">Hosting omzet ${yr}</div>`, 'hosting-omzet-jaar')}
            <div class="kpi-value" style="color:#34d399;">${fmt(data.totalCurrentYear || 0)}</div>
            <div style="font-size:11px;color:var(--text-muted);margin-top:6px;">
              ${['Q1','Q2','Q3','Q4'].map(q => `${q}: ${fmt(qt[q] || 0)}`).join(' | ')}
            </div>
          </div>
          <div class="kpi-card">
            ${wrapWithTooltip('<div class="kpi-label">Gem. per klant/mnd</div>', 'hosting-gem-klant')}
            <div class="kpi-value">${fmt(data.avgPerClient)}</div>
          </div>
        `;

        // Filter clients needing invoicing (overdue)
        const overdueClients = hostingData.filter(c => c.status === 'overdue');
        
        // Filter clients with upcoming invoices (within 30 days)
        const upcomingClients = hostingData.filter(c => {
          if (!c.nextInvoiceDate) return false;
          const invoiceDate = new Date(c.nextInvoiceDate);
          const now = new Date();
          const in30Days = new Date();
          in30Days.setDate(in30Days.getDate() + 30);
          return invoiceDate > now && invoiceDate <= in30Days;
        });

        let alertsHtml = '';
        
        // Overdue invoices alert
        if (overdueClients.length > 0) {
          alertsHtml += `
            <div style="padding:12px 16px;background:var(--accent-red-dim);border:1px solid var(--accent-red);border-radius:var(--radius-sm);margin-bottom:8px;font-size:13px;">
              <strong style="color:var(--accent-red);">${overdueClients.length} klant(en)</strong> moeten gefactureerd worden (factuurdatum verstreken):
              <div style="margin-top:8px;padding-left:8px;">
                ${overdueClients.map(c => `<div style="font-size:12px;margin-top:4px;">• ${c.companyName} (${new Date(c.nextInvoiceDate).toLocaleDateString('nl-BE')})</div>`).join('')}
              </div>
            </div>`;
        }
        
        // Upcoming invoices alert (within 30 days)
        if (upcomingClients.length > 0) {
          alertsHtml += `
            <div style="padding:12px 16px;background:var(--accent-orange-dim);border:1px solid var(--accent-orange);border-radius:var(--radius-sm);margin-bottom:8px;font-size:13px;">
              <strong style="color:var(--accent-orange);">${upcomingClients.length} klant(en)</strong> moeten binnen 30 dagen gefactureerd worden:
              <div style="margin-top:8px;padding-left:8px;">
                ${upcomingClients.map(c => {
                  const invoiceDate = new Date(c.nextInvoiceDate);
                  const now = new Date();
                  const daysUntil = Math.ceil((invoiceDate - now) / (1000 * 60 * 60 * 24));
                  return `<div style="font-size:12px;margin-top:4px;">• ${c.companyName} (${invoiceDate.toLocaleDateString('nl-BE')} - ${daysUntil} dag${daysUntil === 1 ? '' : 'en'})</div>`;
                }).join('')}
              </div>
            </div>`;
        }
        
        // Expiring hosting alert
        if (data.expiringSoon > 0) {
          const expiringClients = hostingData.filter(c => c.status === 'expiring');
          alertsHtml += `
            <div style="padding:12px 16px;background:var(--accent-orange-dim);border:1px solid var(--accent-orange);border-radius:var(--radius-sm);margin-bottom:8px;font-size:13px;">
              <strong style="color:var(--accent-orange);">${data.expiringSoon} hosting(s)</strong> verlopen binnen 30 dagen:
              <div style="margin-top:8px;padding-left:8px;">
                ${expiringClients.map(c => `<div style="font-size:12px;margin-top:4px;">• ${c.companyName} (${new Date(c.hostingEndDate).toLocaleDateString('nl-BE')})</div>`).join('')}
              </div>
            </div>`;
        }
        
        document.getElementById('hosting-alerts').innerHTML = alertsHtml;

        renderTable(hostingData);
        refreshIcons();
        
        // Re-initialize tooltips
        if (typeof initTooltipPositioning === 'function') {
          setTimeout(() => initTooltipPositioning(), 100);
        }
      } catch (err) {
        console.error('Hosting error:', err);
      }
    }

    function renderTable(data) {
      const fmtDate = (d) => d ? new Date(d).toLocaleDateString('nl-BE') : '-';

      const sorted = [...data].sort((a, b) => {
        let aVal = a[sortColumn];
        let bVal = b[sortColumn];

        if (sortColumn.includes('Date')) {
          aVal = aVal ? new Date(aVal).getTime() : (sortDirection === 'asc' ? Infinity : -Infinity);
          bVal = bVal ? new Date(bVal).getTime() : (sortDirection === 'asc' ? Infinity : -Infinity);
        } else if (typeof aVal === 'string') {
          aVal = (aVal || '').toLowerCase();
          bVal = (bVal || '').toLowerCase();
        }

        return sortDirection === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
      });

      const statusBadge = (status) => {
        const map = {
          active: { label: 'Actief', color: 'var(--accent-green)', bg: 'var(--accent-green-dim)' },
          overdue: { label: 'Te factureren', color: 'var(--accent-red)', bg: 'var(--accent-red-dim)' },
          expiring: { label: 'Verloopt binnenkort', color: 'var(--accent-orange)', bg: 'var(--accent-orange-dim)' },
          expired: { label: 'Verlopen', color: 'var(--accent-red)', bg: 'var(--accent-red-dim)' }
        };
        const s = map[status] || map.active;
        return `<span style="background:${s.bg};color:${s.color};padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;">${s.label}</span>`;
      };

      document.getElementById('hosting-table-body').innerHTML = sorted.map(c => `
        <tr style="cursor:pointer;" onclick="openHostingEdit('${c.id}')">
          <td style="font-weight:500;">${c.companyName}</td>
          <td>${c.city || '-'}</td>
          <td>${c.packageName}</td>
          <td style="text-align:right;font-weight:600;">${formatCurrency(c.hostingPrice)}/mnd</td>
          <td>${formatCurrency(c.hostingPrice * 12)}/jaar</td>
          <td>${fmtDate(c.hostingStartDate)}</td>
          <td>${fmtDate(c.hostingEndDate)}</td>
          <td style="${c.status === 'overdue' ? 'font-weight:600;color:var(--accent-red);' : ''}">${fmtDate(c.nextInvoiceDate)}</td>
          <td>${statusBadge(c.status)}</td>
          <td style="text-align:center;" onclick="event.stopPropagation()">
            <div style="display:flex;gap:4px;justify-content:center;">
              ${c.status === 'overdue' || c.status === 'due' ? `
              <button class="btn btn-sm" onclick="markInvoiceSent('${c.id}')" title="Factuur verstuurd" style="background:var(--accent-green);color:white;padding:4px 8px;font-size:11px;white-space:nowrap;">
                <i data-lucide="check" style="width:12px;height:12px;"></i> Verstuurd
              </button>
              ` : ''}
              <button class="btn-icon" onclick="openHostingEdit('${c.id}')" title="Bewerken"><i data-lucide="pencil" style="width:14px;height:14px;"></i></button>
              <button class="btn-icon" onclick="deleteHosting('${c.id}','${c.companyName.replace(/'/g, "\\'")}')" 
                title="Verwijderen" style="color:var(--accent-red);"><i data-lucide="trash-2" style="width:14px;height:14px;"></i></button>
            </div>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-muted);">Geen hosting klanten gevonden</td></tr>';
    }

    function sortTable(column) {
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = column.includes('Date') ? 'asc' : 'desc';
      }
      renderTable(hostingData);
    }

    function filterHostingTable() {
      const search = document.getElementById('hosting-search').value.toLowerCase();
      const filtered = hostingData.filter(c =>
        c.companyName.toLowerCase().includes(search) ||
        (c.city || '').toLowerCase().includes(search) ||
        (c.packageName || '').toLowerCase().includes(search)
      );
      renderTable(filtered);
    }

    function openHostingEdit(dealId) {
      const item = hostingData.find(c => c.id === dealId);
      if (!item) return;
      document.getElementById('hosting-edit-id').value = item.id;
      document.getElementById('hosting-edit-company').value = item.companyName;
      document.getElementById('hosting-edit-cost').value = item.hostingCostPrice || 0;
      document.getElementById('hosting-edit-domain').value = item.domainCost || 0;
      document.getElementById('hosting-edit-email').value = item.emailCostMonthly || 0;
      const priceSelect = document.getElementById('hosting-edit-price');
      const priceVal = item.hostingPrice;
      if (priceVal == 15 || priceVal == 20) {
        priceSelect.value = priceVal;
      } else {
        const opt = document.createElement('option');
        opt.value = priceVal;
        opt.textContent = `€${priceVal}/mnd (€${priceVal * 12}/jaar)`;
        priceSelect.appendChild(opt);
        priceSelect.value = priceVal;
      }
      document.getElementById('hosting-edit-start').value = item.hostingStartDate ? item.hostingStartDate.slice(0, 10) : '';
      document.getElementById('hosting-edit-end').value = item.hostingEndDate ? item.hostingEndDate.slice(0, 10) : '';
      document.getElementById('hosting-edit-invoice').value = item.nextInvoiceDate ? item.nextInvoiceDate.slice(0, 10) : '';
      document.getElementById('hosting-edit-modal').classList.add('active');
      refreshIcons();
    }

    function closeHostingModal() {
      document.getElementById('hosting-edit-modal').classList.remove('active');
    }

    async function saveHosting() {
      const id = document.getElementById('hosting-edit-id').value;
      try {
        await API.put('/deals/' + id + '/hosting', {
          hostingPrice: parseFloat(document.getElementById('hosting-edit-price').value),
          hostingCostPrice: parseFloat(document.getElementById('hosting-edit-cost').value) || 0,
          domainCost: parseFloat(document.getElementById('hosting-edit-domain').value) || 0,
          emailCostMonthly: parseFloat(document.getElementById('hosting-edit-email').value) || 0,
          hostingInterval: 'MONTHLY',
          hostingStartDate: document.getElementById('hosting-edit-start').value || null,
          hostingEndDate: document.getElementById('hosting-edit-end').value || null,
          nextInvoiceDate: document.getElementById('hosting-edit-invoice').value || null
        });
        closeHostingModal();
        showToast('Hosting bijgewerkt', 'success');
        loadHosting();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function markInvoiceSent(dealId) {
      try {
        const deal = await API.get('/deals/' + dealId);
        const currentInvoiceDate = new Date(deal.nextInvoiceDate);
        const nextInvoiceDate = new Date(currentInvoiceDate);
        
        // Hosting is always invoiced yearly
        nextInvoiceDate.setFullYear(nextInvoiceDate.getFullYear() + 1);
        
        await API.put('/deals/' + dealId + '/hosting', {
          hostingPrice: deal.hostingPrice,
          hostingInterval: deal.hostingInterval,
          hostingStartDate: deal.hostingStartDate,
          hostingEndDate: deal.hostingEndDate,
          nextInvoiceDate: nextInvoiceDate.toISOString().split('T')[0]
        });
        
        showToast('Factuur gemarkeerd als verstuurd', 'success');
        loadHosting();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function deleteHosting(dealId, companyName) {
      if (!confirm('Hosting verwijderen voor ' + companyName + '? De deal blijft bestaan maar hosting wordt uitgeschakeld.')) return;
      try {
        await API.delete('/deals/' + dealId + '/hosting');
        showToast('Hosting verwijderd voor ' + companyName, 'success');
        loadHosting();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    init();
  </script>
</body>
</html>
