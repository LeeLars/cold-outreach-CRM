<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="favicon.png">
  <title>Leads - Cold Outreach CRM</title>
  <link rel="stylesheet" href="assets/css/global.css">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <div class="app-layout">
    <aside class="sidebar" id="sidebar"></aside>
    <div class="main-content">
      <header class="topbar" id="topbar"></header>
      <main class="page-content">
        <div class="toolbar">
          <div class="toolbar-left">
            <div class="topbar-search">
              <i data-lucide="search"></i>
              <input type="text" placeholder="Zoek leads..." id="search-input">
            </div>
            <select class="form-select" id="page-size" style="width:120px;" onchange="currentLimit=parseInt(this.value);currentPage=1;loadLeads();">
              <option value="50">50 per pagina</option>
              <option value="100" selected>100 per pagina</option>
              <option value="200">200 per pagina</option>
              <option value="500">500 per pagina</option>
            </select>
            <select class="form-select" id="status-filter" style="width:180px;">
              <option value="">Alle statussen</option>
              <option value="NIEUW">Nieuw</option>
              <option value="VERSTUURD">Verstuurd</option>
              <option value="GEEN_REACTIE">Geen reactie</option>
              <option value="GEREAGEERD">Geen interesse</option>
              <option value="AFSPRAAK">Interesse</option>
              <option value="KLANT">Klant</option>
              <option value="NIET_GEINTERESSEERD">Niet geinteresseerd</option>
            </select>
          </div>
          <div class="toolbar-right">
            <button class="btn btn-secondary" onclick="openModal('import-modal')">
              <i data-lucide="upload"></i> CSV importeren
            </button>
          </div>
        </div>

        <div class="card">
          <div class="card-body" style="padding:0;">
            <table class="data-table" id="leads-table">
              <thead>
                <tr>
                  <th class="checkbox-cell"><input type="checkbox" id="select-all"></th>
                  <th>#</th>
                  <th>Bedrijfsnaam</th>
                  <th>Gemeente</th>
                  <th>Website</th>
                  <th>Status</th>
                  <th>Datum</th>
                  <th>Acties</th>
                </tr>
              </thead>
              <tbody id="leads-body"></tbody>
            </table>
          </div>
        </div>
        <div id="pagination"></div>
      </main>
    </div>
  </div>

  <!-- Floating action bar -->
  <div class="floating-bar" id="floating-bar">
    <span class="floating-bar-count" id="selected-count">0 leads geselecteerd</span>
    <select class="form-select" id="bulk-status" style="width:180px;">
      <option value="">Status wijzigen...</option>
      <option value="VERSTUURD">Verstuurd</option>
      <option value="GEEN_REACTIE">Geen reactie</option>
      <option value="GEREAGEERD">Gereageerd</option>
      <option value="AFSPRAAK">Afspraak geboekt</option>
      <option value="KLANT">Klant</option>
      <option value="NIET_GEINTERESSEERD">Niet geinteresseerd</option>
    </select>
    <button class="btn btn-primary btn-sm" onclick="applyBulkStatus()">Toepassen</button>
    <button class="btn btn-danger btn-sm" id="bulk-delete-btn" onclick="bulkDelete()">Verwijderen</button>
  </div>

  <!-- CSV Import Modal -->
  <div class="modal-overlay" id="import-modal">
    <div class="modal" style="max-width:600px;">
      <div class="modal-header">
        <span class="modal-title">CSV importeren</span>
        <button class="modal-close" onclick="closeModal('import-modal')"><i data-lucide="x"></i></button>
      </div>
      <div class="modal-body">
        <div class="upload-zone" id="upload-zone">
          <div class="upload-zone-icon"><i data-lucide="file-up" style="width:48px;height:48px;"></i></div>
          <div class="upload-zone-text">Sleep een CSV-bestand hierheen of <strong>klik om te uploaden</strong></div>
          <input type="file" id="csv-file" accept=".csv" style="display:none;">
        </div>
        <div id="import-preview" class="hidden mt-16"></div>
        <div class="progress-bar hidden mt-16" id="import-progress"><div class="progress-bar-fill" style="width:0%"></div></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('import-modal')">Annuleren</button>
        <button class="btn btn-primary hidden" id="confirm-import-btn" onclick="confirmImport()">Importeren</button>
      </div>
    </div>
  </div>

  <!-- Appointment Booking Modal -->
  <div class="modal-overlay" id="booking-modal">
    <div class="modal" style="max-width:480px;">
      <div class="modal-header">
        <span class="modal-title" id="booking-modal-title">Afspraak inplannen</span>
        <button class="modal-close" onclick="closeModal('booking-modal')"><i data-lucide="x"></i></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="booking-lead-id">
        <div class="form-group">
          <label class="form-label">Adres afspraak</label>
          <input type="text" class="form-input" id="booking-address" placeholder="Straat + nr, postcode gemeente" onchange="loadSlots()">
        </div>
        <div class="form-group">
          <label class="form-label">Datum</label>
          <input type="date" class="form-input" id="booking-date" onchange="loadSlots()">
        </div>
        <div class="form-group">
          <label class="form-label">Beschikbare tijden</label>
          <div id="booking-slots" style="display:flex;flex-wrap:wrap;gap:8px;">
            <span class="text-muted" style="font-size:13px;">Kies eerst een datum</span>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Titel (optioneel)</label>
          <input type="text" class="form-input" id="booking-title" placeholder="Afspraak - Bedrijfsnaam">
        </div>
        <div class="form-group">
          <label class="form-label">Notitie (optioneel)</label>
          <textarea class="form-input" id="booking-description" rows="2" placeholder="Extra info..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('booking-modal')">Annuleren</button>
        <button class="btn btn-primary" id="book-btn" onclick="bookAppointment()" disabled>Inplannen</button>
      </div>
    </div>
  </div>

  <!-- Lead Detail Slide-over -->
  <div class="slide-over-overlay" id="lead-detail-overlay" onclick="closeSlideOver('lead-detail')"></div>
  <div class="slide-over" id="lead-detail">
    <div class="slide-over-header">
      <span class="card-title" id="lead-detail-title">Lead details</span>
      <button class="modal-close" onclick="closeSlideOver('lead-detail')"><i data-lucide="x"></i></button>
    </div>
    <div class="slide-over-body" id="lead-detail-body"></div>
  </div>

  <script src="assets/js/config.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/components.js"></script>
  <script src="assets/js/sidebar.js"></script>
  <script>
    let currentPage = 1;
    let currentLimit = 100;
    let selectedIds = new Set();
    let csvFile = null;

    async function init() {
      if (!await requireLogin()) return;
      initSidebar();
      initTopbar('Leads');
      lucide.createIcons();
      setupEventListeners();
      loadLeads();
    }

    function setupEventListeners() {
      document.getElementById('search-input').addEventListener('input', debounce(() => { currentPage = 1; loadLeads(); }, 300));
      document.getElementById('status-filter').addEventListener('change', () => { currentPage = 1; loadLeads(); });
      document.getElementById('select-all').addEventListener('change', toggleSelectAll);

      const uploadZone = document.getElementById('upload-zone');
      const fileInput = document.getElementById('csv-file');

      uploadZone.addEventListener('click', () => fileInput.click());
      uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
      uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
      });
      fileInput.addEventListener('change', (e) => { if (e.target.files[0]) handleFile(e.target.files[0]); });

      if (!isAdmin()) {
        document.getElementById('bulk-delete-btn').classList.add('hidden');
      }
    }

    function showLoadingSkeleton() {
      const tbody = document.getElementById('leads-body');
      tbody.innerHTML = Array(8).fill('').map(() => `
        <tr>
          <td class="checkbox-cell"><div class="skeleton-cell sm"></div></td>
          <td><div class="skeleton-cell sm"></div></td>
          <td><div class="skeleton-cell lg"></div></td>
          <td><div class="skeleton-cell md"></div></td>
          <td><div class="skeleton-cell lg"></div></td>
          <td><div class="skeleton-cell badge"></div></td>
          <td><div class="skeleton-cell md"></div></td>
          <td><div class="skeleton-cell sm"></div></td>
        </tr>
      `).join('');
    }

    async function loadLeads() {
      showLoadingSkeleton();
      const search = document.getElementById('search-input').value;
      const status = document.getElementById('status-filter').value;
      const params = new URLSearchParams({ page: currentPage, limit: currentLimit });
      if (search) params.set('search', search);
      if (status) params.set('status', status);

      try {
        const data = await API.get(`/leads?${params}`);
        renderLeads(data);
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    function renderLeads(data) {
      const tbody = document.getElementById('leads-body');
      if (data.leads.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted" style="padding:40px;">Geen leads gevonden</td></tr>`;
        return;
      }

      tbody.innerHTML = data.leads.map((lead, i) => `
        <tr>
          <td class="checkbox-cell"><input type="checkbox" data-id="${lead.id}" class="lead-checkbox" ${selectedIds.has(lead.id) ? 'checked' : ''}></td>
          <td style="color:var(--text-muted);">${((data.page - 1) * currentLimit) + i + 1}</td>
          <td><a href="#" onclick="viewLead('${lead.id}');return false;" style="color:var(--text-primary);font-weight:500;">${lead.companyName}</a></td>
          <td>${lead.city || '-'}</td>
          <td>${lead.website ? `<a href="${lead.website}" target="_blank" style="color:var(--accent-blue);">${lead.website}</a>` : '-'}</td>
          <td>
            <select class="status-select ${lead.status}" data-id="${lead.id}" onchange="quickStatusChange(this)">
              ${Object.entries(STATUS_LABELS).map(([val, label]) =>
                `<option value="${val}" ${lead.status === val ? 'selected' : ''}>${label}</option>`
              ).join('')}
            </select>
          </td>
          <td style="color:var(--text-muted);">${formatDate(lead.createdAt)}</td>
          <td>
            <button class="btn-icon" onclick="viewLead('${lead.id}')" title="Bekijken">
              <i data-lucide="eye" style="width:16px;height:16px;"></i>
            </button>
          </td>
        </tr>
      `).join('');

      document.querySelectorAll('.lead-checkbox').forEach(cb => {
        cb.addEventListener('change', () => {
          if (cb.checked) selectedIds.add(cb.dataset.id);
          else selectedIds.delete(cb.dataset.id);
          updateFloatingBar();
        });
      });

      renderPagination(document.getElementById('pagination'), data, (page) => { currentPage = page; loadLeads(); });
      lucide.createIcons();
    }

    function toggleSelectAll(e) {
      const checkboxes = document.querySelectorAll('.lead-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = e.target.checked;
        if (e.target.checked) selectedIds.add(cb.dataset.id);
        else selectedIds.delete(cb.dataset.id);
      });
      updateFloatingBar();
    }

    function updateFloatingBar() {
      const bar = document.getElementById('floating-bar');
      const count = document.getElementById('selected-count');
      if (selectedIds.size > 0) {
        bar.classList.add('active');
        count.textContent = `${selectedIds.size} leads geselecteerd`;
      } else {
        bar.classList.remove('active');
      }
    }

    async function applyBulkStatus() {
      const status = document.getElementById('bulk-status').value;
      if (!status) return showToast('Selecteer een status', 'warning');
      if (selectedIds.size === 0) return;

      try {
        await API.post('/leads/bulk-status', { ids: Array.from(selectedIds), status });
        showToast(`${selectedIds.size} leads bijgewerkt`);
        selectedIds.clear();
        updateFloatingBar();
        document.getElementById('select-all').checked = false;
        loadLeads();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function bulkDelete() {
      if (!confirm(`Weet je zeker dat je ${selectedIds.size} leads wilt verwijderen?`)) return;
      try {
        await API.delete('/leads/bulk', { ids: Array.from(selectedIds) });
        showToast(`${selectedIds.size} leads verwijderd`);
        selectedIds.clear();
        updateFloatingBar();
        document.getElementById('select-all').checked = false;
        loadLeads();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function viewLead(id) {
      try {
        const lead = await API.get(`/leads/${id}`);
        const body = document.getElementById('lead-detail-body');
        document.getElementById('lead-detail-title').textContent = lead.companyName;

        body.innerHTML = `
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-select" id="lead-status" onchange="updateLeadStatus('${lead.id}', this.value)">
              ${Object.entries(STATUS_LABELS).map(([val, label]) =>
                `<option value="${val}" ${lead.status === val ? 'selected' : ''}>${label}</option>`
              ).join('')}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Bedrijfsnaam</label>
            <input type="text" class="form-input" id="lead-company" value="${lead.companyName}">
          </div>
          <div class="form-group">
            <label class="form-label">Contactpersoon</label>
            <input type="text" class="form-input" id="lead-contact" value="${lead.contactPerson || ''}" placeholder="Naam contactpersoon">
          </div>
          <div class="form-group">
            <label class="form-label">Telefoon</label>
            <input type="tel" class="form-input" id="lead-phone" value="${lead.phone || ''}" placeholder="+32 ...">
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="lead-email" value="${lead.email || ''}" placeholder="info@bedrijf.be">
          </div>
          <div class="form-group">
            <label class="form-label">Adres</label>
            <input type="text" class="form-input" id="lead-address" value="${lead.address || ''}" placeholder="Straat + nr, postcode gemeente">
          </div>
          <div class="form-group">
            <label class="form-label">Gemeente</label>
            <input type="text" class="form-input" id="lead-city" value="${lead.city || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">Website</label>
            <input type="text" class="form-input" id="lead-website" value="${lead.website || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">Notities</label>
            <textarea class="form-input" id="lead-notes" rows="4">${lead.notes || ''}</textarea>
          </div>
          <div class="flex justify-between items-center mt-16">
            <span class="text-muted" style="font-size:12px;">Aangemaakt: ${formatDateTime(lead.createdAt)}</span>
            <div style="display:flex;gap:8px;">
              <button class="btn btn-secondary btn-sm" onclick="openBookingModal('${lead.id}','${lead.companyName}')">
                <i data-lucide="calendar-plus" style="width:14px;height:14px;"></i> Afspraak
              </button>
              <button class="btn btn-primary btn-sm" onclick="saveLead('${lead.id}')">Opslaan</button>
            </div>
          </div>
          <div id="lead-appointments-${lead.id}" class="mt-16"></div>
          ${lead.deal ? `
            <hr style="border-color:var(--border-color);margin:20px 0;">
            <div style="font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:12px;">Deal informatie</div>
            <div class="flex justify-between items-center mb-16">
              <span class="text-muted">Pakket</span>
              <span style="font-weight:600;">${lead.deal.package.name}</span>
            </div>
            <div class="flex justify-between items-center mb-16">
              <span class="text-muted">Dealwaarde</span>
              <span style="font-weight:600;" class="text-green">${formatCurrency(lead.deal.totalValue)}</span>
            </div>
            <div class="flex justify-between items-center mb-16">
              <span class="text-muted">Acquisitiekost</span>
              <span style="font-weight:600;">${formatCurrency(lead.deal.acquisitionCost)}</span>
            </div>
          ` : ''}
        `;

        openSlideOver('lead-detail');
        lucide.createIcons();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function updateLeadStatus(id, status) {
      try {
        await API.put(`/leads/${id}/status`, { status });
        showToast('Status bijgewerkt');
        loadLeads();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function saveLead(id) {
      try {
        await API.put(`/leads/${id}`, {
          companyName: document.getElementById('lead-company').value,
          contactPerson: document.getElementById('lead-contact').value,
          phone: document.getElementById('lead-phone').value,
          email: document.getElementById('lead-email').value,
          address: document.getElementById('lead-address').value,
          city: document.getElementById('lead-city').value,
          website: document.getElementById('lead-website').value,
          notes: document.getElementById('lead-notes').value,
          status: document.getElementById('lead-status').value
        });
        showToast('Lead opgeslagen');
        closeSlideOver('lead-detail');
        loadLeads();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function handleFile(file) {
      csvFile = file;
      const formData = new FormData();
      formData.append('file', file);

      try {
        const preview = await API.upload('/leads/import/preview', formData);
        const previewEl = document.getElementById('import-preview');
        previewEl.classList.remove('hidden');
        document.getElementById('confirm-import-btn').classList.remove('hidden');

        previewEl.innerHTML = `
          <div style="font-size:13px;font-weight:600;margin-bottom:8px;">${preview.total} leads gevonden</div>
          <div style="max-height:300px;overflow-y:auto;">
            <table class="data-table">
              <thead><tr><th>Bedrijfsnaam</th><th>Gemeente</th><th>Website</th></tr></thead>
              <tbody>
                ${preview.records.map(r => `
                  <tr><td>${r.companyName}</td><td>${r.city || '-'}</td><td>${r.website || '-'}</td></tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          ${preview.total > 20 ? `<div class="text-muted mt-16" style="font-size:12px;">Toont eerste 20 van ${preview.total} records</div>` : ''}
        `;
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function confirmImport() {
      if (!csvFile) return;
      const formData = new FormData();
      formData.append('file', csvFile);

      const progressBar = document.getElementById('import-progress');
      progressBar.classList.remove('hidden');
      progressBar.querySelector('.progress-bar-fill').style.width = '50%';

      try {
        const result = await API.upload('/leads/import', formData);
        progressBar.querySelector('.progress-bar-fill').style.width = '100%';
        showToast(result.message);
        setTimeout(() => {
          closeModal('import-modal');
          resetImport();
          loadLeads();
        }, 500);
      } catch (err) {
        showToast(err.message, 'error');
        progressBar.classList.add('hidden');
      }
    }

    function resetImport() {
      csvFile = null;
      document.getElementById('csv-file').value = '';
      document.getElementById('import-preview').innerHTML = '';
      document.getElementById('import-preview').classList.add('hidden');
      document.getElementById('confirm-import-btn').classList.add('hidden');
      document.getElementById('import-progress').classList.add('hidden');
      document.getElementById('import-progress').querySelector('.progress-bar-fill').style.width = '0%';
    }

    async function quickStatusChange(select) {
      const id = select.dataset.id;
      const status = select.value;
      try {
        await API.put(`/leads/${id}/status`, { status });
        select.className = `status-select ${status}`;
        showToast('Status bijgewerkt');
        if (status === 'AFSPRAAK') {
          const row = select.closest('tr');
          const companyName = row ? row.querySelector('td:nth-child(3) a')?.textContent : '';
          openBookingModal(id, companyName);
        } else if (status === 'KLANT') {
          const row = select.closest('tr');
          const companyName = row ? row.querySelector('td:nth-child(3) a')?.textContent : '';
          if (confirm(`${companyName} is nu klant! Wil je direct een deal aanmaken?`)) {
            window.location.href = basePath('/deals.html') + '?newDeal=' + id;
          }
        }
      } catch (err) {
        showToast(err.message, 'error');
        loadLeads();
      }
    }

    let selectedSlot = null;

    async function openBookingModal(leadId, companyName) {
      selectedSlot = null;
      document.getElementById('booking-lead-id').value = leadId;
      document.getElementById('booking-modal-title').textContent = `Afspraak - ${companyName}`;
      document.getElementById('booking-title').value = `Afspraak - ${companyName}`;
      document.getElementById('booking-description').value = '';
      document.getElementById('booking-date').value = '';
      document.getElementById('booking-slots').innerHTML = '<span class="text-muted" style="font-size:13px;">Kies eerst een datum</span>';
      document.getElementById('book-btn').disabled = true;

      try {
        const lead = await API.get(`/leads/${leadId}`);
        document.getElementById('booking-address').value = lead.address || '';
      } catch (e) {
        document.getElementById('booking-address').value = '';
      }

      const travelInfo = document.getElementById('booking-travel');
      if (travelInfo) travelInfo.remove();

      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('booking-date').min = tomorrow.toISOString().split('T')[0];

      closeSlideOver('lead-detail');
      openModal('booking-modal');
      lucide.createIcons();
      loadLeadAppointments(leadId);
    }

    async function loadSlots() {
      const date = document.getElementById('booking-date').value;
      const leadId = document.getElementById('booking-lead-id').value;
      const address = document.getElementById('booking-address').value.trim();
      if (!date) return;

      const slotsDiv = document.getElementById('booking-slots');
      slotsDiv.innerHTML = '<div class="skeleton-cell xl" style="height:32px;"></div>';
      selectedSlot = null;
      document.getElementById('book-btn').disabled = true;

      const travelInfo = document.getElementById('booking-travel');
      if (travelInfo) travelInfo.remove();

      try {
        let url = `/calendar/slots?date=${date}&leadId=${leadId}`;
        if (address) url += `&address=${encodeURIComponent(address)}`;
        const data = await API.get(url);

        if (data.travel) {
          const travelDiv = document.createElement('div');
          travelDiv.id = 'booking-travel';
          travelDiv.style.cssText = 'background:var(--accent-blue-dim);border-radius:8px;padding:10px 14px;margin-bottom:12px;font-size:12px;';
          travelDiv.innerHTML = `
            <div style="font-weight:600;color:var(--accent-blue);margin-bottom:4px;">Reistijd inbegrepen</div>
            <div style="color:var(--text-secondary);">${data.travel.origin} -> ${data.travel.destination}: ${data.travel.durationText} (${data.travel.distanceText})</div>
            <div style="color:var(--text-muted);margin-top:2px;">Slots inclusief heen/terugreis + 15 min buffer</div>
          `;
          slotsDiv.parentNode.insertBefore(travelDiv, slotsDiv);
        }

        if (data.slots.length === 0) {
          slotsDiv.innerHTML = '<span class="text-muted" style="font-size:13px;">Geen beschikbare tijden op deze dag</span>';
          return;
        }

        slotsDiv.innerHTML = data.slots.map(slot => `
          <button type="button" class="slot-btn" data-start="${slot.start}" data-end="${slot.end}" onclick="selectSlot(this)">
            ${slot.label}${slot.departureTime ? `<span style="display:block;font-size:10px;color:var(--text-muted);font-weight:400;">vertrek ${slot.departureTime}</span>` : ''}
          </button>
        `).join('');
      } catch (err) {
        slotsDiv.innerHTML = `<span class="text-muted" style="font-size:13px;">${err.message}</span>`;
      }
    }

    function selectSlot(btn) {
      document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      selectedSlot = { start: btn.dataset.start, end: btn.dataset.end };
      document.getElementById('book-btn').disabled = false;
    }

    async function bookAppointment() {
      if (!selectedSlot) return showToast('Selecteer een tijdslot', 'warning');

      const leadId = document.getElementById('booking-lead-id').value;
      const title = document.getElementById('booking-title').value;
      const description = document.getElementById('booking-description').value;
      const location = document.getElementById('booking-address').value.trim();

      if (location) {
        try { await API.put(`/leads/${leadId}`, { address: location }); } catch(e) {}
      }

      try {
        await API.post('/calendar/book', {
          leadId,
          startTime: selectedSlot.start,
          endTime: selectedSlot.end,
          title,
          description,
          location
        });
        showToast('Afspraak ingepland');
        closeModal('booking-modal');
        loadLeads();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function loadLeadAppointments(leadId) {
      try {
        const appointments = await API.get(`/calendar/appointments?leadId=${leadId}`);
        const container = document.getElementById(`lead-appointments-${leadId}`);
        if (!container || appointments.length === 0) return;

        container.innerHTML = `
          <hr style="border-color:var(--border-color);margin:20px 0;">
          <div style="font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:12px;">Afspraken</div>
          ${appointments.map(a => `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border-color);">
              <div>
                <div style="font-size:13px;font-weight:500;">${formatDateTime(a.startTime)}</div>
                <div style="font-size:11px;color:var(--text-muted);">${a.title}</div>
              </div>
              <button class="btn-icon" onclick="deleteAppointment('${a.id}')" title="Verwijderen" style="color:var(--accent-red);">
                <i data-lucide="trash-2" style="width:14px;height:14px;"></i>
              </button>
            </div>
          `).join('')}
        `;
        lucide.createIcons();
      } catch (err) {}
    }

    async function deleteAppointment(id) {
      if (!confirm('Afspraak verwijderen?')) return;
      try {
        await API.delete(`/calendar/appointments/${id}`);
        showToast('Afspraak verwijderd');
        loadLeads();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    function debounce(fn, ms) {
      let timer;
      return (...args) => { clearTimeout(timer); timer = setTimeout(() => fn(...args), ms); };
    }

    init();
  </script>
</body>
</html>
