<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="favicon.png">
  <title>Instellingen - Cold Outreach CRM</title>
  <link rel="stylesheet" href="assets/css/global.css">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <div class="app-layout">
    <aside class="sidebar" id="sidebar"></aside>
    <div class="main-content">
      <header class="topbar" id="topbar"></header>
      <main class="page-content">
        <div class="tabs">
          <button class="tab active" data-tab="account" onclick="switchTab('account')">Account</button>
          <button class="tab" data-tab="calendar" onclick="switchTab('calendar')">Google Calendar</button>
          <button class="tab" data-tab="general" id="general-tab" onclick="switchTab('general')">Algemeen</button>
        </div>

        <!-- Account Tab -->
        <div id="tab-account">
          <div class="card" style="max-width:560px;">
            <div class="card-header"><span class="card-title">Accountgegevens</span></div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label">Naam</label>
                <input type="text" class="form-input" id="account-name">
              </div>
              <div class="form-group">
                <label class="form-label">E-mail</label>
                <input type="email" class="form-input" id="account-email">
              </div>
              <div style="margin-top:16px;">
                <button class="btn btn-primary" onclick="saveAccount()">Opslaan</button>
              </div>
            </div>
          </div>

          <div class="card mt-16" style="max-width:560px;">
            <div class="card-header"><span class="card-title">Wachtwoord wijzigen</span></div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label">Huidig wachtwoord</label>
                <input type="password" class="form-input" id="current-password">
              </div>
              <div class="form-group">
                <label class="form-label">Nieuw wachtwoord</label>
                <input type="password" class="form-input" id="new-password">
              </div>
              <div class="form-group">
                <label class="form-label">Bevestig nieuw wachtwoord</label>
                <input type="password" class="form-input" id="confirm-password">
              </div>
              <div style="margin-top:16px;">
                <button class="btn btn-primary" onclick="changePassword()">Wachtwoord wijzigen</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Calendar Tab -->
        <div id="tab-calendar" class="hidden">
          <div class="card" style="max-width:560px;">
            <div class="card-header"><span class="card-title">Google Calendar</span></div>
            <div class="card-body" id="calendar-status">
              <div style="display:flex;align-items:center;gap:12px;">
                <div class="skeleton-cell xl" style="height:20px;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- General Tab (Admin) -->
        <div id="tab-general" class="hidden">
          <div class="card" style="max-width:560px;">
            <div class="card-header"><span class="card-title">Applicatie-informatie</span></div>
            <div class="card-body">
              <div style="display:flex;flex-direction:column;gap:12px;">
                <div class="flex justify-between items-center">
                  <span class="text-muted">Applicatie</span>
                  <span style="font-weight:600;">Cold Outreach CRM</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-muted">Versie</span>
                  <span>1.0.0</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-muted">Database</span>
                  <span style="color:var(--accent-green);">Verbonden (Railway PostgreSQL)</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="assets/js/config.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/components.js"></script>
  <script src="assets/js/sidebar.js"></script>
  <script>
    async function init() {
      if (!await requireLogin()) return;
      initSidebar();
      initTopbar('Instellingen');
      lucide.createIcons();

      document.getElementById('account-name').value = currentUser.name;
      document.getElementById('account-email').value = currentUser.email;

      if (!isAdmin()) {
        document.getElementById('general-tab').classList.add('hidden');
      }

      loadCalendarStatus();

      const params = new URLSearchParams(window.location.search);
      if (params.get('calendar') === 'connected') {
        history.replaceState(null, '', basePath('/settings.html'));
        showToast('Google Calendar gekoppeld');
        switchTab('calendar');
      }
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      document.getElementById('tab-account').classList.toggle('hidden', tab !== 'account');
      document.getElementById('tab-calendar').classList.toggle('hidden', tab !== 'calendar');
      document.getElementById('tab-general').classList.toggle('hidden', tab !== 'general');
    }

    async function loadCalendarStatus() {
      try {
        const data = await API.get('/calendar/status');
        const container = document.getElementById('calendar-status');

        if (data.connected) {
          container.innerHTML = `
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
              <div style="width:10px;height:10px;border-radius:50%;background:var(--accent-green);"></div>
              <span style="font-weight:600;color:var(--accent-green);">Gekoppeld</span>
            </div>
            <div class="flex justify-between items-center" style="margin-bottom:12px;">
              <span class="text-muted">Calendar ID</span>
              <span style="font-size:13px;">${data.calendarId}</span>
            </div>
            <div class="flex justify-between items-center" style="margin-bottom:12px;">
              <span class="text-muted">Beschikbaarheid</span>
              <span style="font-size:13px;">Ma-Za 09:00-17:00 (30 min slots)</span>
            </div>
            <div style="margin-top:16px;">
              <button class="btn btn-danger btn-sm" onclick="disconnectCalendar()">Ontkoppelen</button>
            </div>
          `;
        } else {
          container.innerHTML = `
            <div style="text-align:center;padding:20px 0;">
              <div style="font-size:14px;color:var(--text-secondary);margin-bottom:16px;">Koppel je Google Calendar om automatisch beschikbare tijdslots te tonen bij het inplannen van afspraken.</div>
              <button class="btn btn-primary" onclick="connectCalendar()">
                <i data-lucide="calendar" style="width:16px;height:16px;"></i> Google Calendar koppelen
              </button>
            </div>
          `;
          lucide.createIcons();
        }
      } catch (err) {
        document.getElementById('calendar-status').innerHTML = '<span class="text-muted">Fout bij laden status</span>';
      }
    }

    async function connectCalendar() {
      try {
        const data = await API.get('/calendar/connect');
        window.location.href = data.url;
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function disconnectCalendar() {
      if (!confirm('Weet je zeker dat je Google Calendar wilt ontkoppelen?')) return;
      try {
        await API.delete('/calendar/disconnect');
        showToast('Google Calendar ontkoppeld');
        loadCalendarStatus();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function saveAccount() {
      const name = document.getElementById('account-name').value;
      const email = document.getElementById('account-email').value;

      if (!name || !email) return showToast('Vul alle velden in', 'warning');

      try {
        const updated = await API.put('/users/account/update', { name, email });
        currentUser.name = updated.name;
        currentUser.email = updated.email;
        showToast('Account bijgewerkt');
        initSidebar();
        lucide.createIcons();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function changePassword() {
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      if (!currentPassword || !newPassword) return showToast('Vul alle velden in', 'warning');
      if (newPassword !== confirmPassword) return showToast('Wachtwoorden komen niet overeen', 'error');
      if (newPassword.length < 6) return showToast('Wachtwoord moet minimaal 6 tekens zijn', 'warning');

      try {
        await API.put('/users/account/update', { currentPassword, newPassword });
        showToast('Wachtwoord gewijzigd');
        document.getElementById('current-password').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-password').value = '';
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    init();
  </script>
</body>
</html>
