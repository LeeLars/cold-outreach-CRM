<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="icon" type="image/png" href="favicon.png">
  <title>Statistieken - Cold Outreach CRM</title>
  <link rel="stylesheet" href="assets/css/global.css">
  <script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="app-layout">
    <aside class="sidebar" id="sidebar"></aside>
    <div class="main-content">
      <header class="topbar" id="topbar"></header>
      <main class="page-content">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
          <div class="tabs" style="margin-bottom:0;">
            <button class="tab active" data-tab="funnel" onclick="switchTab('funnel')">Funnel analyse</button>
            <button class="tab" data-tab="revenue" onclick="switchTab('revenue')">Omzet & Acquisitie</button>
            <button class="tab" data-tab="locations" onclick="switchTab('locations')">Locaties</button>
            <button class="tab" data-tab="hosting" onclick="switchTab('hosting')">Hosting</button>
          </div>
          <div style="display:flex;align-items:center;gap:8px;">
            <label style="font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;">Boekjaar</label>
            <select id="year-selector" class="form-select" style="width:120px;" onchange="changeYear()"></select>
          </div>
        </div>

        <!-- Funnel Tab -->
        <div id="tab-funnel">
          <div class="section-header">
            <div class="section-header-icon lead-theme"><i data-lucide="users" style="width:18px;height:18px;"></i></div>
            <span class="section-header-title lead-theme">Cold & Flyer Pipeline Analyse</span>
          </div>
          <div class="kpi-grid" style="grid-template-columns:repeat(4,1fr);" id="funnel-kpis"></div>
          <div class="card mb-24" style="border-top:2px solid #60a5fa;">
            <div class="card-header"><span class="card-title" style="color:#60a5fa;">Pipeline per status</span></div>
            <div class="card-body"><canvas id="funnel-bar-chart" height="300"></canvas></div>
          </div>
          <div class="card" style="border-top:2px solid #60a5fa;">
            <div class="card-header"><span class="card-title" style="color:#60a5fa;">Conversieratio per stap</span></div>
            <div class="card-body" id="conversion-steps"></div>
          </div>
        </div>

        <!-- Revenue & Acquisition Tab -->
        <div id="tab-revenue" class="hidden">
          <div class="section-header">
            <div class="section-header-icon client-theme"><i data-lucide="trending-up" style="width:18px;height:18px;"></i></div>
            <span class="section-header-title client-theme">Omzet & Acquisitie</span>
          </div>

          <!-- Main KPIs -->
          <div class="kpi-grid" style="grid-template-columns:repeat(5,1fr);" id="revenue-kpis"></div>

          <!-- Omzet breakdown card - HIDDEN -->
          <div class="card mb-24" style="border-top:2px solid #34d399;display:none;">
            <div class="card-header"><span class="card-title" style="color:#34d399;">Omzet opbouw</span></div>
            <div class="card-body" id="revenue-breakdown-card"></div>
          </div>

          <!-- Charts row 1: monthly stacked + composition doughnut -->
          <div class="grid-2 mb-24">
            <div class="card" style="border-top:2px solid #34d399;">
              <div class="card-header"><span class="card-title" style="color:#34d399;">Omzet per maand (opbouw)</span></div>
              <div class="card-body"><canvas id="monthly-revenue-chart" height="300"></canvas></div>
            </div>
            <div class="card" style="border-top:2px solid #34d399;">
              <div class="card-header"><span class="card-title" style="color:#34d399;">Omzet samenstelling</span></div>
              <div class="card-body"><canvas id="revenue-composition-chart" height="300"></canvas></div>
            </div>
          </div>

          <!-- Package performance -->
          <div class="card mb-24" style="border-top:2px solid #3B82F6;">
            <div class="card-header"><span class="card-title" style="color:#3B82F6;">Pakket performance</span></div>
            <div class="card-body" style="padding:0;">
              <table class="data-table" style="font-size:13px;">
                <thead><tr><th>Pakket</th><th style="text-align:center;">Verkocht</th><th style="text-align:right;">Eenmalig</th><th style="text-align:right;">Hosting/jaar</th><th style="text-align:right;">Totaal</th><th style="text-align:right;">Gem. per deal</th></tr></thead>
                <tbody id="package-perf-body"></tbody>
              </table>
            </div>
          </div>

          <!-- Upsell performance -->
          <div class="card mb-24" style="border-top:2px solid #A78BFA;" id="upsell-perf-card">
            <div class="card-header"><span class="card-title" style="color:#A78BFA;">Upsell performance</span></div>
            <div class="card-body" style="padding:0;">
              <table class="data-table" style="font-size:13px;">
                <thead><tr><th>Upsell</th><th>Type</th><th style="text-align:center;">Verkocht</th><th style="text-align:right;">Prijs</th><th style="text-align:right;">Totale omzet</th></tr></thead>
                <tbody id="upsell-perf-body"></tbody>
              </table>
            </div>
          </div>

          <!-- Channel comparison -->
          <div class="section-header" style="margin-top:24px;">
            <span class="section-header-title" style="font-size:14px;color:var(--text-secondary);">Per kanaal</span>
          </div>
          <div class="kpi-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:24px;" id="revenue-channel-kpis"></div>

          <!-- Per client detail table -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">Omzet per klant (detail)</span>
              <div style="display:flex;gap:8px;">
                <button class="btn btn-primary btn-sm" id="acq-filter-all" onclick="switchAcquisitionFilter('all')" style="font-size:12px;">Alle</button>
                <button class="btn btn-secondary btn-sm" id="acq-filter-flyer" onclick="switchAcquisitionFilter('flyer')" style="font-size:12px;">Flyer</button>
                <button class="btn btn-secondary btn-sm" id="acq-filter-warm" onclick="switchAcquisitionFilter('warm')" style="font-size:12px;">Warm</button>
              </div>
            </div>
            <div class="card-body" style="padding:0;">
              <div style="overflow-x:auto;">
                <table class="data-table" style="font-size:12px;">
                  <thead><tr>
                    <th>Bedrijf</th><th>Pakket</th><th>Kanaal</th>
                    <th style="text-align:right;">Eenmalig</th><th style="text-align:right;">Upsells</th>
                    <th style="text-align:right;">Korting</th><th style="text-align:right;">Hosting/jr</th>
                    <th style="text-align:right;font-weight:700;">Totaal</th><th style="text-align:right;">Kost</th>
                    <th style="text-align:right;">Winst</th><th>Datum</th>
                  </tr></thead>
                  <tbody id="acquisition-body"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Locations Tab -->
        <div id="tab-locations" class="hidden">
          <div style="display:flex;gap:8px;margin-bottom:20px;">
            <button class="btn btn-primary btn-sm" id="loc-filter-all" onclick="switchLocationFilter('all')" style="font-size:12px;">Alle leads</button>
            <button class="btn btn-secondary btn-sm" id="loc-filter-flyer" onclick="switchLocationFilter('flyer')" style="font-size:12px;">Flyer acquisitie</button>
            <button class="btn btn-secondary btn-sm" id="loc-filter-warm" onclick="switchLocationFilter('warm')" style="font-size:12px;">Warme leads</button>
          </div>

          <div class="kpi-grid" style="grid-template-columns:repeat(5,1fr);" id="location-kpis"></div>

          <div class="card mb-24">
            <div class="card-header">
              <span class="card-title">Top 15 gemeentes - Leads & Performance</span>
              <div style="display:flex;gap:8px;">
                <select id="location-metric-filter" class="form-select" style="width:200px;" onchange="updateLocationChart()">
                  <option value="total">Totaal leads</option>
                  <option value="verstuurd">Verstuurd</option>
                  <option value="gereageerd">Gereageerd</option>
                  <option value="klanten">Klanten</option>
                  <option value="revenue">Omzet</option>
                </select>
              </div>
            </div>
            <div class="card-body">
              <canvas id="location-bar-chart" height="350"></canvas>
            </div>
          </div>

          <div class="grid-2 mb-24">
            <div class="card">
              <div class="card-header"><span class="card-title">Response rate per gemeente</span></div>
              <div class="card-body">
                <canvas id="location-response-chart" height="300"></canvas>
              </div>
            </div>
            <div class="card">
              <div class="card-header"><span class="card-title">Conversion rate per gemeente</span></div>
              <div class="card-body">
                <canvas id="location-conversion-chart" height="300"></canvas>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <span class="card-title">Gedetailleerd overzicht per gemeente</span>
              <input type="text" id="location-search" class="form-input" placeholder="Zoek gemeente..." style="width:250px;" oninput="filterLocationTable()">
            </div>
            <div class="card-body" style="padding:0;">
              <div style="max-height:600px;overflow-y:auto;">
                <table class="data-table" style="font-size:13px;">
                  <thead style="position:sticky;top:0;background:var(--bg-card);z-index:10;">
                    <tr>
                      <th style="cursor:pointer;" onclick="sortLocationTable('city')">
                        Gemeente <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                      </th>
                      <th style="text-align:right;cursor:pointer;" onclick="sortLocationTable('total')">
                        Totaal <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                      </th>
                      <th style="text-align:right;cursor:pointer;" onclick="sortLocationTable('verstuurd')">
                        Verstuurd <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                      </th>
                      <th style="text-align:right;cursor:pointer;" onclick="sortLocationTable('gereageerd')">
                        Gereageerd <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                      </th>
                      <th style="text-align:right;cursor:pointer;" onclick="sortLocationTable('responseRate')">
                        Response % <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                      </th>
                      <th style="text-align:right;cursor:pointer;" onclick="sortLocationTable('klanten')">
                        Klanten <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                      </th>
                      <th style="text-align:right;cursor:pointer;" onclick="sortLocationTable('conversionRate')">
                        Conversion % <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                      </th>
                      <th style="text-align:right;cursor:pointer;" onclick="sortLocationTable('revenue')">
                        Omzet <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                      </th>
                    </tr>
                  </thead>
                  <tbody id="location-table-body"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Hosting Tab -->
        <div id="tab-hosting" class="hidden">
          <div class="kpi-grid" style="grid-template-columns:repeat(4,1fr);" id="hosting-kpis"></div>

          <div id="hosting-alerts" style="margin-bottom:20px;"></div>

          <div class="card">
            <div class="card-header">
              <span class="card-title">Hosting klanten overzicht</span>
              <input type="text" id="hosting-search" class="form-input" placeholder="Zoek klant..." style="width:250px;" oninput="filterHostingTable()">
            </div>
            <div class="card-body" style="padding:0;">
              <div style="max-height:600px;overflow-y:auto;">
                <table class="data-table" style="font-size:13px;">
                  <thead style="position:sticky;top:0;background:var(--bg-card);z-index:10;">
                    <tr>
                      <th style="cursor:pointer;" onclick="sortHostingTable('companyName')">
                        Bedrijf <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                      </th>
                      <th>Gemeente</th>
                      <th>Pakket</th>
                      <th style="text-align:right;cursor:pointer;" onclick="sortHostingTable('hostingPrice')">
                        Prijs/mnd <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                      </th>
                      <th>Per jaar</th>
                      <th style="cursor:pointer;" onclick="sortHostingTable('hostingStartDate')">
                        Startdatum <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                      </th>
                      <th style="cursor:pointer;" onclick="sortHostingTable('hostingEndDate')">
                        Einddatum <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                      </th>
                      <th style="cursor:pointer;" onclick="sortHostingTable('nextInvoiceDate')">
                        Volgende factuur <i data-lucide="arrow-up-down" style="width:12px;height:12px;"></i>
                      </th>
                      <th>Status</th>
                      <th style="text-align:center;">Acties</th>
                    </tr>
                  </thead>
                  <tbody id="hosting-table-body"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Hosting Edit Modal -->
  <div class="modal-overlay" id="hosting-edit-modal" onclick="if(event.target===this)closeHostingModal()">
    <div class="modal" style="max-width:500px;">
      <div class="modal-header">
        <h3 class="modal-title">Hosting bewerken</h3>
        <button class="btn-icon" onclick="closeHostingModal()"><i data-lucide="x"></i></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="hosting-edit-id">
        <div class="form-group">
          <label class="form-label">Bedrijf</label>
          <input type="text" id="hosting-edit-company" class="form-input" disabled>
        </div>
        <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="form-group">
            <label class="form-label">Hosting prijs per maand</label>
            <select id="hosting-edit-price" class="form-select">
              <option value="15">€15/mnd (€180/jaar)</option>
              <option value="20">€20/mnd (€240/jaar)</option>
            </select>
            <input type="hidden" id="hosting-edit-interval" value="MONTHLY">
          </div>
          <div class="form-group">
            <label class="form-label">Gefactureerd per</label>
            <input type="text" class="form-input" value="Jaar" disabled style="background:var(--bg-secondary);color:var(--text-muted);cursor:not-allowed;">
          </div>
        </div>
        <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="form-group">
            <label class="form-label">Startdatum</label>
            <input type="date" id="hosting-edit-start" class="form-input">
          </div>
          <div class="form-group">
            <label class="form-label">Einddatum</label>
            <input type="date" id="hosting-edit-end" class="form-input">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Volgende factuurdatum</label>
          <input type="date" id="hosting-edit-invoice" class="form-input">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeHostingModal()">Annuleren</button>
        <button class="btn btn-primary" onclick="saveHosting()">Opslaan</button>
      </div>
    </div>
  </div>

  <script src="assets/js/config.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/components.js"></script>
  <script src="assets/js/sidebar.js"></script>
  <script>
    let charts = {};

    let locationDataAll = {};
    let locationData = [];
    let locationFilter = 'all';
    let locationSortColumn = 'total';
    let locationSortDirection = 'desc';

    let acquisitionDataAll = null;
    let revenueDataAll = null;
    let acquisitionFilter = 'all';

    let hostingData = [];
    let hostingSortColumn = 'nextInvoiceDate';
    let hostingSortDirection = 'asc';

    let selectedYear = new Date().getFullYear();
    const loadedTabs = new Set();
    
    async function init() {
      if (!await requireLogin()) return;
      initSidebar();
      initTopbar('Statistieken');
      populateYearSelector();
      loadTabData('funnel');
    }

    function populateYearSelector() {
      const now = new Date().getFullYear();
      const startYear = 2025;
      const sel = document.getElementById('year-selector');
      sel.innerHTML = '';
      for (let y = now + 1; y >= startYear; y--) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        if (y === selectedYear) opt.selected = true;
        sel.appendChild(opt);
      }
    }

    function changeYear() {
      const newYear = parseInt(document.getElementById('year-selector').value);
      if (newYear === selectedYear) return;
      selectedYear = newYear;
      // Reset all loaded tabs so they reload with new year
      loadedTabs.clear();
      // Find active tab and reload it
      const activeTab = document.querySelector('.tab.active');
      const tab = activeTab ? activeTab.dataset.tab : 'funnel';
      loadTabData(tab);
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      ['funnel', 'revenue', 'locations', 'hosting'].forEach(t => {
        document.getElementById(`tab-${t}`).classList.toggle('hidden', tab !== t);
      });
      loadTabData(tab);
    }
    
    function loadTabData(tab) {
      if (loadedTabs.has(tab)) return;
      loadedTabs.add(tab);
      switch(tab) {
        case 'funnel': loadFunnel(); break;
        case 'revenue': loadRevenue(); loadAcquisition(); break;
        case 'locations': loadLocations(); break;
        case 'hosting': loadHosting(); break;
      }
    }

    async function loadFunnel() {
      try {
        const data = await API.get('/stats/funnel');

        const cur = {};
        data.funnel.forEach(f => cur[f.status] = f.count);

        document.getElementById('funnel-kpis').innerHTML = `
          <div class="kpi-card lead-theme">
            <div class="kpi-label">Verstuurd ratio</div>
            <div class="kpi-value" style="color:#60a5fa;">${data.conversions.sendRate}%</div>
            <span class="kpi-badge neutral">${cur.VERSTUURD + cur.GEEN_REACTIE} nu verstuurd</span>
          </div>
          <div class="kpi-card lead-theme">
            <div class="kpi-label">Reactie ratio</div>
            <div class="kpi-value" style="color:#fb923c;">${data.conversions.responseRate}%</div>
            <span class="kpi-badge positive">${cur.GEREAGEERD + cur.NIET_GEINTERESSEERD} gereageerd</span>
          </div>
          <div class="kpi-card lead-theme">
            <div class="kpi-label">Interesse ratio</div>
            <div class="kpi-value" style="color:#a78bfa;">${data.conversions.interestRate}%</div>
            <span class="kpi-badge positive">${cur.AFSPRAAK} interesse</span>
          </div>
          <div class="kpi-card client-theme">
            <div class="kpi-label">Close ratio</div>
            <div class="kpi-value" style="color:#34d399;">${data.conversions.closeRate}%</div>
            <span class="kpi-badge positive">${cur.KLANT} klanten</span>
          </div>
        `;

        const ctx = document.getElementById('funnel-bar-chart').getContext('2d');
        if (charts.funnel) charts.funnel.destroy();
        const colors = ['rgba(107,114,128,0.8)', 'rgba(96,165,250,0.8)', 'rgba(251,146,60,0.8)', 'rgba(34,211,238,0.8)', 'rgba(167,139,250,0.8)', 'rgba(59,130,246,0.8)', 'rgba(248,113,113,0.8)'];
        const borderColors = ['#6B7280', '#60A5FA', '#FB923C', '#22D3EE', '#A78BFA', '#3B82F6', '#F87171'];
        charts.funnel = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.funnel.map(f => STATUS_LABELS[f.status] || f.status),
            datasets: [{ data: data.funnel.map(f => f.count), backgroundColor: colors, borderColor: borderColors, borderWidth: 1, borderRadius: 8, borderSkipped: false, barThickness: 32 }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { backgroundColor: '#111111', borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1, titleColor: '#f0f0f0', bodyColor: '#a0a0a0', cornerRadius: 8, padding: 12 } },
            scales: {
              x: { grid: { display: false }, ticks: { color: '#666', font: { size: 11 } } },
              y: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { color: '#666' } }
            }
          }
        });

        const steps = [
          { from: 'Totaal', to: 'Verstuurd', rate: data.conversions.sendRate },
          { from: 'Verstuurd', to: 'Gereageerd', rate: data.conversions.responseRate },
          { from: 'Gereageerd', to: 'Interesse', rate: data.conversions.interestRate },
          { from: 'Interesse', to: 'Klant', rate: data.conversions.closeRate }
        ];

        document.getElementById('conversion-steps').innerHTML = `
          <div style="display:flex;flex-direction:column;gap:12px;">
            ${steps.map(s => `
              <div style="display:flex;align-items:center;gap:16px;">
                <span style="width:100px;font-size:13px;color:var(--text-secondary);">${s.from}</span>
                <div class="progress-bar" style="flex:1;"><div class="progress-bar-fill" style="width:${s.rate}%;"></div></div>
                <span style="width:60px;font-size:13px;font-weight:600;text-align:right;">${s.rate}%</span>
                <span style="width:100px;font-size:13px;color:var(--text-secondary);">${s.to}</span>
              </div>
            `).join('')}
          </div>
        `;
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function loadRevenue() {
      try {
        const data = await API.get('/stats/revenue?year=' + selectedYear);
        revenueDataAll = data;

        const b = data.breakdown;
        const yr = data.currentYear || new Date().getFullYear();
        const eenmaligNetto = b.eenmalig + b.upsellOneTime - b.discount;
        const totalPackageNetto = b.totalPackageNetto || eenmaligNetto;
        const hostingCY = b.hostingCurrentYear || 0;
        const upsellCY = b.upsellCurrentYear || 0;
        const totalCurrentYear = eenmaligNetto + hostingCY + upsellCY;
        const hostingPct = totalCurrentYear > 0 ? ((hostingCY / totalCurrentYear) * 100).toFixed(0) : 0;
        const packagePct = data.totalRevenue > 0 ? ((totalPackageNetto / data.totalRevenue) * 100).toFixed(0) : 0;
        const totalMRR = b.actualMRR + b.upsellMRR;

        // KPIs
        document.getElementById('revenue-kpis').innerHTML = `
          <div class="kpi-card client-theme">
            <div class="kpi-label">Omzet ${yr}</div>
            <div class="kpi-value" style="color:#34d399;">${formatCurrency(totalCurrentYear)}</div>
            <span class="kpi-badge positive">${data.totalClients} deal${data.totalClients !== 1 ? 's' : ''}</span>
          </div>
          <div class="kpi-card" style="border-left-color:#3B82F6;">
            <div class="kpi-label">Pakket omzet</div>
            <div class="kpi-value" style="color:#3B82F6;">${formatCurrency(totalPackageNetto)}</div>
            <span class="kpi-badge neutral">${packagePct}% van totale omzet</span>
          </div>
          <div class="kpi-card" style="border-left-color:#A78BFA;">
            <div class="kpi-label">Hosting ${yr}</div>
            <div class="kpi-value" style="color:#A78BFA;">${formatCurrency(hostingCY)}</div>
            <span class="kpi-badge neutral">${hostingPct}% van totaal</span>
          </div>
          <div class="kpi-card" style="border-left-color:#34d399;">
            <div class="kpi-label">MRR (terugkerend)</div>
            <div class="kpi-value" style="color:#34d399;">${formatCurrency(totalMRR)}</div>
            <span class="kpi-badge neutral">${formatCurrency(totalMRR * 12)}/jaar</span>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Gem. dealwaarde</div>
            <div class="kpi-value">${formatCurrency(data.avgDeal)}</div>
            <span class="kpi-badge neutral">Per klant</span>
          </div>
        `;

        // Breakdown bar
        const breakdownItems = [
          { label: 'Pakketten (eenmalig)', value: b.eenmalig, color: '#3B82F6' },
          { label: 'Upsells (eenmalig)', value: b.upsellOneTime, color: '#8B5CF6' },
          { label: `Upsells ${yr} (maandelijks)`, value: upsellCY, color: '#A78BFA' },
          { label: `Hosting ${yr}`, value: hostingCY, color: '#34d399' },
          { label: 'Korting', value: -b.discount, color: '#f87171' }
        ].filter(i => i.value !== 0);

        document.getElementById('revenue-breakdown-card').innerHTML = `
          <div style="display:flex;gap:4px;height:32px;border-radius:8px;overflow:hidden;margin-bottom:16px;">
            ${breakdownItems.filter(i => i.value > 0).map(i => {
              const pct = (i.value / (data.totalRevenue + b.discount)) * 100;
              return `<div style="background:${i.color};width:${pct}%;min-width:2px;" title="${i.label}: ${formatCurrency(i.value)}"></div>`;
            }).join('')}
          </div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;">
            ${breakdownItems.map(i => `
              <div style="display:flex;align-items:center;gap:10px;">
                <div style="width:10px;height:10px;border-radius:50%;background:${i.color};flex-shrink:0;"></div>
                <div>
                  <div style="font-size:12px;color:var(--text-muted);">${i.label}</div>
                  <div style="font-size:14px;font-weight:600;color:${i.value < 0 ? '#f87171' : 'var(--text-primary)'};">${formatCurrency(Math.abs(i.value))}</div>
                </div>
              </div>
            `).join('')}
            <div style="display:flex;align-items:center;gap:10px;border-left:2px solid var(--border-color);padding-left:12px;">
              <div>
                <div style="font-size:12px;color:var(--text-muted);">Netto totaal</div>
                <div style="font-size:16px;font-weight:700;color:#34d399;">${formatCurrency(data.totalRevenue)}</div>
              </div>
            </div>
          </div>
        `;

        // Stacked monthly chart
        const ctx1 = document.getElementById('monthly-revenue-chart').getContext('2d');
        if (charts.monthly) charts.monthly.destroy();
        const months = data.monthlyBreakdown.map(m => m.month);
        charts.monthly = new Chart(ctx1, {
          type: 'bar',
          data: {
            labels: months,
            datasets: [
              { label: 'Pakketten', data: data.monthlyBreakdown.map(m => m.eenmalig), backgroundColor: 'rgba(59,130,246,0.7)', borderRadius: 4, stack: 'stack' },
              { label: 'Upsells', data: data.monthlyBreakdown.map(m => m.upsells), backgroundColor: 'rgba(167,139,250,0.7)', borderRadius: 4, stack: 'stack' },
              { label: 'Hosting', data: data.monthlyBreakdown.map(m => m.hosting), backgroundColor: 'rgba(52,211,153,0.7)', borderRadius: 4, stack: 'stack' }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
              legend: { position: 'top', labels: { color: '#a0a0a0', padding: 12, font: { size: 11 }, boxWidth: 10 } },
              tooltip: { backgroundColor: '#111', borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1, titleColor: '#f0f0f0', bodyColor: '#a0a0a0', cornerRadius: 8, padding: 12,
                callbacks: { label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}` }
              }
            },
            scales: {
              x: { stacked: true, grid: { display: false }, ticks: { color: '#666', font: { size: 11 } } },
              y: { stacked: true, grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { color: '#666', callback: v => formatCurrency(v) } }
            }
          }
        });

        // Composition doughnut
        const ctx2 = document.getElementById('revenue-composition-chart').getContext('2d');
        if (charts.pkg) charts.pkg.destroy();
        const compData = [
          { label: 'Pakketten', value: b.eenmalig - b.discount, color: 'rgba(59,130,246,0.8)', border: '#3B82F6' },
          { label: 'Upsells', value: b.upsellOneTime + upsellCY, color: 'rgba(167,139,250,0.8)', border: '#A78BFA' },
          { label: `Hosting ${yr}`, value: hostingCY, color: 'rgba(52,211,153,0.8)', border: '#34d399' }
        ].filter(c => c.value > 0);
        charts.pkg = new Chart(ctx2, {
          type: 'doughnut',
          data: {
            labels: compData.map(c => c.label),
            datasets: [{ data: compData.map(c => c.value), backgroundColor: compData.map(c => c.color), borderColor: compData.map(c => c.border), borderWidth: 1, hoverOffset: 8 }]
          },
          options: {
            responsive: true, maintainAspectRatio: false, cutout: '65%',
            plugins: {
              legend: { position: 'bottom', labels: { color: '#a0a0a0', padding: 16, font: { size: 12 }, boxWidth: 12 } },
              tooltip: { backgroundColor: '#111', borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1, titleColor: '#f0f0f0', bodyColor: '#a0a0a0', cornerRadius: 8, padding: 12,
                callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.raw)} (${data.totalRevenue > 0 ? ((ctx.raw / data.totalRevenue) * 100).toFixed(0) : 0}%)` }
              }
            }
          }
        });

        // Package performance table
        document.getElementById('package-perf-body').innerHTML = data.packageBreakdown.map(p => `
          <tr>
            <td style="font-weight:600;">${p.name}</td>
            <td style="text-align:center;">${p.count}x</td>
            <td style="text-align:right;">${formatCurrency(p.eenmalig)}</td>
            <td style="text-align:right;">${formatCurrency(p.hosting)}</td>
            <td style="text-align:right;font-weight:600;color:var(--accent-brand);">${formatCurrency(p.total)}</td>
            <td style="text-align:right;">${formatCurrency(p.count > 0 ? p.total / p.count : 0)}</td>
          </tr>
        `).join('') || '<tr><td colspan="6" class="text-center text-muted" style="padding:20px;">Geen pakketten verkocht</td></tr>';

        // Upsell performance table
        const upsellCard = document.getElementById('upsell-perf-card');
        if (data.upsellBreakdown.length === 0) {
          upsellCard.style.display = 'none';
        } else {
          upsellCard.style.display = '';
          document.getElementById('upsell-perf-body').innerHTML = data.upsellBreakdown.map(u => `
            <tr>
              <td style="font-weight:500;">${u.name}</td>
              <td><span style="background:${u.type === 'MONTHLY' ? 'var(--accent-purple-dim)' : 'var(--accent-blue-dim)'};color:${u.type === 'MONTHLY' ? 'var(--accent-purple)' : 'var(--accent-blue)'};padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;">${u.type === 'MONTHLY' ? 'Maandelijks' : 'Eenmalig'}</span></td>
              <td style="text-align:center;">${u.count}x</td>
              <td style="text-align:right;">${formatCurrency(u.price)}${u.type === 'MONTHLY' ? '/mnd' : ''}</td>
              <td style="text-align:right;font-weight:600;color:var(--accent-brand);">${formatCurrency(u.revenue)}</td>
            </tr>
          `).join('');
        }

        // Channel KPIs
        document.getElementById('revenue-channel-kpis').innerHTML = `
          <div class="kpi-card" style="border-left-color:#fb923c;">
            <div class="kpi-label">Flyer acquisitie</div>
            <div class="kpi-value text-green">${formatCurrency(data.flyer.revenue)}</div>
            <span class="kpi-badge neutral">${data.flyer.count} klant${data.flyer.count !== 1 ? 'en' : ''} | Kost: ${formatCurrency(data.flyer.cost)} | ROI: ${data.flyer.roi}%</span>
          </div>
          <div class="kpi-card" style="border-left-color:#60a5fa;">
            <div class="kpi-label">Warme leads</div>
            <div class="kpi-value text-green">${formatCurrency(data.warm.revenue)}</div>
            <span class="kpi-badge neutral">${data.warm.count} klant${data.warm.count !== 1 ? 'en' : ''} | Kost: ${formatCurrency(data.warm.cost)} | ROI: ${data.warm.roi}%</span>
          </div>
          <div class="kpi-card" style="border-left-color:#a78bfa;">
            <div class="kpi-label">Beste kanaal</div>
            <div class="kpi-value" style="font-size:18px;">${parseFloat(data.flyer.roi) >= parseFloat(data.warm.roi) && data.flyer.count > 0 ? 'Flyer' : data.warm.count > 0 ? 'Warm' : '-'}</div>
            <span class="kpi-badge positive">Hoogste ROI</span>
          </div>
        `;

        // Render per-client table
        renderAcquisitionView();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function loadAcquisition() {
      // No longer needed separately - data comes from loadRevenue
    }

    function switchAcquisitionFilter(filter) {
      acquisitionFilter = filter;
      ['all', 'flyer', 'warm'].forEach(f => {
        const btn = document.getElementById('acq-filter-' + f);
        btn.className = f === filter ? 'btn btn-primary btn-sm' : 'btn btn-secondary btn-sm';
      });
      renderAcquisitionView();
    }

    function renderAcquisitionView() {
      const data = revenueDataAll;
      if (!data || !data.perDeal) return;

      const filtered = acquisitionFilter === 'all' ? data.perDeal
        : acquisitionFilter === 'flyer' ? data.perDeal.filter(c => c.acquisitionType === 'flyer')
        : data.perDeal.filter(c => c.acquisitionType !== 'flyer');

      const tbody = document.getElementById('acquisition-body');
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted" style="padding:40px;">Geen klanten gevonden</td></tr>';
        return;
      }

      const channelLabels = { flyer: 'Flyer', none: 'Warm', manual: 'Warm' };
      const channelColors = { flyer: 'var(--accent-orange)', none: 'var(--accent-blue)', manual: 'var(--accent-blue)' };

      tbody.innerHTML = filtered.map(c => {
        const upsellTotal = c.upsellOneTime + c.upsellMonthlyYearly;
        const profit = c.totalValue - c.acquisitionCost;
        return `
          <tr>
            <td style="font-weight:500;">${c.companyName}</td>
            <td style="font-size:11px;">${c.packageName}</td>
            <td><span style="background:${channelColors[c.acquisitionType] || 'var(--text-muted)'}20;color:${channelColors[c.acquisitionType] || 'var(--text-muted)'};padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;">${channelLabels[c.acquisitionType] || c.acquisitionType}</span></td>
            <td style="text-align:right;">${formatCurrency(c.pkgOneTime)}</td>
            <td style="text-align:right;">${upsellTotal > 0 ? formatCurrency(upsellTotal) : '<span class="text-muted">-</span>'}</td>
            <td style="text-align:right;">${c.discount > 0 ? `<span style="color:var(--accent-green);">-${formatCurrency(c.discount)}</span>` : '<span class="text-muted">-</span>'}</td>
            <td style="text-align:right;">${c.hostingYearly > 0 ? formatCurrency(c.hostingYearly) : '<span class="text-muted">-</span>'}</td>
            <td style="text-align:right;font-weight:700;color:var(--accent-brand);">${formatCurrency(c.totalValue)}</td>
            <td style="text-align:right;">${c.acquisitionCost > 0 ? `<span style="color:#f87171;">${formatCurrency(c.acquisitionCost)}</span>` : '<span class="text-muted">-</span>'}</td>
            <td style="text-align:right;font-weight:600;color:${profit >= 0 ? '#34d399' : '#f87171'};">${formatCurrency(profit)}</td>
            <td style="color:var(--text-muted);font-size:11px;">${formatDate(c.saleDate)}</td>
          </tr>
        `;
      }).join('');
    }

    async function loadLocations() {
      try {
        const data = await API.get('/stats/locations');
        locationDataAll = data;
        locationData = data[locationFilter] || data.all;
        renderLocationsView();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    function switchLocationFilter(filter) {
      locationFilter = filter;
      locationData = locationDataAll[filter] || locationDataAll.all;
      ['all', 'flyer', 'warm'].forEach(f => {
        const btn = document.getElementById('loc-filter-' + f);
        btn.className = f === filter ? 'btn btn-primary btn-sm' : 'btn btn-secondary btn-sm';
      });
      renderLocationsView();
    }

    function renderLocationsView() {
      const data = locationData;
      const filterLabels = { all: 'Alle leads', flyer: 'Flyer acquisitie', warm: 'Warme leads' };
      const filterLabel = filterLabels[locationFilter];

      const totalLocations = data.length;
      const totalLeads = data.reduce((sum, loc) => sum + loc.total, 0);
      const totalVerstuurd = data.reduce((sum, loc) => sum + loc.verstuurd, 0);
      const totalGereageerd = data.reduce((sum, loc) => sum + loc.gereageerd, 0);
      const totalKlanten = data.reduce((sum, loc) => sum + loc.klanten, 0);
      const totalRevenue = data.reduce((sum, loc) => sum + loc.revenue, 0);

      document.getElementById('location-kpis').innerHTML = `
        <div class="kpi-card">
          <div class="kpi-label">Gemeentes</div>
          <div class="kpi-value">${totalLocations}</div>
          <span class="kpi-badge neutral">${filterLabel}</span>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Totaal leads</div>
          <div class="kpi-value">${totalLeads}</div>
          <span class="kpi-badge neutral">${filterLabel}</span>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Gem. response rate</div>
          <div class="kpi-value">${totalVerstuurd > 0 ? ((totalGereageerd / totalVerstuurd) * 100).toFixed(1) : 0}%</div>
          <span class="kpi-badge positive">${filterLabel}</span>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Totaal klanten</div>
          <div class="kpi-value">${totalKlanten}</div>
          <span class="kpi-badge positive">${filterLabel}</span>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Totale omzet</div>
          <div class="kpi-value text-green">${formatCurrency(totalRevenue)}</div>
          <span class="kpi-badge positive">${filterLabel}</span>
        </div>
      `;

      updateLocationChart();
      renderLocationResponseChart(data);
      renderLocationConversionChart(data);
      renderLocationTable(data);
      refreshIcons();
    }

    function updateLocationChart() {
      const metric = document.getElementById('location-metric-filter').value;
      const top15 = [...locationData].sort((a, b) => b[metric] - a[metric]).slice(0, 15);

      const ctx = document.getElementById('location-bar-chart').getContext('2d');
      if (charts.locationBar) charts.locationBar.destroy();

      const labels = top15.map(l => l.city);
      const values = top15.map(l => metric === 'revenue' ? l[metric] : l[metric]);
      
      const metricLabels = {
        total: 'Totaal leads',
        verstuurd: 'Verstuurd',
        gereageerd: 'Gereageerd',
        klanten: 'Klanten',
        revenue: 'Omzet'
      };

      const colors = {
        total: '#6B7280',
        verstuurd: '#60A5FA',
        gereageerd: '#FB923C',
        klanten: '#22C55E',
        revenue: '#3B82F6'
      };

      charts.locationBar = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: metricLabels[metric],
            data: values,
            backgroundColor: colors[metric] + '99',
            borderColor: colors[metric],
            borderWidth: 1,
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { backgroundColor: '#111111', borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1, titleColor: '#f0f0f0', bodyColor: '#a0a0a0', cornerRadius: 8, padding: 12 }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: '#666', font: { size: 11 } }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
              ticks: {
                color: '#666',
                callback: v => metric === 'revenue' ? formatCurrency(v) : v
              }
            }
          }
        }
      });
    }

    function renderLocationResponseChart(data) {
      const top10 = [...data]
        .filter(l => l.verstuurd > 0)
        .sort((a, b) => parseFloat(b.responseRate) - parseFloat(a.responseRate))
        .slice(0, 10);

      const ctx = document.getElementById('location-response-chart').getContext('2d');
      if (charts.locationResponse) charts.locationResponse.destroy();

      charts.locationResponse = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: top10.map(l => l.city),
          datasets: [{
            label: 'Response rate %',
            data: top10.map(l => parseFloat(l.responseRate)),
            backgroundColor: 'rgba(251, 146, 60, 0.6)',
            borderColor: '#FB923C',
            borderWidth: 1,
            borderRadius: 8,
            barThickness: 22
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { backgroundColor: '#111111', borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1, titleColor: '#f0f0f0', bodyColor: '#fb923c', cornerRadius: 8, padding: 12 } },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
              ticks: { color: '#666', callback: v => v + '%' },
              max: 100
            },
            y: {
              grid: { display: false },
              ticks: { color: '#a0a0a0', font: { size: 11, weight: 500 } }
            }
          }
        }
      });
    }

    function renderLocationConversionChart(data) {
      const top10 = [...data]
        .filter(l => l.gereageerd > 0)
        .sort((a, b) => parseFloat(b.conversionRate) - parseFloat(a.conversionRate))
        .slice(0, 10);

      const ctx = document.getElementById('location-conversion-chart').getContext('2d');
      if (charts.locationConversion) charts.locationConversion.destroy();

      charts.locationConversion = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: top10.map(l => l.city),
          datasets: [{
            label: 'Conversion rate %',
            data: top10.map(l => parseFloat(l.conversionRate)),
            backgroundColor: 'rgba(52, 211, 153, 0.6)',
            borderColor: '#34d399',
            borderWidth: 1,
            borderRadius: 8,
            barThickness: 22
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { backgroundColor: '#111111', borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1, titleColor: '#f0f0f0', bodyColor: '#34d399', cornerRadius: 8, padding: 12 } },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
              ticks: { color: '#666', callback: v => v + '%' },
              max: 100
            },
            y: {
              grid: { display: false },
              ticks: { color: '#a0a0a0', font: { size: 11, weight: 500 } }
            }
          }
        }
      });
    }

    function renderLocationTable(data) {
      const tbody = document.getElementById('location-table-body');
      const sorted = sortLocationData(data);

      tbody.innerHTML = sorted.map(loc => `
        <tr>
          <td style="font-weight:600;">${loc.city}</td>
          <td style="text-align:right;">${loc.total}</td>
          <td style="text-align:right;">${loc.verstuurd}</td>
          <td style="text-align:right;">${loc.gereageerd}</td>
          <td style="text-align:right;">
            <span style="color:${parseFloat(loc.responseRate) > 50 ? 'var(--accent-green)' : parseFloat(loc.responseRate) > 25 ? 'var(--accent-orange)' : 'var(--text-muted)'};">
              ${loc.responseRate}%
            </span>
          </td>
          <td style="text-align:right;">${loc.klanten}</td>
          <td style="text-align:right;">
            <span style="color:${parseFloat(loc.conversionRate) > 50 ? 'var(--accent-green)' : parseFloat(loc.conversionRate) > 25 ? 'var(--accent-orange)' : 'var(--text-muted)'};">
              ${loc.conversionRate}%
            </span>
          </td>
          <td style="text-align:right;font-weight:600;color:var(--accent-green);">
            ${loc.revenue > 0 ? formatCurrency(loc.revenue) : '-'}
          </td>
        </tr>
      `).join('');
    }

    function sortLocationData(data) {
      return [...data].sort((a, b) => {
        let aVal = a[locationSortColumn];
        let bVal = b[locationSortColumn];

        if (locationSortColumn === 'responseRate' || locationSortColumn === 'conversionRate') {
          aVal = parseFloat(aVal);
          bVal = parseFloat(bVal);
        }

        if (locationSortDirection === 'asc') {
          return aVal > bVal ? 1 : -1;
        } else {
          return aVal < bVal ? 1 : -1;
        }
      });
    }

    function sortLocationTable(column) {
      if (locationSortColumn === column) {
        locationSortDirection = locationSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        locationSortColumn = column;
        locationSortDirection = 'desc';
      }
      renderLocationTable(locationData);
    }

    function filterLocationTable() {
      const search = document.getElementById('location-search').value.toLowerCase();
      const filtered = locationData.filter(loc => 
        loc.city.toLowerCase().includes(search)
      );
      renderLocationTable(filtered);
    }

    async function loadHosting() {
      try {
        const data = await API.get('/stats/hosting?year=' + selectedYear);
        hostingData = data.clients || [];

        const fmt = (v) => new Intl.NumberFormat('nl-BE', { style: 'currency', currency: 'EUR' }).format(v);

        const yr = data.currentYear || new Date().getFullYear();
        const qLabels = { Q1: 'jan-mrt', Q2: 'apr-jun', Q3: 'jul-sep', Q4: 'okt-dec' };
        const qt = data.quarterTotals || {};
        
        document.getElementById('hosting-kpis').innerHTML = `
          <div class="kpi-card">
            <div class="kpi-label">Hosting klanten</div>
            <div class="kpi-value">${data.totalClients}</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">MRR (hosting)</div>
            <div class="kpi-value">${fmt(data.totalMRR || 0)}</div>
          </div>
          <div class="kpi-card" style="border-left-color:#34d399;">
            <div class="kpi-label">Hosting omzet ${yr}</div>
            <div class="kpi-value" style="color:#34d399;">${fmt(data.totalCurrentYear || 0)}</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Gem. per klant/mnd</div>
            <div class="kpi-value">${fmt(data.avgPerClient)}</div>
          </div>
        `;

        // Hosting reminders only shown on hosting.html page
        document.getElementById('hosting-alerts').innerHTML = '';

        renderHostingTable(hostingData);
        refreshIcons();
      } catch (err) {
        console.error('Hosting stats error:', err);
      }
    }

    function renderHostingTable(data) {
      const fmt = (v) => new Intl.NumberFormat('nl-BE', { style: 'currency', currency: 'EUR' }).format(v);
      const fmtDate = (d) => d ? new Date(d).toLocaleDateString('nl-BE') : '-';

      const sorted = [...data].sort((a, b) => {
        let aVal = a[hostingSortColumn];
        let bVal = b[hostingSortColumn];

        if (hostingSortColumn.includes('Date')) {
          aVal = aVal ? new Date(aVal).getTime() : (hostingSortDirection === 'asc' ? Infinity : -Infinity);
          bVal = bVal ? new Date(bVal).getTime() : (hostingSortDirection === 'asc' ? Infinity : -Infinity);
        } else if (typeof aVal === 'string') {
          aVal = (aVal || '').toLowerCase();
          bVal = (bVal || '').toLowerCase();
        }

        return hostingSortDirection === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
      });

      const statusBadge = (status) => {
        const map = {
          active: { label: 'Actief', color: 'var(--accent-green)', bg: 'var(--accent-green-dim)' },
          overdue: { label: 'Te factureren', color: 'var(--accent-red)', bg: 'var(--accent-red-dim)' },
          expiring: { label: 'Verloopt binnenkort', color: 'var(--accent-orange)', bg: 'var(--accent-orange-dim)' },
          expired: { label: 'Verlopen', color: 'var(--accent-red)', bg: 'var(--accent-red-dim)' }
        };
        const s = map[status] || map.active;
        return `<span style="background:${s.bg};color:${s.color};padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;">${s.label}</span>`;
      };

      document.getElementById('hosting-table-body').innerHTML = sorted.map(c => `
        <tr style="cursor:pointer;" onclick="openHostingEdit('${c.id}')">
          <td style="font-weight:500;">${c.companyName}</td>
          <td>${c.city || '-'}</td>
          <td>${c.packageName}</td>
          <td style="text-align:right;font-weight:600;">${fmt(c.hostingPrice)}/mnd</td>
          <td>${fmt(c.hostingPrice * 12)}/jaar</td>
          <td>${fmtDate(c.hostingStartDate)}</td>
          <td>${fmtDate(c.hostingEndDate)}</td>
          <td style="${c.status === 'overdue' ? 'font-weight:600;color:var(--accent-red);' : ''}">${fmtDate(c.nextInvoiceDate)}</td>
          <td>${statusBadge(c.status)}</td>
          <td style="text-align:center;" onclick="event.stopPropagation()">
            <div style="display:flex;gap:4px;justify-content:center;">
              <button class="btn-icon" onclick="openHostingEdit('${c.id}')" title="Bewerken"><i data-lucide="pencil" style="width:14px;height:14px;"></i></button>
              <button class="btn-icon" onclick="deleteHosting('${c.id}','${c.companyName.replace(/'/g, "\\'")}')"
                title="Verwijderen" style="color:var(--accent-red);"><i data-lucide="trash-2" style="width:14px;height:14px;"></i></button>
            </div>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-muted);">Geen hosting klanten gevonden</td></tr>';
    }

    function sortHostingTable(column) {
      if (hostingSortColumn === column) {
        hostingSortDirection = hostingSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        hostingSortColumn = column;
        hostingSortDirection = column.includes('Date') ? 'asc' : 'desc';
      }
      renderHostingTable(hostingData);
    }

    function filterHostingTable() {
      const search = document.getElementById('hosting-search').value.toLowerCase();
      const filtered = hostingData.filter(c =>
        c.companyName.toLowerCase().includes(search) ||
        (c.city || '').toLowerCase().includes(search) ||
        (c.packageName || '').toLowerCase().includes(search)
      );
      renderHostingTable(filtered);
    }

    function openHostingEdit(dealId) {
      const item = hostingData.find(c => c.id === dealId);
      if (!item) return;
      document.getElementById('hosting-edit-id').value = item.id;
      document.getElementById('hosting-edit-company').value = item.companyName;
      const priceSelect = document.getElementById('hosting-edit-price');
      const priceVal = item.hostingPrice;
      if (priceVal == 15 || priceVal == 20) {
        priceSelect.value = priceVal;
      } else {
        const opt = document.createElement('option');
        opt.value = priceVal;
        opt.textContent = `€${priceVal}/mnd (€${priceVal * 12}/jaar)`;
        priceSelect.appendChild(opt);
        priceSelect.value = priceVal;
      }
      document.getElementById('hosting-edit-start').value = item.hostingStartDate ? item.hostingStartDate.slice(0, 10) : '';
      document.getElementById('hosting-edit-end').value = item.hostingEndDate ? item.hostingEndDate.slice(0, 10) : '';
      document.getElementById('hosting-edit-invoice').value = item.nextInvoiceDate ? item.nextInvoiceDate.slice(0, 10) : '';
      document.getElementById('hosting-edit-modal').classList.add('active');
      refreshIcons();
    }

    function closeHostingModal() {
      document.getElementById('hosting-edit-modal').classList.remove('active');
    }

    async function saveHosting() {
      const id = document.getElementById('hosting-edit-id').value;
      try {
        await API.put('/deals/' + id + '/hosting', {
          hostingPrice: parseFloat(document.getElementById('hosting-edit-price').value),
          hostingInterval: 'MONTHLY',
          hostingStartDate: document.getElementById('hosting-edit-start').value || null,
          hostingEndDate: document.getElementById('hosting-edit-end').value || null,
          nextInvoiceDate: document.getElementById('hosting-edit-invoice').value || null
        });
        closeHostingModal();
        showToast('Hosting bijgewerkt', 'success');
        loadHosting();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function deleteHosting(dealId, companyName) {
      if (!confirm('Hosting verwijderen voor ' + companyName + '? De deal blijft bestaan maar hosting wordt uitgeschakeld.')) return;
      try {
        await API.delete('/deals/' + dealId + '/hosting');
        showToast('Hosting verwijderd voor ' + companyName, 'success');
        loadHosting();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    init();
  </script>
</body>
</html>
